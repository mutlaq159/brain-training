<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ููุตุฉ ุงูุชุฏุฑูุจ ุงูุฐููู | ุณุฑูุน ูููุซูู</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Readex+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body style="margin:0;font-family:'Tajawal',sans-serif;background:#0A0F1C;color:#E8ECF1;min-height:100vh">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--ac:#00E5B8;--ac2:#6C5CE7;--gld:#FDCB6E;--dng:#FF7675;--dim:#6B7A90;--cb:rgba(26,35,64,0.7);--gb:rgba(255,255,255,0.07)}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(0,229,184,0.06),transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(108,92,231,0.06),transparent 50%);z-index:0;pointer-events:none}
#R{position:relative;z-index:1}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:3px}
.inp{width:100%;padding:13px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);border-radius:10px;color:#E8ECF1;font-family:'Tajawal';font-size:16px;outline:none;transition:all 0.3s}
.inp:focus{border-color:var(--ac);box-shadow:0 0 12px rgba(0,229,184,0.25)}
.inp[type=password]{letter-spacing:3px}
.btn{padding:14px 28px;background:linear-gradient(135deg,var(--ac),#00B894);border:none;border-radius:12px;color:#0A0F1C;font-family:'Tajawal';font-size:17px;font-weight:700;cursor:pointer;box-shadow:0 4px 20px rgba(0,229,184,0.25);transition:all 0.3s;width:100%}
.btn:hover{transform:translateY(-2px)}
.btn2{padding:8px 16px;background:rgba(108,92,231,0.15);color:var(--ac2);border:1px solid rgba(108,92,231,0.2);border-radius:8px;font-family:'Tajawal';font-size:12px;cursor:pointer;transition:all 0.3s}
.card{background:var(--cb);border:1px solid var(--gb);border-radius:20px;padding:26px;margin-bottom:20px}
.hdr{position:sticky;top:0;z-index:100;background:rgba(10,15,28,0.85);backdrop-filter:blur(30px);border-bottom:1px solid var(--gb);padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fadeIn 0.4s ease}
/* Keyboard trainer */
.kb-area{font-family:'Readex Pro',monospace;font-size:18px;line-height:2;direction:ltr;text-align:left;background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;min-height:80px;position:relative;letter-spacing:1px}
.kb-correct{color:var(--ac)} .kb-wrong{color:var(--dng);text-decoration:underline} .kb-cursor{color:var(--gld);border-bottom:2px solid var(--gld)} .kb-dim{color:rgba(255,255,255,0.25)}
.kb-input{position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:text}
.shortcut-key{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:6px;font-family:'Readex Pro';font-size:13px;font-weight:600;min-width:30px;justify-content:center}
.shortcut-plus{margin:0 4px;color:var(--dim);font-size:12px}
</style>
<div id="R"></div>
<script>
const $=id=>document.getElementById(id);
const R=()=>$('R');
const C={ac:'#00E5B8',ac2:'#6C5CE7',gld:'#FDCB6E',dng:'#FF7675',dim:'#6B7A90',cb:'rgba(26,35,64,0.7)',gb:'rgba(255,255,255,0.07)'};

// ============ FIREBASE INIT ============
const firebaseConfig = {
  apiKey: "AIzaSyBF4bf4bfSoQ1UYyyfoXfVVGWIJjZq8f8w",
  authDomain: "brain-training-45add.firebaseapp.com",
  projectId: "brain-training-45add",
  storageBucket: "brain-training-45add.firebasestorage.app",
  messagingSenderId: "1082619560355",
  appId: "1:1082619560355:web:1767334b81b5cd0ff35a16"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// ============ DATA LAYER (Firebase + localStorage cache) ============
// Local cache helpers
function gs(k){try{return JSON.parse(localStorage.getItem('bt4_'+k))}catch{return null}}
function ss(k,v){localStorage.setItem('bt4_'+k,JSON.stringify(v))}

// Firebase helpers
async function fbGet(collection,docId){
  try{
    const doc=await db.collection(collection).doc(docId).get();
    return doc.exists?doc.data():null;
  }catch(e){console.warn('FB read error:',e);return null;}
}
async function fbSet(collection,docId,data){
  try{await db.collection(collection).doc(docId).set(data,{merge:true});}
  catch(e){console.warn('FB write error:',e);}
}
async function fbDel(collection,docId){
  try{await db.collection(collection).doc(docId).delete();}
  catch(e){console.warn('FB delete error:',e);}
}

// Employee list โ Firebase-backed
async function getEmpsAsync(){
  const snap=await db.collection('employees').doc('list').get();
  if(snap.exists&&snap.data().emps){
    const emps=snap.data().emps;
    ss('emp_list',emps); // cache locally
    return emps;
  }
  // First time โ seed with defaults
  ss('emp_list',DEFAULT_EMPS);
  await fbSet('employees','list',{emps:DEFAULT_EMPS});
  return [...DEFAULT_EMPS];
}
function getEmps(){return gs('emp_list')||[...DEFAULT_EMPS]}
function getEmpList(){return getEmps()}
async function setEmps(list){
  ss('emp_list',list);
  await fbSet('employees','list',{emps:list});
}

// User data โ Firebase-backed
function loadU(email){
  let d=gs('u_'+email)||{email,level:1,streak:0,best:0,lastA:null,hist:[],todayEx:{},todayD:null,pass:'1234',firstTime:true,dialect:null,typingProgress:{ar:1,en:1},points:0,excusedDays:[],goldenHist:[],weekendMins:0};
  // Ensure new fields exist for old users
  if(d.points===undefined)d.points=0;
  if(!d.excusedDays)d.excusedDays=[];
  if(!d.goldenHist)d.goldenHist=[];
  if(d.weekendMins===undefined)d.weekendMins=0;
  
  if(d.todayD!==td()){
    const y=new Date(Date.now()-864e5).toDateString();
    const yesterdayPts=calcDailyPoints(d);
    if(yesterdayPts>0)d.points+=yesterdayPts;
    const penalty=calcMissedPenalty(d);
    if(penalty<0)d.points=Math.max(0,d.points+penalty);
    
    if(d.lastA===y){d.streak++;d.best=Math.max(d.best,d.streak)}else if(d.lastA!==td())d.streak=0;
    d.todayEx={};d.todayD=td();
  }return d;
}

async function loadUAsync(email){
  // Try Firebase first
  const fbData=await fbGet('users',email.replace(/[.@]/g,'_'));
  if(fbData){
    ss('u_'+email,fbData); // cache locally
  }
  return loadU(email);
}

function saveU(d){
  d.lastA=td();const t=d.hist.length;const a=t?d.hist.reduce((x,y)=>x+y.score,0)/t:0;
  d.level=t>=100&&a>=75?5:t>=60&&a>=65?4:t>=35&&a>=55?3:t>=15?2:1;
  ss('u_'+d.email,d);
  // Async save to Firebase (non-blocking)
  fbSet('users',d.email.replace(/[.@]/g,'_'),d);
}

const DEPTS=[{id:'hr',n:'ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ'},{id:'finance',n:'ุงููุญุงุณุจุฉ'},{id:'real_estate',n:'ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช'},{id:'operations',n:'ุงูุชุดุบูู'},{id:'collection',n:'ุงูุชุญุตูู'},{id:'admin',n:'ุงูุฅุฏุงุฑุฉ ุงูุนููุง'}];

const DEFAULT_EMPS=[
  {name:'ุฃุญูุฏ ุจูู',uid:'a.beh',email:'ahmed.beh@fast.sa',dept:'admin',role:'admin',sup:''},
  {name:'ูุทูู',uid:'mtlq',email:'mutlaq@fast.sa',dept:'admin',role:'gm',sup:''},
  {name:'ูุญูุฏ ูุฑุฌ',uid:'m.frg',email:'m.farag@fast.sa',dept:'hr',role:'manager',sup:'a.beh'},
  {name:'ุจูุงุก',uid:'bhaa',email:'bahaa@fast.sa',dept:'finance',role:'employee',sup:'mtlq'},
  {name:'ุถูุงุก',uid:'diaa',email:'diaa@fast.sa',dept:'finance',role:'employee',sup:'mtlq'},
  {name:'ุฃุญูุฏ ุฏููุฉ',uid:'a.dma',email:'a.doma@fast.sa',dept:'finance',role:'employee',sup:'mtlq'},
  {name:'ุฃุญูุฏ ุตุจุญู',uid:'a.sbh',email:'a.sobhy@fast.sa',dept:'finance',role:'employee',sup:'mtlq'},
  {name:'ุฑุฌุจ',uid:'ragb',email:'ragab@fast.sa',dept:'finance',role:'employee',sup:'mtlq'},
  {name:'ุฒูุงุฏ',uid:'ziad',email:'ziad@fast.sa',dept:'real_estate',role:'employee',sup:'mtlq'},
  {name:'ูุญูุฏ ุฃุฒูุฑู',uid:'m.azh',email:'m.azhari@fast.sa',dept:'operations',role:'employee',sup:'mtlq'},
  {name:'ุญุณู ุนุงุจุฏูู',uid:'h.abd',email:'h.abdeen@fast.sa',dept:'collection',role:'employee',sup:'mtlq'},
  {name:'ุณุงูุญ ุฃุจู ุณูุงุญ',uid:'smah',email:'sameh@fast.sa',dept:'operations',role:'employee',sup:'mtlq'},
];

const EXT=[
  {id:'memory',n:'ุชุทุงุจู ุงูุฐุงูุฑุฉ',ic:'๐งฉ',d:'ุฐุงูุฑุฉ ุจุตุฑูุฉ',cat:'memory',cl:'ุฐุงูุฑุฉ'},
  {id:'sequence',n:'ุชุณูุณู ุงูุฃุฑูุงู',ic:'๐ข',d:'ุชุฐูุฑ ูุฅุนุงุฏุฉ',cat:'memory',cl:'ุฐุงูุฑุฉ'},
  {id:'schulte',n:'ุฌุฏูู ุดููุชู',ic:'๐ฏ',d:'ุชุฑููุฒ ุจุตุฑู',cat:'focus',cl:'ุชุฑููุฒ'},
  {id:'stroop',n:'ุงุฎุชุจุงุฑ ุณุชุฑูุจ',ic:'๐',d:'ููุงููุฉ ุงูุชุดุชุช',cat:'focus',cl:'ุชุฑููุฒ'},
  {id:'math',n:'ุญุณุงุจ ุฐููู',ic:'โ',d:'ุณุฑุนุฉ ุงูุญุณุงุจ',cat:'speed',cl:'ุงุณุชุฌุงุจุฉ'},
  {id:'raven',n:'ุฃููุงุท ุฑููู',ic:'๐ท',d:'ุชูููุฑ ููุทูู',cat:'logic',cl:'ููุทู'},
  {id:'typing',n:'ุชุนููู ุงููุชุงุจุฉ',ic:'โจ๏ธ',d:'ุญุฑู ุจุญุฑู ููุงุญุชุฑุงู',cat:'speed',cl:'ุงุณุชุฌุงุจุฉ'},
  {id:'shortcuts',n:'ุงุฎุชุตุงุฑุงุช ุงูููุจูุฑุฏ',ic:'๐น',d:'ูููุฏูุฒ + Excel + ูุชุตูุญ',cat:'logic',cl:'ููุทู'},
];

const ROLES={employee:'ููุธู',manager:'ูุฏูุฑ ูุณู',hr:'ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ',admin:'ุงููุฏูุฑ ุงูุนุงู',gm:'ุงููุฏูุฑ ุงูุนุงู'};
const DL={sa:'๐ธ๐ฆ ุงูุณุนูุฏูุฉ',eg:'๐ช๐ฌ ุงููุตุฑูุฉ',ye:'๐พ๐ช ุงูููููุฉ',sd:'๐ธ๐ฉ ุงูุณูุฏุงููุฉ',ar:'๐ ุงููุตุญู'};

// ============ MOTIVATIONAL โ Deep Dialect + Gender ============
// g: gender from S.user.gender โ 'ุฐูุฑ' or 'ุฃูุซู'
function G(){return S.user.gender==='ุฃูุซู'?'f':'m';}

function getMotiv(first,dialect,streak,isFirst){
  const g=G(); // m or f
  if(isFirst){
    const fm={
      sa:{
        m:`ููุง ูุบูุง ${first}! ๐ ูุงููู ููุฑุช ุงูููุตุฉ ูุงูุบุงูู. ุฐุญูู ุจุชุจุฏุฃ ุฑุญูุฉ ุชูููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุจุชุดูู ุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`,
        f:`ููุง ูุบูุง ${first}! ๐ ูุงููู ููุฑุชู ุงูููุตุฉ. ุฐุญูู ุจุชุจุฏูู ุฑุญูุฉ ุชููููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุจุชุดูููู ุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`
      },
      eg:{
        m:`ุฃููุงู ูุณููุงู ูุง ${first}! ๐ ููุฑุช ุงูููุตุฉ ูุง ูุนูู. ุฏูููุชู ุญุชุจุฏุฃ ุฑุญูุฉ ุชุทููุฑ ูููุง ุฏูุงุบู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุญุชุญุณ ุจุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`,
        f:`ุฃููุงู ูุณููุงู ูุง ${first}! ๐ ููุฑุชู ุงูููุตุฉ ูุง ุณุชู. ุฏูููุชู ุญุชุจุฏุฃู ุฑุญูุฉ ุชุทููุฑู ูููุง ุฏูุงุบู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุญุชุญุณู ุจุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`
      },
      ye:{
        m:`ุญููุงู ุงููู ${first}! ๐ ููุฑุช ุงูููุตุฉ ูุง ุบุงูู. ุงูุญูู ุจุชุจุฏุฃ ุฑุญูุฉ ุชูููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ุงูููู ูุจุชูุงุญุธ ุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`,
        f:`ุญููุงู ุงููู ${first}! ๐ ููุฑุชู ุงูููุตุฉ ูุง ุบุงููุฉ. ุงูุญูู ุจุชุจุฏุฃู ุฑุญูุฉ ุชูููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ุงูููู ูุจุชูุงุญุธู ุงููุฑู ุจููุณู ุฅู ุดุงุก ุงููู.`
      },
      sd:{
        m:`ุณูุงู ูุง ุฒูู ${first}! ๐ ููุฑุช ุงูููุตุฉ. ูุณูุน ุจุชุจุฏุฃ ุฑุญูุฉ ุชูููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุฅู ุดุงุก ุงููู ุจุชููู ุงููุฑู ูุงุถุญ.`,
        f:`ุณูุงู ูุง ${first}! ๐ ููุฑุชู ุงูููุตุฉ ูุง ุณุชู. ูุณูุน ุจุชุจุฏุฃู ุฑุญูุฉ ุชูููู ูููุง ุนููู โ ุนุดุฑ ุฏูุงูู ูู ููู ูุฅู ุดุงุก ุงููู ุจุชููู ุงููุฑู ูุงุถุญ.`
      },
      ar:{
        m:`ูุฑุญุจุงู ${first}! ๐ ุฃููุงู ุจู ูู ุงูููุตุฉ. ุณุชุจุฏุฃ ุงูุขู ุฑุญูุฉ ุชุทููุฑ ุฐููู โ ุนุดุฑ ุฏูุงุฆู ููููุงู ุชุตูุน ูุงุฑูุงู ุญููููุงู ุจุฅุฐู ุงููู.`,
        f:`ูุฑุญุจุงู ${first}! ๐ ุฃููุงู ุจูู ูู ุงูููุตุฉ. ุณุชุจุฏุฃูู ุงูุขู ุฑุญูุฉ ุชุทููุฑ ุฐูููู โ ุนุดุฑ ุฏูุงุฆู ููููุงู ุชุตูุน ูุงุฑูุงู ุญููููุงู ุจุฅุฐู ุงููู.`
      },
    };
    return (fm[dialect]||fm.sa)[g]||fm.sa.m;
  }
  const day=new Date().getDate();
  const M={
    sa:{m:[
      `ููุง ${first}! ๐ช ุงูุชูุงุฑูู ุฐู ุงุณุชุซูุงุฑ ููู ุฃูุช ุดุฎุตูุงู ูุงูุบุงูู โ ุจุชููุนู ูู ุดุบูู ููููู ูุญูุงุชู ูููุง.\n\nูุง ุชุฎููู ุฃุญุฏ ูุดุงุฑูู ุงูุญู โ ุฃูุช ูุงูุฐูุจ ูุง ุชุญุชุงุฌ ุฃุญุฏ. ูุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงููุฌุชูุฏ ูุนุฏูููุง! ๐`,
      `ูุด ุฃุฎุจุงุฑู ${first}ุ ุงูุนูู ูุซู ุงูุนุถูุฉ โ ูุฑููู ูู ููู ูููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุจุชุญุณ ุงููุฑู ูู ุชุฑููุฒู ููุฑุงุฑุงุชู.\n\nุงูุญู ูุงุฒู ูุฌู ููู ุฃูุช. ุงููู ูุฏุงูู ููุตู! ๐ฅ`,
      `ูุง ููุง ${first}! ๐ ูู ููู ุชููู ุชูุงุฑููู = ููู ุงุณุชุซูุฑุช ูู ุฃุบูู ุดู ุนูุฏู: ุนููู.\n\nููููุน ุชุนุทู ุฃุญุฏ ุงูุญู ุฃู ุชุงุฎุฐ ูู ุฃุญุฏ โ ุฐู ุฑุญูุชู ุฃูุช ูุญุฏู ูุงูุทูุจ.`,
      `ูุด ุนูุฏูุง ${first}ุ ๐ช ููู ูุฏูุฏ ููุฑุตุฉ ูุฏูุฏุฉ ุชููู ุฃุญุณู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุจูุฑุฉ ุจูุตูุฑ ุณูู ุนููู. ุงูุฅุตุฑุงุฑ ูู ุงูุณุฑ ูุงูุบุงูู! โญ`,
      `ููุง ุจุงูุทูุจ ${first}! ๐ง ุนููู ูุณุชุงูู ุฃูุถู ุชุฏุฑูุจ. ูุง ุชุณุชุนุฌูุ ุฎุฐ ุฑุงุญุชู ูุฑููุฒ.\n\nุงููู ูุชูุฑู ูู ููู ุจููุงุญุธ ุงููุฑู ุฎูุงู ุฃุณุจูุนูู. ุฃูุช ูุงุดู ุตุญ! ๐ฏ`,
    ],f:[
      `ููุง ${first}! ๐ช ุงูุชูุงุฑูู ุฐู ุงุณุชุซูุงุฑ ููู ุฃูุชู ุดุฎุตูุงู ูุงูุบุงููุฉ โ ุจุชููุนู ูู ุดุบูู ููููู ูุญูุงุชู ูููุง.\n\nูุง ุชุฎูููู ุฃุญุฏ ูุดุงุฑูู ุงูุญู โ ุฃูุชู ูุง ุชุญุชุงุฌูู ุฃุญุฏ. ูุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงููุฌุชูุฏุฉ ุชุนุฏูููุง! ๐`,
      `ูุด ุฃุฎุจุงุฑู ${first}ุ ุงูุนูู ูุซู ุงูุนุถูุฉ โ ูุฑูููู ูู ููู ูููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุจุชุญุณูู ุงููุฑู ูู ุชุฑููุฒู ููุฑุงุฑุงุชู.\n\nุงูุญู ูุงุฒู ูุฌู ููู ุฃูุชู. ุงููู ุชุฏุงูู ุชูุตู! ๐ฅ`,
      `ูุง ููุง ${first}! ๐ ูู ููู ุชููููู ุชูุงุฑููู = ููู ุงุณุชุซูุฑุชู ูู ุฃุบูู ุดู ุนูุฏู: ุนููู.\n\nููููุน ุชุนุทูู ุฃุญุฏ ุงูุญู ุฃู ุชุงุฎุฐูู ูู ุฃุญุฏ โ ุฐู ุฑุญูุชู ุฃูุชู ูุญุฏู ูุงูุบุงููุฉ.`,
      `ูุด ุนูุฏูุง ${first}ุ ๐ช ููู ูุฏูุฏ ููุฑุตุฉ ูุฏูุฏุฉ ุชููููู ุฃุญุณู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุจูุฑุฉ ุจูุตูุฑ ุณูู ุนููู. ุงูุฅุตุฑุงุฑ ูู ุงูุณุฑ ูุงูุบุงููุฉ! โญ`,
      `ููุง ุจุงูุบุงููุฉ ${first}! ๐ง ุนููู ูุณุชุงูู ุฃูุถู ุชุฏุฑูุจ. ูุง ุชุณุชุนุฌูููุ ุฎุฐู ุฑุงุญุชู ูุฑููุฒู.\n\nุงููู ุชุชูุฑู ูู ููู ุจุชูุงุญุธ ุงููุฑู ุฎูุงู ุฃุณุจูุนูู. ุฃูุชู ูุงุดูุฉ ุตุญ! ๐ฏ`,
    ]},
    eg:{m:[
      `ุฅูู ุงูุฃุฎุจุงุฑ ูุง ${first}! ๐ช ุงูุชูุงุฑูู ุฏู ููู ุฅูุช ูุง ูุนูู โ ุญุชููุฏู ูู ุดุบูู ูุญูุงุชู ููููู ููู.\n\nุฃูุนูู ุชุฎูู ุญุฏ ูุดุงุฑูู ุงูุญู! ุฅูุช ุฑุงุฌู ูุจูุฑ ููุญุชุงุฌุด ุญุฏ. ุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงููุฌุชูุฏ ุจูุนุฏููุง! ๐`,
      `ุนุงูู ุฅูู ${first}ุ ุงููุฎ ุฒู ุงูุนุถูุฉ ุจุงูุธุจุท โ ูุฑููู ูู ููู ุญูุจูู ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุญุชูุงูู ูุฑู ูู ุชุฑููุฒู ููุฑุงุฑุงุชู.\n\nุงูุญู ูุงุฒู ููุฌู ููู ุฅูุช. ุงููู ุจูุณุชูุฑ ุจููุตู! ๐ฅ`,
      `ุฃููุงู ูุง ูุจูุฑ ${first}! ๐ ูู ููู ุจุชููู ููู ุชูุงุฑููู = ููู ุงุณุชุซูุฑุช ูู ุฃุบูู ุญุงุฌุฉ ุนูุฏู: ุฏูุงุบู.\n\nููููุน ุชุฏูู ุญุฏ ุงูุญู ุฃู ุชุงุฎุฏ ูู ุญุฏ โ ุงูุฑุญูุฉ ุฏู ุฑุญูุชู ุฅูุช ููุญุฏู.`,
      `ุตุจุงุญ/ูุณุงุก ุงููู ูุง ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชููู ุฃุญุณู ูู ุฅูุจุงุฑุญ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููุงุฑุฏุฉ ุจูุฑุฉ ุญูุจูู ุณูู ุนููู. ุงูุฅุตุฑุงุฑ ูู ุงูููุชุงุญ ูุง ูุนูู! โญ`,
      `ุฃููุงู ูุง ${first}! ๐ง ุฏูุงุบู ูุณุชุงูู ุฃุญุณู ุชุฏุฑูุจ. ูุชุณุชุนุฌูุดุ ุฎุฏ ููุชู ูุฑููุฒ.\n\nุงููู ุจูุชูุฑู ูู ููู ุญููุงุญุธ ุงููุฑู ูู ุฃุณุจูุนูู. ุฅูุช ูู ุงูุณูุฉ ุงูุตุญ! ๐ฏ`,
    ],f:[
      `ุฅูู ุงูุฃุฎุจุงุฑ ูุง ${first}! ๐ช ุงูุชูุงุฑูู ุฏู ูููู ุฅูุชู ูุง ุณุชู โ ุญุชููุฏู ูู ุดุบูู ูุญูุงุชู ููููู ููู.\n\nุฃูุนูู ุชุฎูู ุญุฏ ูุดุงุฑูู ุงูุญู! ุฅูุชู ูุด ูุญุชุงุฌุฉ ุญุฏ. ุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงููุฌุชูุฏุฉ ุจุชุนุฏููุง! ๐`,
      `ุนุงููุฉ ุฅูู ${first}ุ ุงููุฎ ุฒู ุงูุนุถูุฉ ุจุงูุธุจุท โ ูุฑููู ูู ููู ุญูุจูู ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุญุชูุงูู ูุฑู ูู ุชุฑููุฒู ููุฑุงุฑุงุชู.\n\nุงูุญู ูุงุฒู ููุฌู ููู ุฅูุชู. ุงููู ุจุชุณุชูุฑ ุจุชูุตู! ๐ฅ`,
      `ุฃููุงู ูุง ${first}! ๐ ูู ููู ุจุชูููู ููู ุชูุงุฑููู = ููู ุงุณุชุซูุฑุชู ูู ุฃุบูู ุญุงุฌุฉ ุนูุฏู: ุฏูุงุบู.\n\nููููุน ุชุฏูู ุญุฏ ุงูุญู ุฃู ุชุงุฎุฏู ูู ุญุฏ โ ุงูุฑุญูุฉ ุฏู ุฑุญูุชู ุฅูุชู ููุญุฏู.`,
      `ุตุจุงุญ/ูุณุงุก ุงููู ูุง ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชูููู ุฃุญุณู ูู ุฅูุจุงุฑุญ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููุงุฑุฏุฉ ุจูุฑุฉ ุญูุจูู ุณูู ุนูููู. ุงูุฅุตุฑุงุฑ ูู ุงูููุชุงุญ ูุง ููุฑ! โญ`,
      `ุฃููุงู ูุง ${first}! ๐ง ุฏูุงุบู ูุณุชุงูู ุฃุญุณู ุชุฏุฑูุจ. ูุชุณุชุนุฌููุดุ ุฎุฏู ููุชู ูุฑููุฒู.\n\nุงููู ุจุชุชูุฑู ูู ููู ุญุชูุงุญุธ ุงููุฑู ูู ุฃุณุจูุนูู. ุฅูุชู ูู ุงูุณูุฉ ุงูุตุญ! ๐ฏ`,
    ]},
    ye:{m:[
      `ุญููุงู ${first}! ๐ช ุงูุชูุงุฑูู ุฐู ูู ุฅูุช ุจุงูุฐุงุช ูุง ุฃุฎูู โ ุจุชููุฏู ูู ุดุบูู ููููู ูุญูุงุชู.\n\nูุง ุชุฎููู ุฃุญุฏ ูุญู ูู! ุฅูุช ูุฏูุง ููุฏูุฏ. ูู ุตุนูุจุฉ ุงููุฌุชูุฏ ูุนุฏูููุง! ๐`,
      `ููู ุงูุญุงู ${first}ุ ุงูุนูู ูุซู ุงูุฌุณู โ ุฅุฐุง ุฏุงููุช ุนููู ุตุงุฑ ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุจุชูุงุญุธ ุงููุฑู.\n\nุงูุญู ูุงุฒู ูููู ููู ุฅูุช. ุงููู ูุฏุงูู ููุตู! ๐ฅ`,
      `ูุฑุญุจุง ูุง ${first}! ๐ ูู ููู ุชููู ููู = ููู ุงุณุชุซูุฑุช ูู ุนููู.\n\nูุง ุชุญู ูุฃุญุฏ ููุง ุชุทูุจ ุญู ูู ุฃุญุฏ โ ุฐู ุฑุญูุชู ุฅูุช ูุญุฏู ูุง ุฃุฎูู.`,
      `ุตุจุงุญ ุงูุฎูุฑ ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชููู ุฃููู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุจูุฑุฉ ูุตูุฑ ุณูู. ุงูุฅุตุฑุงุฑ ูู ุงูุณุฑ! โญ`,
    ],f:[
      `ุญููุงู ุงููู ${first}! ๐ช ุงูุชูุงุฑูู ุฐู ูู ุฅูุชู ุจุงูุฐุงุช ูุง ุฃุฎุชู โ ุจุชููุฏู ูู ุดุบูู ููููู ูุญูุงุชู.\n\nูุง ุชุฎููู ุฃุญุฏ ูุญู ูู! ุฅูุชู ูุฏูุง. ูู ุตุนูุจุฉ ุงููุฌุชูุฏุฉ ุชุนุฏูููุง! ๐`,
      `ููู ุงูุญุงู ${first}ุ ุงูุนูู ูุซู ุงูุฌุณู โ ุฅุฐุง ุฏุงููุชู ุนููู ุตุงุฑ ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ูุจุชูุงุญุธู ุงููุฑู.\n\nุงูุญู ูุงุฒู ูููู ููู ุฅูุชู. ุงููู ุชุฏุงูู ุชูุตู! ๐ฅ`,
      `ูุฑุญุจุง ูุง ${first}! ๐ ูู ููู ุชูููู ููู = ููู ุงุณุชุซูุฑุชู ูู ุนููู.\n\nูุง ุชุญูู ูุฃุญุฏ ููุง ุชุทูุจู ุญู ูู ุฃุญุฏ โ ุฐู ุฑุญูุชู ุฅูุชู ูุญุฏู ูุง ุฃุฎุชู.`,
      `ุตุจุงุญ ุงูุฎูุฑ ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชูููู ุฃููู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุจูุฑุฉ ูุตูุฑ ุณูู. ุงูุฅุตุฑุงุฑ ูู ุงูุณุฑ! โญ`,
    ]},
    sd:{m:[
      `ูููู ูุง ุฒูู ${first}! ๐ช ุงูุชูุงุฑูู ุฏู ููู ุฅูุช ูุง ุญุจูุจ โ ุจุชููุฏู ูู ุดุบูู ููููู ูุญูุงุชู ูููุง.\n\nูุง ุชุฎูู ุฒูู ูุญู ููู! ุฅูุช ูุฏูุง ูุง ุฒูู. ุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงูุฒูู ุงููุฌุชูุฏ ุจูุนุฏููุง! ๐`,
      `ุณูุงู ุนููู ูุง ${first}! ุงูุนูู ุฒู ุงูุนุถูุฉ โ ูุฑููู ูู ููู ุจูููู ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ุจุชูุฑู ูุนุงู ูุชูุฑ.\n\nุงูุญู ูุงุฒู ูุฌู ููู ุฅูุช. ุงููุณุชูุฑ ุจููุตู! ๐ฅ`,
      `ุฃููุงู ูุง ุฒูู ${first}! ๐ ูู ููู ุจุชูููู = ููู ุงุณุชุซูุฑุช ูู ุนููู.\n\nูุง ุชุญู ูุฒูู ููุง ุชุทูุจ ุญู ูู ุฒูู โ ุงูุฑุญูุฉ ุฏู ุฑุญูุชู ุฅูุช ููุญุฏู ูุง ุญุจูุจ.`,
      `ุตุจุงุญ ุงูุฎูุฑ ูุง ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชููู ุฃุญุณู ูู ุฃูุณ.\n\nูู ุญุงุฌุฉ ุตุนุจุฉ ุงูููู ุจูุฑุฉ ุจุชููู ุณููุฉ. ุงูููู ุงูุฅุตุฑุงุฑ ูุง ุฒูู! โญ`,
    ],f:[
      `ูููู ูุง ${first}! ๐ช ุงูุชูุงุฑูู ุฏู ููู ุฅูุชู ูุง ุณุชู โ ุจุชููุฏู ูู ุดุบูู ููููู ูุญูุงุชู ูููุง.\n\nูุง ุชุฎูู ุฒูู ูุญู ููู! ุฅูุชู ูุฏูุง ูุง ุณุชู. ุงูุตุนูุจุฉ ุทุจูุนูุฉุ ุงูุฒููุฉ ุงููุฌุชูุฏุฉ ุจุชุนุฏููุง! ๐`,
      `ุณูุงู ุนููู ูุง ${first}! ุงูุนูู ุฒู ุงูุนุถูุฉ โ ูุฑูููู ูู ููู ุจูููู ุฃููู. ุนุดุฑ ุฏูุงูู ุจุณ ุจุชูุฑู ูุนุงู ูุชูุฑ.\n\nุงูุญู ูุงุฒู ูุฌู ููู ุฅูุชู. ุงููุณุชูุฑุฉ ุจุชูุตู! ๐ฅ`,
      `ุฃููุงู ูุง ${first}! ๐ ูู ููู ุจุชูููููู = ููู ุงุณุชุซูุฑุชู ูู ุนููู.\n\nูุง ุชุญูู ูุฒูู ููุง ุชุทูุจู ุญู ูู ุฒูู โ ุงูุฑุญูุฉ ุฏู ุฑุญูุชู ุฅูุชู ููุญุฏู ูุง ุณุชู.`,
      `ุตุจุงุญ ุงูุฎูุฑ ูุง ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ุฌุฏูุฏุฉ ุชูููู ุฃุญุณู ูู ุฃูุณ.\n\nูู ุญุงุฌุฉ ุตุนุจุฉ ุงูููู ุจูุฑุฉ ุจุชููู ุณููุฉ. ุงูููู ุงูุฅุตุฑุงุฑ ูุง ุณุชู! โญ`,
    ]},
    ar:{m:[
      `ูุฑุญุจุงู ${first}! ๐ช ูุฐู ุงูุชูุงุฑูู ุงุณุชุซูุงุฑ ููู ุฃูุช โ ุณุชููุนู ูู ุนููู ูุญูุงุชู.\n\nูุง ุชุณูุญ ูุฃุญุฏ ุจูุดุงุฑูุฉ ุงูุญู โ ุฃูุช ูุงุฏุฑ ุนูููุง. ูู ุตุนูุจุฉ ูุชุฌุงูุฒูุง ุงููุฌุชูุฏ! ๐`,
      `ุฃููุงู ${first}! ุงูุนูู ูุงูุนุถูุฉ โ ุฏุฑูุจู ููููุงู ูุฒุฏุงุฏ ููุฉ. ุนุดุฑ ุฏูุงุฆู ุชุตูุน ูุงุฑูุงู ุญููููุงู.\n\nุงูุญู ูุฌุจ ุฃู ูุฃุชู ููู ุฃูุช. ุงููุณุชูุฑ ูุตู! ๐ฅ`,
      `ูุฑุญุจุงู ${first}! ๐ ูู ููู ุชูููู ุชูุงุฑููู ูู ููู ุงุณุชุซูุฑุช ูู ุฃุซูู ูุง ุชููู: ุนููู.\n\nูุง ุชุดุงุฑู ุงูุญู ููุง ุชุฃุฎุฐู โ ูุฐู ุฑุญูุชู ูุญุฏู.`,
      `ุฃููุงู ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ูุชููู ุฃูุถู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุณูุตุจุญ ุณููุงู ุบุฏุงู. ุงูุฅุตุฑุงุฑ ููุชุงุญ ุงููุฌุงุญ! โญ`,
    ],f:[
      `ูุฑุญุจุงู ${first}! ๐ช ูุฐู ุงูุชูุงุฑูู ุงุณุชุซูุงุฑ ูููู ุฃูุชู โ ุณุชููุนูู ูู ุนูููู ูุญูุงุชูู.\n\nูุง ุชุณูุญู ูุฃุญุฏ ุจูุดุงุฑูุฉ ุงูุญู โ ุฃูุชู ูุงุฏุฑุฉ ุนูููุง. ูู ุตุนูุจุฉ ุชุชุฌุงูุฒูุง ุงููุฌุชูุฏุฉ! ๐`,
      `ุฃููุงู ${first}! ุงูุนูู ูุงูุนุถูุฉ โ ุฏุฑูุจูู ููููุงู ูุฒุฏุงุฏ ููุฉ. ุนุดุฑ ุฏูุงุฆู ุชุตูุน ูุงุฑูุงู ุญููููุงู.\n\nุงูุญู ูุฌุจ ุฃู ูุฃุชู ูููู ุฃูุชู. ุงููุณุชูุฑุฉ ุชุตู! ๐ฅ`,
      `ูุฑุญุจุงู ${first}! ๐ ูู ููู ุชูููููู ุชูุงุฑูููู ูู ููู ุงุณุชุซูุฑุชู ูู ุฃุซูู ูุง ุชููููู: ุนูููู.\n\nูุง ุชุดุงุฑูู ุงูุญู ููุง ุชุฃุฎุฐูู โ ูุฐู ุฑุญูุชูู ูุญุฏูู.`,
      `ุฃููุงู ${first}! ๐ช ููู ุฌุฏูุฏ ููุฑุตุฉ ูุชูููู ุฃูุถู ูู ุฃูุณ.\n\nูู ุชูุฑูู ุตุนุจ ุงูููู ุณูุตุจุญ ุณููุงู ุบุฏุงู. ุงูุฅุตุฑุงุฑ ููุชุงุญ ุงููุฌุงุญ! โญ`,
    ]},
  };
  const dMsgs=M[dialect]||M.sa;
  const msgs=dMsgs[g]||dMsgs.m;
  return msgs[day%msgs.length].replace(/\n/g,'<br>');
}

// ============ SHORTCUTS DATA ============
const SHORTCUTS = [
  // Windows ุนุงูุฉ
  {keys:['Ctrl','C'],desc:'ูุณุฎ',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','V'],desc:'ูุตู',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','X'],desc:'ูุต',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','Z'],desc:'ุชุฑุงุฌุน',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','Y'],desc:'ุฅุนุงุฏุฉ',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','A'],desc:'ุชุญุฏูุฏ ุงููู',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','S'],desc:'ุญูุธ',cat:'ูููุฏูุฒ'},
  {keys:['Ctrl','F'],desc:'ุจุญุซ',cat:'ูููุฏูุฒ'},
  {keys:['Alt','Tab'],desc:'ุงูุชุจุฏูู ุจูู ุงูููุงูุฐ',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['Alt','F4'],desc:'ุฅุบูุงู ุงููุงูุฐุฉ',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['Win','D'],desc:'ุฅุธูุงุฑ ุณุทุญ ุงูููุชุจ',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['Win','L'],desc:'ููู ุงูุฌูุงุฒ',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['Ctrl','Shift','Esc'],desc:'ูุฏูุฑ ุงูููุงู',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['Win','E'],desc:'ูุชุญ ูุณุชูุดู ุงููููุงุช',cat:'ูููุฏูุฒ',noPress:true},
  {keys:['PrtSc'],desc:'ููุทุฉ ุดุงุดุฉ',cat:'ูููุฏูุฒ'},
  // Excel
  {keys:['Ctrl','Home'],desc:'ุงูุฐูุงุจ ูุฃูู ุฎููุฉ',cat:'Excel'},
  {keys:['Ctrl','End'],desc:'ุงูุฐูุงุจ ูุขุฎุฑ ุฎููุฉ',cat:'Excel'},
  {keys:['Ctrl','Shift','+'],desc:'ุฅุฏุฑุงุฌ ุตู/ุนููุฏ',cat:'Excel'},
  {keys:['Ctrl','-'],desc:'ุญุฐู ุตู/ุนููุฏ',cat:'Excel'},
  {keys:['F2'],desc:'ุชุนุฏูู ุงูุฎููุฉ',cat:'Excel'},
  {keys:['Ctrl','D'],desc:'ูุณุฎ ุงูุฎููุฉ ููุฃุณูู',cat:'Excel'},
  {keys:['Ctrl','R'],desc:'ูุณุฎ ุงูุฎููุฉ ูููููู',cat:'Excel'},
  {keys:['Ctrl','Space'],desc:'ุชุญุฏูุฏ ุงูุนููุฏ ูุงูู',cat:'Excel'},
  {keys:['Shift','Space'],desc:'ุชุญุฏูุฏ ุงูุตู ูุงูู',cat:'Excel'},
  {keys:['Alt','='],desc:'ุฌูุน ุชููุงุฆู AutoSum',cat:'Excel'},
  {keys:['Ctrl','1'],desc:'ุชูุณูู ุงูุฎูุงูุง',cat:'Excel'},
  {keys:['Ctrl','B'],desc:'ุฎุท ุนุฑูุถ Bold',cat:'Excel'},
  // ุงููุชุตูุญ
  {keys:['Ctrl','T'],desc:'ูุชุญ ุชุจููุจ ุฌุฏูุฏ',cat:'ูุชุตูุญ',noPress:true},
  {keys:['Ctrl','W'],desc:'ุฅุบูุงู ุงูุชุจููุจ',cat:'ูุชุตูุญ',noPress:true},
  {keys:['Ctrl','Shift','T'],desc:'ุฅุนุงุฏุฉ ูุชุญ ุชุจููุจ ูุบูู',cat:'ูุชุตูุญ',noPress:true},
  {keys:['Ctrl','L'],desc:'ุงูุชุฑููุฒ ุนูู ุดุฑูุท ุงูุนููุงู',cat:'ูุชุตูุญ'},
  {keys:['Ctrl','Tab'],desc:'ุงูุชุจููุจ ุงูุชุงูู',cat:'ูุชุตูุญ',noPress:true},
  {keys:['Ctrl','Shift','Tab'],desc:'ุงูุชุจููุจ ุงูุณุงุจู',cat:'ูุชุตูุญ',noPress:true},
  {keys:['F5'],desc:'ุชุญุฏูุซ ุงูุตูุญุฉ',cat:'ูุชุตูุญ',noPress:true},
  {keys:['Ctrl','+'],desc:'ุชูุจูุฑ',cat:'ูุชุตูุญ'},
  {keys:['Ctrl','-'],desc:'ุชุตุบูุฑ',cat:'ูุชุตูุญ'},
  {keys:['Ctrl','0'],desc:'ุฅุนุงุฏุฉ ุงูุญุฌู ุงูุทุจูุนู',cat:'ูุชุตูุญ'},
];

// TYPING CURRICULUM - Progressive letter-by-letter
const TYPING_LESSONS={
  ar:[
    {id:1,title:'ุช ุจ',chars:'ุชุจ',drills:['ุชุชุชุชุช ุจุจุจุจุจุจ ุชุจุชุจุชุจ ุจุชุจุชุจุช','ุชุจ ุจุช ุชุจุช ุจุชุจ ุชุจุชุจ ุจุชุจุช']},
    {id:2,title:'ู ู',chars:'ุชุจูู',drills:['ููููู ููููู ูููููู ูููููู','ุชุจูู ุจูุช ูุจุช ูุจูู ุชุจูู']},
    {id:3,title:'ู ุณ',chars:'ุชุจูููุณ',drills:['ููููู ุณุณุณุณุณ ูุณูุณูุณ ุณูุณูุณู','ุจุณู ุณูู ูุจูู ูุณูู ุชูุณู']},
    {id:4,title:'ุง ู',chars:'ุชุจูููุณุงู',drills:['ุงุงุงุงุง ููููู ุงูุงูุงู ูุงูุงูุง','ุณูุงู ุจูุงู ูุงู ูุจุงุช ูููู']},
    {id:5,title:'ุด ู',chars:'ุชุจูููุณุงูุดู',drills:['ุดุดุดุดุด ููููู ุดูุดูุดู ูุดูุดูุด','ุดูุงู ูุชุงุจ ูุดููุฉ ุณููู ุจูู']},
    {id:6,title:'ุน ู',chars:'ุชุจูููุณุงูุดูุนู',drills:['ุนุนุนุนุน ููููู ุนูุนูุนู ูุนูุนูุน','ุนูู ููุจ ุนูู ูุณู ุนูู ุณุจู']},
    {id:7,title:'ู ุซ',chars:'ุชุจูููุณุงูุดูุนููุซ',drills:['ููููู ุซุซุซุซุซ ูุซูุซูุซ ุซูุซูุซู','ุดูุฑ ุซูู ููุงูุฉ ุจุญุซ ูุซูุฑ']},
    {id:8,title:'ุฑ ุฉ',chars:'ุชุจูููุณุงูุดูุนููุซุฑุฉ',drills:['ุฑุฑุฑุฑุฑ ุฉุฉุฉุฉุฉ ุฑุฉุฑุฉุฑุฉ ุฉุฑุฉุฑุฉุฑ','ูุชุงุจุฉ ููุงุฑุฉ ุฑุณุงูุฉ ูุฑุงุกุฉ']},
    {id:9,title:'ู ู',chars:'ุชุจูููุณุงูุดูุนููุซุฑุฉูู',drills:['ูููููู ูููููู ูููููู ูููููู','ููุช ููุฑุฉ ูุนุฑูุฉ ูุณููุฉ']},
    {id:10,title:'ูููุงุช ูุฌูู',chars:'all',drills:['ุจุณู ุงููู ุงูุฑุญูู ุงูุฑุญูู','ุงูุนูู ุงูุฌุงุฏ ูู ููุชุงุญ ุงููุฌุงุญ','ูู ุฌุฏ ูุฌุฏ ููู ุฒุฑุน ุญุตุฏ','ุงูุชุฏุฑูุจ ุงููููู ูุตูุน ุงููุงุฑู ุงููุจูุฑ','ูู ููู ูู ูุฑุตุฉ ุฌุฏูุฏุฉ ููุชุนูู ูุงูุชุทููุฑ','ุงูุตุจุฑ ููุชุงุญ ุงููุฑุฌ ูุงููุฌุงุญ','ุงูุนูู ููุฑ ูุงูุฌูู ุธูุงู','ุฎูุฑ ุงููุงุณ ุงููุนูู ูููุงุณ','ุฑุญูุฉ ุงูุงูู ููู ุชุจุฏุง ุจุฎุทูุฉ','ูุง ุชุคุฌู ุนูู ุงูููู ุงูู ุงูุบุฏ']},
  ],
  en:[
    {id:1,title:'F J',chars:'fj',drills:['fff jjj fjfj jfjf fjfjfj','fff jjj fj jf fjf jfj']},
    {id:2,title:'D K',chars:'fjdk',drills:['ddd kkk dkdk kdkd fdjk','dad fad kid fjdk dkfj']},
    {id:3,title:'S L',chars:'fjdksl',drills:['sss lll slsl lsls fdjksl','sad lad flask skill falls']},
    {id:4,title:'A ;',chars:'fjdksla;',drills:['aaa ;;; a;a; ;a;a fjdksla;','ask all fall lass add flask']},
    {id:5,title:'G H',chars:'fjdksla;gh',drills:['ggg hhh ghgh hghg fjdkslgh','glad half flash glass halls']},
    {id:6,title:'E I',chars:'fjdksla;ghei',drills:['eee iii eiei ieie ghei','like file side die hide']},
    {id:7,title:'R U',chars:'fjdksla;gheiur',drills:['rrr uuu ruru urur gheiur','rule fear sure true fire']},
    {id:8,title:'T Y',chars:'fjdksla;gheiurty',drills:['ttt yyy tyty ytyt gheiurty','they take stay year right']},
    {id:9,title:'W O',chars:'fjdksla;gheiurtywo',drills:['www ooo wowo owow tywo','work flow grow show world']},
    {id:10,title:'Full Words',chars:'all',drills:['The quick brown fox jumps over the lazy dog','Practice makes perfect every single day','Success is the sum of small efforts repeated','Hard work beats talent when talent does not work','Every day is a new opportunity to grow and learn','A journey of a thousand miles begins with one step','The best time to start is now','Knowledge is power and practice is the key','Small steps lead to big results over time','Focus on progress not on perfection']},
  ]
};

// ============ STATE ============
let S={user:null,data:null,curEx:null,timer:null};
let EX={};

function td(){return new Date().toDateString()}
function dn(id){return DEPTS.find(d=>d.id===id)?.n||''}

// Seeded random โ each employee gets different questions daily
function seedRand(seed){
  let h=0;for(let i=0;i<seed.length;i++){h=((h<<5)-h)+seed.charCodeAt(i);h|=0;}
  return function(){h^=h<<13;h^=h>>17;h^=h<<5;return(h>>>0)/4294967296;};
}
function empSeed(){return(S.user?.email||'x')+td();}
function empRand(){if(!EX._rng)EX._rng=seedRand(empSeed());return EX._rng();}
// Shuffle array with employee-specific seed
function empShuf(arr){const a=[...arr];const rng=seedRand(empSeed()+(EX.step||0));for(let i=a.length-1;i>0;i--){const j=Math.floor(rng()*((i+1)));[a[i],a[j]]=[a[j],a[i]];}return a;}

// ============ POINTS & RANKS SYSTEM ============
const RANKS=[
  {id:'bronze',name:'๐ฅ ุจุฑููุฒู',min:0,color:'#CD7F32'},
  {id:'silver',name:'๐ฅ ูุถู',min:500,color:'#C0C0C0'},
  {id:'gold',name:'๐ฅ ุฐูุจู',min:1000,color:'#FDCB6E'},
  {id:'diamond',name:'๐ ูุงุณู',min:2000,color:'#74b9ff'},
  {id:'legend',name:'๐ ุฃุณุทูุฑู',min:3500,color:'#a29bfe'},
];
function getRank(pts){for(let i=RANKS.length-1;i>=0;i--)if(pts>=RANKS[i].min)return RANKS[i];return RANKS[0];}
function getNextRank(pts){for(let i=0;i<RANKS.length;i++)if(pts<RANKS[i].min)return RANKS[i];return null;}

function calcDailyPoints(d){
  const done=Object.keys(d.todayEx||{}).length;
  if(done>=8)return 100;if(done>=4)return 50;if(done>=1)return 20;return 0;
}
function calcMissedPenalty(d){
  if(!d.lastA)return 0;
  const last=new Date(d.lastA);const now=new Date();
  const diffDays=Math.floor((now-last)/(864e5));
  if(diffDays<=1)return 0;
  const excused=d.excusedDays||[];let missedCount=0;
  for(let i=1;i<diffDays;i++){
    const checkDate=new Date(last.getTime()+i*864e5).toDateString();
    const isExcused=excused.some(e=>new Date(e.date).toDateString()===checkDate);
    const isWeekend=new Date(checkDate).getDay()===5||new Date(checkDate).getDay()===6;
    if(!isExcused&&!isWeekend)missedCount++;
  }
  if(missedCount===0)return 0;if(missedCount===1)return -30;if(missedCount===2)return -70;return -120;
}

// ============ LOGIN ============
function showLogin(){
  R().innerHTML=`<div class="fi" style="display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px">
    <div style="background:${C.cb};backdrop-filter:blur(30px);border:1px solid ${C.gb};border-radius:24px;padding:40px;max-width:400px;width:100%;text-align:center">
      <div style="width:60px;height:60px;background:linear-gradient(135deg,${C.ac},#00B894);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 16px;box-shadow:0 4px 20px ${C.ac}40">๐ง</div>
      <h2 style="font-family:'Readex Pro';font-size:22px;margin-bottom:6px">ููุตุฉ ุงูุชุฏุฑูุจ ุงูุฐููู</h2>
      <p style="color:${C.dim};font-size:13px;margin-bottom:24px">ุณุฑูุน ูููุซูู</p>
      <div id="loginForm">
        <div style="text-align:right;margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">๐ค ุงุณู ุงููุณุชุฎุฏู</label>
          <input class="inp" id="inUid" type="text" placeholder="ูุซุงู: ahmed" style="direction:ltr;text-align:left"></div>
        <div style="text-align:right;margin-bottom:6px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">๐ ูููุฉ ุงููุฑูุฑ</label>
          <input class="inp" id="inPass" type="password" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ"></div>
        <div id="lErr" style="color:${C.dng};font-size:12px;margin:6px 0;display:none"></div>
        <button class="btn" onclick="doLogin()" style="margin-top:4px">๐ ุฏุฎูู</button>
        <div onclick="showForgot()" style="margin-top:10px;font-size:12px;color:${C.dim};cursor:pointer;text-decoration:underline">ูุณูุช ูููุฉ ุงููุฑูุฑุ</div>
      </div>
      <div id="forgotForm" style="display:none">
        <div style="font-size:14px;color:${C.ac};margin-bottom:14px;font-weight:600">๐ ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ</div>
        <div style="text-align:right;margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุณุฌู</label>
          <input class="inp" id="inForgotEmail" type="email" placeholder="example@fast.sa" style="direction:ltr;text-align:left"></div>
        <div id="fMsg" style="font-size:12px;margin:6px 0;display:none"></div>
        <button class="btn" onclick="doForgot()" style="margin-top:4px">ุฅุฑุณุงู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</button>
        <div onclick="showLoginForm()" style="margin-top:10px;font-size:12px;color:${C.dim};cursor:pointer;text-decoration:underline">โ ุงูุนูุฏุฉ ูุชุณุฌูู ุงูุฏุฎูู</div>
      </div>
      <div style="margin-top:18px;padding-top:14px;border-top:1px solid ${C.gb}">
        <p style="font-size:11px;color:${C.dim};margin-bottom:8px">ุฏุฎูู ุงูุฅุฏุงุฑุฉ</p>
        <div style="text-align:center;margin-top:16px;font-size:11px;color:${C.dim}">ููุตุฉ ุงูุชุฏุฑูุจ ุงูุฐููู | ุณุฑูุน ูููุซูู</div>
      </div>
    </div></div>`;
  $('inUid').addEventListener('keydown',e=>{if(e.key==='Enter')$('inPass').focus()});
  $('inPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
}

window.showForgot=function(){$('loginForm').style.display='none';$('forgotForm').style.display='block';};
window.showLoginForm=function(){$('forgotForm').style.display='none';$('loginForm').style.display='block';};

window.doForgot=function(){
  const email=$('inForgotEmail').value.trim().toLowerCase();
  const msg=$('fMsg');msg.style.display='block';
  const emp=getEmpList().find(e=>e.email===email);
  if(!emp){msg.style.color=C.dng;msg.textContent='โ ุงูุจุฑูุฏ ุบูุฑ ูุณุฌู ูู ุงููุธุงู';return;}
  // Reset password to 1234
  const ud=loadU(emp.email);ud.pass='1234';saveU(ud);
  msg.style.color=C.ac;msg.innerHTML=`โ ุชู ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ<br><b>ุงุณู ุงููุณุชุฎุฏู:</b> ${emp.uid}<br><b>ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ:</b> 1234<br><span style="color:${C.gld};font-size:11px">ุบููุฑูุง ุจุนุฏ ุงูุฏุฎูู ูู ุงูุฅุนุฏุงุฏุงุช</span>`;
};

window.doLogin=async function(){
  const uid=$('inUid').value.trim().toLowerCase();const pass=$('inPass').value;
  $('lErr').style.display='none';
  const emp=getEmpList().find(e=>e.uid===uid);
  if(!emp){$('lErr').textContent='โ ุงุณู ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ';$('lErr').style.display='block';return;}
  // Show loading
  $('lErr').style.display='block';$('lErr').style.color=C.ac;$('lErr').textContent='โณ ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...';
  const ud=await loadUAsync(emp.email);
  if(pass!==ud.pass){$('lErr').style.color=C.dng;$('lErr').textContent='โ ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';return;}
  S.user={...emp};S.data=ud;
  if(!S.data.dialect) showDialectPicker();
  else if(!S.data.seenOnboard) showOnboarding(0);
  else showMotiv();
};

function showDialectPicker(){
  const first=S.user.name.split(' ')[0];
  R().innerHTML=`<div class="fi" style="display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px">
    <div style="max-width:480px;width:100%;text-align:center">
      <div style="width:70px;height:70px;background:linear-gradient(135deg,${C.ac},#00B894);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:34px;margin:0 auto 18px;box-shadow:0 6px 25px ${C.ac}40">๐</div>
      <div style="font-family:'Readex Pro';font-size:24px;font-weight:800;margin-bottom:6px">ุฃููุงู ${first}!</div>
      <p style="color:${C.dim};font-size:14px;margin-bottom:28px">ุนุดุงู ูุฎุงุทุจู ุจุฃุณููุจ ูุฑูุจ ูููุ ุงุฎุชุฑ ุงูููุฌุฉ ุงููู ุชูุถููุง:</p>
      <div style="display:flex;flex-direction:column;gap:12px;max-width:340px;margin:0 auto">
        <div onclick="pickDialect('sa')" style="background:${C.cb};border:2px solid ${C.gb};border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px" onmouseover="this.style.borderColor='${C.ac}';this.style.background='rgba(0,229,184,0.04)'" onmouseout="this.style.borderColor='${C.gb}';this.style.background='${C.cb}'">
          <span style="font-size:40px">๐ธ๐ฆ</span>
          <div style="text-align:right;flex:1"><div style="font-weight:700;font-size:16px;margin-bottom:2px">ุณุนูุฏู</div><div style="font-size:12px;color:${C.dim}">ููุง ูุงููู! ูุด ุงูุฃุฎุจุงุฑุ</div></div>
        </div>
        <div onclick="pickDialect('eg')" style="background:${C.cb};border:2px solid ${C.gb};border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px" onmouseover="this.style.borderColor='${C.ac}';this.style.background='rgba(0,229,184,0.04)'" onmouseout="this.style.borderColor='${C.gb}';this.style.background='${C.cb}'">
          <span style="font-size:40px">๐ช๐ฌ</span>
          <div style="text-align:right;flex:1"><div style="font-weight:700;font-size:16px;margin-bottom:2px">ูุตุฑู</div><div style="font-size:12px;color:${C.dim}">ุฃููุงู ูุง ูุงุจุชู! ุฅูู ุงูุฃุฎุจุงุฑุ</div></div>
        </div>
        <div onclick="pickDialect('ye')" style="background:${C.cb};border:2px solid ${C.gb};border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px" onmouseover="this.style.borderColor='${C.ac}';this.style.background='rgba(0,229,184,0.04)'" onmouseout="this.style.borderColor='${C.gb}';this.style.background='${C.cb}'">
          <span style="font-size:40px">๐พ๐ช</span>
          <div style="text-align:right;flex:1"><div style="font-weight:700;font-size:16px;margin-bottom:2px">ูููู</div><div style="font-size:12px;color:${C.dim}">ุญููุงู ุงููู! ููููุ</div></div>
        </div>
        <div onclick="pickDialect('sd')" style="background:${C.cb};border:2px solid ${C.gb};border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px" onmouseover="this.style.borderColor='${C.ac}';this.style.background='rgba(0,229,184,0.04)'" onmouseout="this.style.borderColor='${C.gb}';this.style.background='${C.cb}'">
          <span style="font-size:40px">๐ธ๐ฉ</span>
          <div style="text-align:right;flex:1"><div style="font-weight:700;font-size:16px;margin-bottom:2px">ุณูุฏุงูู</div><div style="font-size:12px;color:${C.dim}">ูููู ูุง ุฒููุ</div></div>
        </div>
        <div onclick="pickDialect('ar')" style="background:${C.cb};border:2px solid ${C.gb};border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:14px" onmouseover="this.style.borderColor='${C.ac}';this.style.background='rgba(0,229,184,0.04)'" onmouseout="this.style.borderColor='${C.gb}';this.style.background='${C.cb}'">
          <span style="font-size:40px">๐</span>
          <div style="text-align:right;flex:1"><div style="font-weight:700;font-size:16px;margin-bottom:2px">ุนุฑุจู ูุตูุญ</div><div style="font-size:12px;color:${C.dim}">ูุฑุญุจุงู ุจู! ููู ุญุงููุ</div></div>
        </div>
      </div>
    </div></div>`;
}

window.pickDialect=function(dl){
  S.data.dialect=dl;saveU(S.data);
  showOnboarding(0);
};

// ============ ONBOARDING INFOGRAPHIC ============
function getOnboardSlides(first){
  return [
    {
      icon:'๐ง',grad:`linear-gradient(135deg,${C.ac},#00B894)`,
      title:`${first}ุ ูุฐุง ุงูููุงู ูู ุฃูุช`,
      body:`ูุงูููุตุฉ ูู ูุงุฌุจ ูุธููู โ ูุฐุง <b style="color:${C.ac}">ุงุณุชุซูุงุฑ ููู ุฃูุช ุดุฎุตูุงู</b>.<br><br>ุนููู ูู ุฃุบูู ุฃุฏุงุฉ ุนูุฏู. ููุซู ูุง ุชูุชู ุจุตุญุฉ ุฌุณููุ ุนููู ูุญุชุงุฌ <b>ุชูุฑูู ูููู</b> ุนุดุงู ูููู ูู ุฃูุถู ุญุงูุงุชู.`,
      footer:'ูุงูุดู ุจูููุนู ูู ุดุบููุ ูู ุจูุชูุ ูู ุตุญุชูุ ููู ูู ูุฑุงุฑ ุชุงุฎุฐู.'
    },
    {
      icon:'โฑ๏ธ',grad:`linear-gradient(135deg,${C.ac2},#a29bfe)`,
      title:'ูกู ุฏูุงูู ุจุณ',
      body:`ูู ููู ุนูุฏู <b style="color:${C.ac2}">ูจ ุชูุงุฑูู ูุตูุฑุฉ</b> โ ุฐุงูุฑุฉุ ุชุฑููุฒุ ุณุฑุนุฉุ ููุทูุ ูุชุงุจุฉุ ูุงุฎุชุตุงุฑุงุช.<br><br>ูู ุชูุฑูู ุฏูููุฉ ุฃู ุฏูููุชูู. ุฃูู ูู ููุช ุงุณุชุฑุงุญุฉ ุงููููุฉ โ`,
      footer:'ูุจููุฉ ุนูู ุฃุฏูุงุช ุนูููุฉ ุญููููุฉ ูุณุชุฎุฏููุง ุนููุงุก ุงูููุณ ุญูู ุงูุนุงูู.'
    },
    {
      icon:'๐',grad:`linear-gradient(135deg,${C.gld},#e17055)`,
      title:'ุจุชุดูู ุงููุฑู ุจููุณู',
      body:`ูู ููู ุชููู ุงูุชูุงุฑูู โ ุชุดูู <b style="color:${C.gld}">ุฏุฑุฌุชู ุชุฑุชูุน</b>.<br>ุงูููุตุฉ ุชุชุงุจุน ุชูุฏูู ูุชูููู ุจุงูุถุจุท ููู ุชุญุณูุช.<br><br>ุงููุงุณ ุงููู ุฏุงููุช ุฃุณุจูุนูู ูุงุญุธุช ูุฑู ุญูููู ูู <b>ุชุฑููุฒูุง ูุณุฑุนุฉ ูุฑุงุฑุงุชูุง</b>.`,
      footer:'ููุงุฑูุชู ุงูุญููููุฉ ูุน ููุณู ุจุงูุฃูุณ โ ูู ูุน ุฃุญุฏ ุซุงูู.'
    },
    {
      icon:'๐',grad:`linear-gradient(135deg,#ff7675,#d63031)`,
      title:'ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ',
      body:`<div style="font-size:20px;margin:12px 0">๐ซ ูุง ุชุดุงุฑู ุงูุญู<br>๐ซ ูุง ุชุงุฎุฐ ุญู ูู ุฃุญุฏ</div><br>ูู ุฃุญุฏ ุญู ูู โ ูู ุงููู ุงุณุชูุงุฏ ูู ุฃูุช.<br>ููู ุญููุช ูุฃุญุฏ โ ุญุฑูุชู ูู ูุฑุตุฉ ูุชุทูุฑ.<br><br><b style="color:${C.gld}">ูู ูุงุญุฏ ูุจูู ููุณู ุจููุณู.</b>`,
      footer:'ุงูุตุนูุจุฉ ุทุจูุนูุฉ. ูู ุฌุฏูุฏ ุตุนุจ ูู ุงูุจุฏุงูุฉ โ ุฅูุง ุนูู ุงููุฌุชูุฏ ูุงููู ุนูุฏู ุฅุตุฑุงุฑ.'
    },
    {
      icon:'๐ฅ',grad:`linear-gradient(135deg,${C.ac},${C.ac2})`,
      title:'ุฌุงูุฒ ุชุจุฏุฃ ุฑุญูุชูุ',
      body:`<div style="display:flex;flex-direction:column;gap:10px;text-align:right;font-size:14px;margin:8px 0">
        <div>โ ูู ููู ุฃููู ุชูุงุฑูู = ๐ฅ ููู ูุชุชุงูู</div>
        <div>โ ูู ูุง ุชูุฑูุช = ๐ ูุณุชูุงู ูุฑุชูุน</div>
        <div>โ ุชูุฏูู ูุญููุธ = ๐ฏ ุชุดูู ุชุทูุฑู</div>
        <div>โ ูกู ุฏูุงูู = โ ุฃูู ูู ุงุณุชุฑุงุญุฉ</div>
      </div>`,
      footer:`${first}ุ ุนููู ูุณุชุงูู. ููุง ูุจุฏุฃ! ๐ช`
    }
  ];
}

function showOnboarding(idx){
  const first=S.user.name.split(' ')[0];
  const slides=getOnboardSlides(first);
  if(idx>=slides.length){S.data.seenOnboard=true;saveU(S.data);showMotiv();return;}
  const s=slides[idx];const isLast=idx===slides.length-1;
  const dots=slides.map((_,i)=>`<div style="width:${i===idx?'24px':'8px'};height:8px;border-radius:4px;background:${i===idx?C.ac:'rgba(255,255,255,0.15)'};transition:all 0.3s"></div>`).join('');

  R().innerHTML=`<div class="fi" style="display:flex;min-height:100vh;align-items:center;justify-content:center;padding:24px">
    <div style="max-width:520px;width:100%;text-align:center">
      <div style="width:80px;height:80px;background:${s.grad};border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 20px;box-shadow:0 8px 30px rgba(0,0,0,0.3)">
        ${s.icon}</div>
      <div style="font-family:'Readex Pro';font-size:22px;font-weight:800;margin-bottom:18px;line-height:1.5">${s.title}</div>
      <div style="background:${C.cb};border:1px solid ${C.gb};border-radius:18px;padding:26px;text-align:right">
        <div style="font-size:15px;line-height:2.1">${s.body}</div>
        ${s.footer?`<div style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:10px;font-size:13px;color:${C.gld};line-height:1.8">๐ก ${s.footer}</div>`:''}
      </div>
      <div style="display:flex;gap:6px;justify-content:center;margin:22px 0">${dots}</div>
      <div style="display:flex;gap:10px;justify-content:center;align-items:center">
        ${idx>0?`<button onclick="showOnboarding(${idx-1})" style="padding:10px 20px;background:rgba(255,255,255,0.05);border:1px solid ${C.gb};border-radius:10px;color:${C.dim};font-family:'Tajawal';font-size:13px;cursor:pointer">โ ุงูุณุงุจู</button>`:''}
        <button class="btn" onclick="showOnboarding(${idx+1})" style="max-width:200px;font-size:15px;padding:12px 28px">${isLast?'๐ ููุง ูุจุฏุฃ!':'ุงูุชุงูู โ'}</button>
      </div>
      <div onclick="showOnboarding(${slides.length})" style="margin-top:10px;font-size:11px;color:${C.dim};cursor:pointer">ุชุฎุทู ุงููู</div>
    </div></div>`;
}

// ============ MOTIVATIONAL ============
function showMotiv(){
  const first=S.user.name.split(' ')[0];const d=S.data;const dl=S.data.dialect||'sa';
  const hr=new Date().getHours();
  const greet=G()==='f'?
    (hr<12?`โ๏ธ ุตุจุงุญ ุงูููุฑ ${first}`:hr<17?`๐ค๏ธ ูุณุงุก ุงูููุฑ ${first}`:`๐ ูุณุงุก ุงูุฎูุฑ ${first}`):
    (hr<12?`โ๏ธ ุตุจุงุญ ุงูุฎูุฑ ${first}`:hr<17?`๐ค๏ธ ูุณุงุก ุงูููุฑ ${first}`:`๐ ูุณุงุก ุงูุฎูุฑ ${first}`);
  const msg=getMotiv(first,dl,d.streak,d.firstTime);
  if(d.firstTime){d.firstTime=false;saveU(d);}
  
  // Smart guidance for struggling users
  let guidance='';
  if(d.hist.length>=10){
    const recent=d.hist.slice(-10);
    const recentAvg=Math.round(recent.reduce((a,b)=>a+b.score,0)/recent.length);
    // Check per-skill weakness
    const weakSkills=[];
    EXT.forEach(ex=>{
      const h=d.hist.filter(x=>x.type===ex.id).slice(-5);
      if(h.length>=3){
        const avg=Math.round(h.reduce((a,b)=>a+b.score,0)/h.length);
        if(avg<50)weakSkills.push({name:ex.n,ic:ex.ic,avg});
      }
    });
    if(recentAvg<40&&d.hist.length>=15){
      const gMsg=G()==='f'?
        `${first}ุ ูุนุฏูู ุขุฎุฑ ูุชุฑุฉ <b>${recentAvg}%</b> โ ูุญุชุงุฌ ูุฑูุนู. ุฑููุฒู ุนูู ุงูุชูุงุฑูู ุงูุชุงููุฉ ููููุงู ููุงุฒู ุชูุตููู <b>ูฅู%</b> ุนูู ุงูุฃูู ุฎูุงู ุฃุณุจูุน:`:
        `${first}ุ ูุนุฏูู ุขุฎุฑ ูุชุฑุฉ <b>${recentAvg}%</b> โ ูุญุชุงุฌ ูุฑูุนู. ุฑููุฒ ุนูู ุงูุชูุงุฑูู ุงูุชุงููุฉ ููููุงู ููุงุฒู ุชูุตู <b>ูฅู%</b> ุนูู ุงูุฃูู ุฎูุงู ุฃุณุจูุน:`;
      guidance=`<div style="background:rgba(255,118,117,0.06);border:1px solid rgba(255,118,117,0.12);border-radius:14px;padding:16px;margin-top:14px;text-align:right">
        <div style="font-weight:700;color:${C.dng};margin-bottom:6px">๐ ุฎุทุฉ ุชุญุณูู ูุทููุจุฉ</div>
        <div style="font-size:14px;color:#E8ECF1;line-height:1.8">${gMsg}</div>
        ${weakSkills.length?`<div style="margin-top:8px">${weakSkills.map(s=>`<span style="display:inline-block;padding:4px 10px;margin:3px;border-radius:6px;font-size:13px;background:rgba(255,118,117,0.1);color:${C.dng}">${s.ic} ${s.name} (${s.avg}%)</span>`).join('')}</div>`:''}
      </div>`;
    }else if(weakSkills.length>=2){
      const gTip=G()==='f'?'ุนูุฏู ููุงุฑุงุช ุชุญุชุงุฌ ุชุฑููุฒ ุฃูุซุฑ โ ุฎููู ุนูุฏู ุชูุฑูููู ุนูู ุงูุฃูู ูู ููู:':'ุนูุฏู ููุงุฑุงุช ุชุญุชุงุฌ ุชุฑููุฒ ุฃูุซุฑ โ ุฎูู ุนูุฏู ุชูุฑูููู ุนูู ุงูุฃูู ูู ููู:';
      guidance=`<div style="background:rgba(253,203,110,0.06);border:1px solid rgba(253,203,110,0.12);border-radius:14px;padding:16px;margin-top:14px;text-align:right">
        <div style="font-weight:700;color:${C.gld};margin-bottom:6px">๐ก ูุตูุญุฉ ${G()==='f'?'ูู':'ูู'}</div>
        <div style="font-size:14px;color:#E8ECF1;line-height:1.8">${gTip}</div>
        <div style="margin-top:8px">${weakSkills.map(s=>`<span style="display:inline-block;padding:4px 10px;margin:3px;border-radius:6px;font-size:13px;background:rgba(253,203,110,0.1);color:${C.gld}">${s.ic} ${s.name} (${s.avg}%)</span>`).join('')}</div>
      </div>`;
    }
  }

  R().innerHTML=`<div class="fi" style="display:flex;min-height:100vh;align-items:center;justify-content:center;padding:32px">
    <div style="max-width:600px;width:100%;text-align:center">
      <div style="font-family:'Readex Pro';font-size:26px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,${C.ac},${C.gld});-webkit-background-clip:text;-webkit-text-fill-color:transparent">${greet}</div>
      <div style="font-size:13px;color:${C.dim};margin-bottom:24px">${new Date().toLocaleDateString('ar-SA',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
      <div style="background:${C.cb};border:1px solid ${C.gb};border-radius:20px;padding:28px;text-align:right">
        <div style="font-size:11px;color:${C.dim};margin-bottom:10px;text-align:right">${DL[dl]||DL.sa} ุฑุณุงูุฉ ุงูููู</div>
        <div style="font-size:15px;line-height:2">${msg}</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:14px;flex-wrap:wrap">
          <span style="padding:5px 12px;border-radius:8px;font-size:12px;background:rgba(253,203,110,0.1);color:${C.gld};border:1px solid rgba(253,203,110,0.15)">๐ฅ ${d.streak} ููู</span>
          <span style="padding:5px 12px;border-radius:8px;font-size:12px;background:rgba(108,92,231,0.1);color:#a29bfe;border:1px solid rgba(108,92,231,0.15)">โญ ูุณุชูู ${d.level}</span>
          <span style="padding:5px 12px;border-radius:8px;font-size:12px;background:${getRank(d.points).color}18;color:${getRank(d.points).color};border:1px solid ${getRank(d.points).color}30">${getRank(d.points).name}</span>
          <span style="padding:5px 12px;border-radius:8px;font-size:12px;background:rgba(0,229,184,0.1);color:${C.ac};border:1px solid rgba(0,229,184,0.15)">๐ฐ ${d.points} ููุทุฉ</span>
        </div>
        ${guidance}
      </div>
      <button class="btn" onclick="showMain()" style="max-width:260px;margin:24px auto 0;display:block;font-size:16px">๐ช ููุง ูุจุฏุฃ</button>
      <div onclick="showMain()" style="margin-top:12px;font-size:12px;color:${C.dim};cursor:pointer">ุชุฎุทู</div>
    </div></div>`;
}

// ============ MAIN ============
function showMain(){
  const r=S.user.role;
  let tabs=[];
  if(r==='employee'||r==='manager'){tabs.push({id:'ex',l:'๐ ุงูุชูุงุฑูู'},{id:'prog',l:'๐ ุชูุฏูู'},{id:'settings',l:'โ๏ธ ุงูุฅุนุฏุงุฏุงุช'});}
  if(r==='manager')tabs.splice(2,0,{id:'team',l:'๐ฅ ูุฑููู'});
  if(r==='hr'||r==='admin'||r==='gm'){tabs.push({id:'ex',l:'๐ ุงูุชูุงุฑูู'},{id:'adm',l:'โ๏ธ ููุญุฉ ุงูุชุญูู'},{id:'settings',l:'๐ง ุงูุฅุนุฏุงุฏุงุช'});}

  R().innerHTML=`<div class="hdr"><div style="display:flex;align-items:center;gap:12px"><div style="width:42px;height:42px;background:linear-gradient(135deg,${C.ac},#00B894);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 20px ${C.ac}40">๐ง</div><div><div style="font-family:'Readex Pro';font-size:17px;font-weight:700">ุงูุชุฏุฑูุจ ุงูุฐููู</div><div style="font-size:11px;color:${C.ac}">ุณุฑูุน ูููุซูู</div></div></div>
    <div style="display:flex;align-items:center;gap:14px"><div><div style="font-weight:600;font-size:13px;text-align:left">${S.user.name}</div><div style="font-size:11px;color:${C.dim}">${ROLES[r]}</div></div>
    <button onclick="doLogout()" style="padding:6px 14px;background:rgba(255,118,117,0.1);border:1px solid rgba(255,118,117,0.2);border-radius:8px;color:${C.dng};font-family:'Tajawal';font-size:12px;cursor:pointer">ุฎุฑูุฌ</button></div></div>
  <div style="display:flex;gap:3px;padding:12px 32px;background:rgba(10,15,28,0.5);border-bottom:1px solid ${C.gb};overflow-x:auto" id="nav">
    ${tabs.map((t,i)=>`<div class="nt" data-t="${t.id}" onclick="nav('${t.id}')" style="padding:9px 18px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:500;white-space:nowrap;transition:all 0.3s;color:${i===0?C.ac:C.dim};background:${i===0?'rgba(0,229,184,0.08)':'transparent'};border:1px solid ${i===0?'rgba(0,229,184,0.15)':'transparent'}">${t.l}</div>`).join('')}
  </div>
  <div style="padding:24px 32px;max-width:1400px;margin:0 auto" id="ct"></div>`;
  nav(tabs[0].id);
}

window.nav=function(t){document.querySelectorAll('.nt').forEach(n=>{const a=n.dataset.t===t;n.style.color=a?C.ac:C.dim;n.style.background=a?'rgba(0,229,184,0.08)':'transparent';n.style.borderColor=a?'rgba(0,229,184,0.15)':'transparent';});
  if(t==='ex')rExercises();else if(t==='prog')rProgress();else if(t==='team')rTeam();else if(t==='adm')rAdmin();else if(t==='settings')rSettings();};
window.doLogout=function(){S.user=null;S.data=null;clearInterval(S.timer);showLogin();};

// ============ SETTINGS (Change Password) ============
function rSettings(){
  $('ct').innerHTML=`<div class="card fi" style="max-width:500px">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:20px">๐ ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ</label><input class="inp" type="password" id="oldPass"></div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label><input class="inp" type="password" id="newPass"></div>
    <div style="margin-bottom:16px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label><input class="inp" type="password" id="newPass2"></div>
    <div id="passMsg" style="font-size:13px;margin-bottom:10px;display:none"></div>
    <button class="btn" style="max-width:200px" onclick="changePass()">ุชุบููุฑ</button>
  </div>
  <div class="card fi" style="max-width:500px;margin-top:16px">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:10px">๐ง ูุนูููุงุช ุงูุญุณุงุจ</div>
    <div style="font-size:14px;color:${C.dim};margin-bottom:6px">ุงุณู ุงููุณุชุฎุฏู: <span style="color:#fff;direction:ltr;display:inline-block;font-weight:600">${S.user.uid}</span></div>
    <div style="font-size:14px;color:${C.dim};margin-bottom:6px">ุงูุจุฑูุฏ: <span style="color:#fff;direction:ltr;display:inline-block">${S.user.email}</span></div>
    <div style="font-size:14px;color:${C.dim}">ุงููุณู: <span style="color:#fff">${dn(S.user.dept)}</span></div>
    <div style="margin-top:10px;padding:8px 12px;background:rgba(253,203,110,0.08);border:1px solid rgba(253,203,110,0.12);border-radius:8px;font-size:11px;color:${C.gld}">๐ก ูู ูุณูุช ูููุฉ ุงููุฑูุฑุ ุงุณุชุฎุฏู ุจุฑูุฏู ุงูุฅููุชุฑููู ูุงุณุชุนุงุฏุชูุง ูู ุตูุญุฉ ุงูุฏุฎูู</div>
  </div>
  <div class="card fi" style="max-width:500px;margin-top:16px">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:14px">๐ ุงูููุฌุฉ ุงูููุถูุฉ</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      ${[['sa','๐ธ๐ฆ ุณุนูุฏู'],['eg','๐ช๐ฌ ูุตุฑู'],['ye','๐พ๐ช ูููู'],['sd','๐ธ๐ฉ ุณูุฏุงูู'],['ar','๐ ูุตุญู']].map(([k,l])=>`<div onclick="changeDL('${k}')" style="padding:8px 16px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:600;transition:all 0.3s;border:2px solid ${S.data.dialect===k?C.ac:C.gb};background:${S.data.dialect===k?'rgba(0,229,184,0.08)':'transparent'};color:${S.data.dialect===k?C.ac:'inherit'}">${l}</div>`).join('')}
    </div>
    <div id="dlMsg" style="font-size:12px;margin-top:8px;color:${C.ac};display:none"></div>
  </div>
  <div class="card fi" style="max-width:500px;margin-top:16px">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:14px">โ๏ธ ุชุนุฏูู ุจูุงูุงุชู</div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงูุงุณู ุจุงูุนุฑุจู</label><input class="inp" id="edName" value="${S.user.name||''}"></div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label><input class="inp" id="edEmail" value="${S.user.email||''}" style="direction:ltr;text-align:left"></div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงูุฌูุงู</label><input class="inp" id="edPhone" value="${S.user.phone||''}" style="direction:ltr;text-align:left" placeholder="05xxxxxxxx"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงูุฌูุณ</label><select class="inp" id="edGender"><option value="ุฐูุฑ" ${S.user.gender==='ุฃูุซู'?'':'selected'}>ุฐูุฑ</option><option value="ุฃูุซู" ${S.user.gender==='ุฃูุซู'?'selected':''}>ุฃูุซู</option></select></div>
      <div><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงูุนูุฑ</label><input class="inp" type="number" id="edAge" value="${S.user.age||''}" placeholder="25"></div>
    </div>
    <div id="edMsg" style="font-size:13px;margin-bottom:10px;display:none"></div>
    <button class="btn" style="max-width:200px" onclick="saveProfile()">๐พ ุญูุธ ุงูุชุนุฏููุงุช</button>
  </div>
    <p style="font-size:13px;color:${C.dim};margin-bottom:12px">ุดูู ูุฑุฉ ุซุงููุฉ ุงูุดุฑุญ ุงูุชุนุฑููู ุนู ุงูููุตุฉ ูููุณูุชูุง ูููุด ูู ูููุฉ ูู.</p>
    <button class="btn" style="max-width:220px;font-size:13px;padding:10px" onclick="showOnboarding(0)">๐ฌ ุนุฑุถ ุงูุดุฑุญ ุงูุชุนุฑููู</button>
  </div>
  ${S.user.role==='gm'?`<div class="card fi" style="max-width:500px;margin-top:16px">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:10px">๐ ุฅุนุงุฏุฉ ุชูุงุฑูู ุงูููู</div>
    <p style="font-size:13px;color:${C.dim};margin-bottom:12px">ุตูุงุญูุฉ ุงููุฏูุฑ ุงูุนุงู ููุท โ ูุฃู ุญุงุฌุฉ ุทุงุฑุฆุฉ ูู ุงููุชุฑุฉ ุงูุชุฌุฑูุจูุฉ.</p>
    <button class="btn" style="max-width:220px;font-size:13px;padding:10px;background:linear-gradient(135deg,${C.ac2},#a29bfe)" onclick="resetToday()">๐ ุฅุนุงุฏุฉ ุชูุงุฑูู ุงูููู</button>
    <div id="resetMsg" style="font-size:12px;margin-top:8px;color:${C.ac};display:none"></div>
  </div>
  <div class="card fi" style="max-width:600px;margin-top:16px;border-color:rgba(255,118,117,0.2)">
    <div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:10px;color:${C.dng}">๐๏ธ ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูููุธููู</div>
    <p style="font-size:13px;color:${C.dim};margin-bottom:14px;line-height:1.8">ุงุฎุชุฑ ุงูููุธููู ุงููู ุชุจู ุชูุณุญ ุจูุงูุงุชูู (ุงูุณุฌูุงุช ูุงูููุงุท) ุฃู ุชุญุฐููู ุจุงููุงูู.</p>
    <div id="empResetList" style="max-height:350px;overflow-y:auto">
    ${getEmpList().map((e,i)=>{
      const d=gs('u_'+e.email);
      const hist=d?.hist?.length||0;
      const pts=d?.points||0;
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid ${C.gb};gap:10px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:13px">${e.name} <span style="color:${C.dim};font-size:11px;direction:ltr">${e.uid}</span></div>
          <div style="font-size:11px;color:${C.dim}">${hist} ุชูุฑูู | ${pts} ููุทุฉ | ${dn(e.dept)}</div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button onclick="resetEmpData('${e.email}','${e.name}')" style="padding:5px 10px;background:rgba(253,203,110,0.1);border:1px solid rgba(253,203,110,0.2);border-radius:6px;color:${C.gld};font-family:'Tajawal';font-size:11px;cursor:pointer" title="ูุณุญ ุงูุณุฌูุงุช ูุงูููุงุท ููุท">๐ ูุณุญ ุจูุงูุงุชู</button>
          <button onclick="removeEmpFull(${i},'${e.name}')" style="padding:5px 10px;background:rgba(255,118,117,0.1);border:1px solid rgba(255,118,117,0.2);border-radius:6px;color:${C.dng};font-family:'Tajawal';font-size:11px;cursor:pointer" title="ุญุฐู ุงูููุธู ุจุงููุงูู">๐๏ธ ุญุฐู</button>
        </div>
      </div>`;
    }).join('')}
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="resetAllDataConfirm()" style="padding:8px 16px;background:rgba(255,118,117,0.1);border:1px solid rgba(255,118,117,0.2);border-radius:8px;color:${C.dng};font-family:'Tajawal';font-size:12px;cursor:pointer">๐๏ธ ูุณุญ ุจูุงูุงุช ุงููู</button>
    </div>
    <div id="resetAllMsg" style="font-size:12px;margin-top:8px;display:none"></div>
  </div>`:''}`;
}

window.changePass=function(){
  const old=$('oldPass').value,nw=$('newPass').value,nw2=$('newPass2').value;const msg=$('passMsg');
  msg.style.display='block';
  if(old!==S.data.pass){msg.style.color=C.dng;msg.textContent='โ ูููุฉ ุงููุฑูุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ';return;}
  if(nw.length<4){msg.style.color=C.dng;msg.textContent='โ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ูุตูุฑุฉ (4 ุฃุญุฑู ุนูู ุงูุฃูู)';return;}
  if(nw!==nw2){msg.style.color=C.dng;msg.textContent='โ ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ ุบูุฑ ูุชุทุงุจูุฉ';return;}
  S.data.pass=nw;saveU(S.data);
  msg.style.color=C.ac;msg.textContent='โ ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุจูุฌุงุญ!';
  $('oldPass').value='';$('newPass').value='';$('newPass2').value='';
};

window.saveProfile=async function(){
  const name=$('edName').value.trim();const email=$('edEmail').value.trim().toLowerCase();
  const phone=$('edPhone').value.trim();const gender=$('edGender').value;const age=$('edAge').value;
  const msg=$('edMsg');msg.style.display='block';
  if(!name){msg.style.color=C.dng;msg.textContent='โ ุงูุงุณู ูุทููุจ';return;}
  
  const emps=getEmpList();const idx=emps.findIndex(e=>e.uid===S.user.uid);
  if(idx<0){msg.style.color=C.dng;msg.textContent='โ ุฎุทุฃ ูู ุงูุจูุงูุงุช';return;}
  
  // Check if email changed and is unique
  const oldEmail=S.user.email;
  if(email!==oldEmail){
    if(emps.find(e=>e.email===email&&e.uid!==S.user.uid)){msg.style.color=C.dng;msg.textContent='โ ุงูุจุฑูุฏ ูุณุชุฎุฏู ูู ููุธู ุขุฎุฑ';return;}
    // Migrate user data to new email
    const d=gs('u_'+oldEmail);
    if(d){d.email=email;ss('u_'+email,d);localStorage.removeItem('u_'+oldEmail);
      await fbDel('users',oldEmail.replace(/[.@]/g,'_'));
      await fbSet('users',email.replace(/[.@]/g,'_'),d);
      S.data=d;
    }
  }
  
  // Update employee record
  emps[idx].name=name;emps[idx].email=email;
  if(phone)emps[idx].phone=phone;
  if(gender)emps[idx].gender=gender;
  if(age)emps[idx].age=parseInt(age);
  await setEmps(emps);
  
  // Update session
  S.user={...emps[idx]};
  msg.style.color=C.ac;msg.textContent='โ ุชู ุญูุธ ุงูุชุนุฏููุงุช!';
};

window.changeDL=function(dl){
  S.data.dialect=dl;saveU(S.data);rSettings();
};

window.resetToday=function(){
  S.data.todayEx={};saveU(S.data);
  const msg=$('resetMsg');if(msg){msg.style.display='block';msg.textContent='โ ุชู! ุชูุฏุฑ ุชุฌุฑุจ ุงูุชูุงุฑูู ูู ุฌุฏูุฏ';}
};

window.resetEmpToday=function(){
  const email=$('resetEmpSel').value;
  const msg=$('resetEmpMsg');msg.style.display='block';
  const d=gs('u_'+email);
  if(!d){msg.style.color=C.dng;msg.textContent='โ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูููุธู';return;}
  d.todayEx={};d.todayD=null;
  ss('u_'+email,d);
  fbSet('users',email.replace(/[.@]/g,'_'),d);
  if(S.data.email===email)S.data=loadU(email);
  const emp=getEmpList().find(e=>e.email===email);
  msg.style.color=C.ac;msg.textContent=`โ ุชู ุฅุนุงุฏุฉ ุชูุงุฑูู ุงูููู ูู ${emp?.name||email}`;
};

// Reset one employee's data (keep their account)
window.resetEmpData=function(email,name){
  if(!confirm(`ูุณุญ ุณุฌูุงุช ูุจูุงูุงุช ${name}ุ\n\nูููุณุญ: ุงูุชูุงุฑููุ ุงูููุงุทุ ุงููุฑุงุชุจุ ุงูุณุชุฑูู\nูุจูู: ุงูุญุณุงุจุ ุงูุงุณูุ ุงูุฅููููุ ูููุฉ ุงูุณุฑ`))return;
  const d=gs('u_'+email);
  if(d){
    d.hist=[];d.todayEx={};d.todayD=null;d.streak=0;d.best=0;d.level=1;
    d.points=0;d.lastA=null;d.firstTime=true;
    d.excusedDays=[];d.goldenHist=[];d.weekendMins=0;
    d.goldenExDone=0;d.goldenStart=null;
    ss('u_'+email,d);
    fbSet('users',email.replace(/[.@]/g,'_'),d);
  }
  if(S.data.email===email){
    S.data=loadU(email);
  }
  const msg=$('resetAllMsg');
  if(msg){msg.style.display='block';msg.style.color=C.ac;msg.textContent=`โ ุชู ูุณุญ ุจูุงูุงุช ${name}`;}
  setTimeout(()=>rSettings(),1500);
};

// Remove employee completely (account + data)
window.removeEmpFull=async function(idx,name){
  if(!confirm(`โ๏ธ ุญุฐู ${name} ุจุงููุงููุ\n\nููุญุฐู: ุงูุญุณุงุจ + ุฌููุน ุงูุจูุงูุงุช\nูุง ูุฑุฌุน!`))return;
  const emps=getEmpList();
  if(idx>=0&&idx<emps.length){
    const email=emps[idx].email;
    localStorage.removeItem('u_'+email);
    await fbDel('users',email.replace(/[.@]/g,'_'));
    emps.splice(idx,1);
    await setEmps(emps);
  }
  const msg=$('resetAllMsg');
  if(msg){msg.style.display='block';msg.style.color=C.ac;msg.textContent=`โ ุชู ุญุฐู ${name} ุจุงููุงูู`;}
  setTimeout(()=>rSettings(),1500);
};

// Reset ALL employees data
window.resetAllDataConfirm=async function(){
  if(!confirm('โ๏ธ ูุณุญ ุจูุงูุงุช ุฌููุน ุงูููุธูููุ\n\nุงูุญุณุงุจุงุช ุชุจูู โ ุจุณ ุงูุณุฌูุงุช ูุงูููุงุท ุชููุณุญ.'))return;
  if(!confirm('๐ด ุชุฃููุฏ ููุงุฆูุ'))return;
  const emps=getEmpList();
  for(const e of emps){
    const d=gs('u_'+e.email);
    if(d){
      d.hist=[];d.todayEx={};d.todayD=null;d.streak=0;d.best=0;d.level=1;
      d.points=0;d.lastA=null;d.firstTime=true;
      d.excusedDays=[];d.goldenHist=[];d.weekendMins=0;
      ss('u_'+e.email,d);
      await fbSet('users',e.email.replace(/[.@]/g,'_'),d);
    }
  }
  S.data=loadU(S.data.email);
  localStorage.removeItem('excuse_log');
  const msg=$('resetAllMsg');
  if(msg){msg.style.display='block';msg.style.color=C.ac;msg.textContent='โ ุชู ูุณุญ ุจูุงูุงุช ุงูุฌููุน โ ุงููู ูุจุฏุฃ ูู ุตูุฑ';}
  setTimeout(()=>rSettings(),2000);
};

// ============ EXERCISES ============
function rExercises(){
  const u=S.data;const done=Object.keys(u.todayEx).length;
  const avg=u.hist.length?Math.round(u.hist.reduce((a,b)=>a+b.score,0)/u.hist.length):0;
  const catC={memory:'background:rgba(108,92,231,0.15);color:#a29bfe',focus:`background:rgba(0,229,184,0.15);color:${C.ac}`,speed:`background:rgba(253,203,110,0.15);color:${C.gld}`,logic:'background:rgba(255,118,117,0.15);color:#ff7675'};
  $('ct').innerHTML=`<div class="fi" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px">
    ${[['ุงููุฑุชุจุฉ',getRank(u.points).name],['ุงูููุงุท',u.points],['ุชูุงุฑูู ุงูููู',done+'/8'],['ุฃูุงู ูุชุชุงููุฉ',u.streak+' ๐ฅ'],['ุงููุนุฏู',avg+'%']].map(([l,v])=>`<div style="background:${C.cb};border:1px solid ${C.gb};border-radius:16px;padding:16px"><div style="font-size:11px;color:${C.dim};margin-bottom:5px">${l}</div><div style="font-family:'Readex Pro';font-size:22px;font-weight:700">${v}</div></div>`).join('')}</div>
  ${getNextRank(u.points)?`<div class="fi" style="margin-bottom:20px;padding:12px 18px;background:${C.cb};border:1px solid ${C.gb};border-radius:14px;display:flex;align-items:center;gap:14px">
    <div style="flex:1"><div style="font-size:12px;color:${C.dim};margin-bottom:5px">ุงูุชูุฏู ูุญู: <b style="color:${getNextRank(u.points).color}">${getNextRank(u.points).name}</b></div>
    <div style="width:100%;height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(100,Math.round((u.points-getRank(u.points).min)/(getNextRank(u.points).min-getRank(u.points).min)*100))}%;background:${getNextRank(u.points).color};border-radius:3px;transition:width 0.5s"></div></div>
    <div style="font-size:11px;color:${C.dim};margin-top:3px">${u.points} / ${getNextRank(u.points).min} ููุทุฉ</div></div></div>`:''}`;
  const exOrder=['memory','sequence','schulte','stroop','math','raven','typing','shortcuts'];
  let nextIdx=exOrder.findIndex(id=>!u.todayEx[id]);
  if(nextIdx<0)nextIdx=exOrder.length;
  
  $('ct').innerHTML+= `<div class="card fi" id="exSel"><div style="font-family:'Readex Pro';font-size:18px;font-weight:600;margin-bottom:6px">๐ ุชูุงุฑูู ุงูููู</div>
    <div style="font-size:13px;color:${C.dim};margin-bottom:16px">${done}/8 ููุชูู โ ${done>=8?'๐ ุฃูููุช ุงููู!':'ุงุจุฏุฃ ุจุงูุชุฑุชูุจ ูู ุงููุณุงุฑ'}</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">${exOrder.map((id,i)=>{const ex=EXT.find(e=>e.id===id);const d=u.todayEx[id];const isNext=i===nextIdx;const locked=i>nextIdx&&!d;
    return`<div onclick="${d?'':(locked?'':`startEx('${id}')`)}" style="background:${d?'rgba(0,229,184,0.06)':isNext?'rgba(253,203,110,0.04)':'rgba(255,255,255,0.015)'};border:2px solid ${d?'rgba(0,229,184,0.3)':isNext?'rgba(253,203,110,0.3)':'rgba(255,255,255,0.05)'};border-radius:14px;padding:16px;text-align:center;cursor:${d?'default':(locked?'not-allowed':'pointer')};transition:all 0.3s;opacity:${locked?'0.4':'1'};position:relative">
      ${d?'<div style="position:absolute;top:6px;left:6px;font-size:16px">โ</div>':''}
      ${isNext&&!d?'<div style="position:absolute;top:6px;left:6px;font-size:10px;background:rgba(253,203,110,0.2);color:'+C.gld+';padding:2px 6px;border-radius:4px;font-weight:700">ุงูุชุงูู</div>':''}
      ${locked?'<div style="position:absolute;top:6px;left:6px;font-size:14px">๐</div>':''}
      <div style="font-size:28px;margin-bottom:6px">${ex.ic}</div><div style="font-weight:600;font-size:13px;margin-bottom:2px">${ex.n}</div><div style="font-size:10px;color:${C.dim}">${ex.d}</div>
      <div style="font-size:9px;margin-top:5px;padding:2px 7px;border-radius:4px;display:inline-block;${catC[ex.cat]}">${ex.cl}</div>
      <div style="margin-top:6px;font-size:11px;padding:3px 8px;border-radius:5px;display:inline-block;background:${d?'rgba(0,229,184,0.15)':'rgba(255,255,255,0.05)'};color:${d?C.ac:C.dim};font-weight:${d?'700':'400'}">${d?d.score+'%':'โ'}</div></div>`;}).join('')}</div></div>
  <div class="card fi" id="exAct" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-family:'Readex Pro';font-size:18px;font-weight:600" id="exT"></div><div style="padding:6px 14px;background:rgba(253,203,110,0.08);border:1px solid rgba(253,203,110,0.15);border-radius:8px;font-size:13px;color:${C.gld};font-weight:600" id="exTm">โฑ๏ธ 00:00</div></div>
    <div style="width:100%;height:5px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin:14px 0"><div id="exP" style="height:100%;background:linear-gradient(90deg,${C.ac},${C.ac2});border-radius:3px;transition:width 0.5s;width:0%"></div></div>
    <div id="exA" style="min-height:340px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px"></div></div>
  ${renderGoldenBanner()}`;
}

// ============ GOLDEN SESSION + WEEKEND TRAINING ============
function isWeekend(){const d=new Date().getDay();return d===5||d===6;} // Fri+Sat in SA
function isAfter7(){return new Date().getHours()>=19;}
function getWeeklyTop3(){
  const emps=getEmpList();const weekAgo=Date.now()-7*864e5;
  const scores=emps.map(e=>{
    const ud=gs('u_'+e.email);if(!ud)return{name:e.name,avg:0};
    const wk=ud.hist.filter(h=>new Date(h.date)>=new Date(weekAgo));
    const avg=wk.length?Math.round(wk.reduce((a,b)=>a+b.score,0)/wk.length):0;
    return{name:e.name,email:e.email,avg,count:wk.length};
  }).filter(s=>s.count>=5).sort((a,b)=>b.avg-a.avg);
  return scores.slice(0,3);
}
function isEligibleGolden(){
  const top3=getWeeklyTop3();
  return top3.some(t=>t.email===S.user.email);
}

function renderGoldenBanner(){
  const hr=new Date().getHours();
  const weekend=isWeekend();
  const after7=isAfter7();
  const eligible=isEligibleGolden();
  const todayDone=Object.keys(S.data.todayEx).length>=1;
  
  // Weekend training (for everyone, doesn't affect scores)
  if(weekend&&todayDone){
    const wkMins=S.data.weekendMins||0;
    return `<div class="card fi" style="margin-top:16px;background:linear-gradient(135deg,rgba(108,92,231,0.08),rgba(0,229,184,0.05));border:1px solid rgba(108,92,231,0.2)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <span style="font-size:28px">๐๏ธ</span>
        <div><div style="font-family:'Readex Pro';font-size:16px;font-weight:700">ุชุฏุฑูุจ ุงูููููุฏ</div>
        <div style="font-size:12px;color:${C.ac2}">ุชุฏุฑูุจ ุญุฑ โ ูุง ูุฃุซุฑ ุนูู ูุชุงุฆุฌู ูุชุฑุชูุจู</div></div>
      </div>
      <div style="font-size:13px;color:${C.dim};margin-bottom:12px;line-height:1.8">ุงุณุชุซูุฑ ููุชู ูุทููุฑ ููุณู. ุงูููุธู ุงููู ูุชุฏุฑุจ ุจุงูููููุฏ ุจุงุณุชูุฑุงุฑ ูููุงูุฃ ุจููุงูุขุช ุฎุงุฑุฌูุฉ ูููุฒุฉ ๐</div>
      <div style="font-size:12px;color:${C.ac2};margin-bottom:10px">โฑ๏ธ ุชุฏุฑุจุช ูุงูุดูุฑ: <b>${wkMins}</b> ุฏูููุฉ ูู ุงูููููุฏ</div>
      <button class="btn" onclick="startWeekendTraining()" style="max-width:220px;font-size:14px;padding:12px;background:linear-gradient(135deg,${C.ac2},#a29bfe)">๐๏ธ ุงุจุฏุฃ ุงูุชุฏุฑูุจ ุงูุญุฑ</button>
    </div>`;
  }
  
  // Golden session (after 7pm, top 3 only)
  if(after7&&eligible&&todayDone){
    return `<div class="card fi" style="margin-top:16px;background:linear-gradient(135deg,rgba(253,203,110,0.1),rgba(255,193,7,0.05));border:1px solid rgba(253,203,110,0.3)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <span style="font-size:28px">๐</span>
        <div><div style="font-family:'Readex Pro';font-size:16px;font-weight:700;color:${C.gld}">ุงูุฌูุณุฉ ุงูุฐูุจูุฉ</div>
        <div style="font-size:12px;color:${C.gld}">ููุงูุฃุฉ ูุฃูุถู ูฃ ุจุงููุฑูู ูุงูุฃุณุจูุน!</div></div>
      </div>
      <div style="font-size:13px;color:#E8ECF1;margin-bottom:12px;line-height:1.8">ุฃูุช ูู <b style="color:${C.gld}">ุฃูุถู ูฃ</b> ูุงูุฃุณุจูุน โ ุชุณุชุงูู! ูกูฅ ุฏูููุฉ ุชูุงุฑูู ูุชูุฏูุฉ ูุน ุชุญููุฒ ูุชุญุฏู. ุงูููุช ููุญุณุจ ูุจุฏู ุฎุงุฑุฌ ุฏูุงู โฐ</div>
      <button class="btn" onclick="startGoldenSession()" style="max-width:220px;font-size:14px;padding:12px;background:linear-gradient(135deg,${C.gld},#f39c12)">๐ ุงุจุฏุฃ ุงูุฌูุณุฉ ุงูุฐูุจูุฉ!</button>
    </div>`;
  }
  
  // Show locked golden session teaser (after 7pm but not eligible)
  if(after7&&!eligible&&todayDone){
    return `<div class="card fi" style="margin-top:16px;opacity:0.5">
      <div style="display:flex;align-items:center;gap:12px">
        <span style="font-size:28px">๐</span>
        <div><div style="font-family:'Readex Pro';font-size:15px;font-weight:600;color:${C.dim}">ุงูุฌูุณุฉ ุงูุฐูุจูุฉ โ ููููุฉ</div>
        <div style="font-size:12px;color:${C.dim}">ูุชุงุญุฉ ูุฃูุถู ูฃ ุจุงููุฑูู ูุงูุฃุณุจูุน</div></div>
      </div>
    </div>`;
  }
  
  return '';
}

function getGoldenQuote(){
  const q=G()==='f'?[
    'ุฃูุชู ูู ุงูููุฉ ุงููู ูุณุชุซูุฑูู ุจุฃููุณูู โ ุงุณุชูุฑู!',
    'ุงูุชูููุฒ ูุง ุฌุงู ุตุฏูุฉ โ ุฌุงู ูุฃูู ุชุณุชุงูููู',
    'ูู ุฏูููุฉ ุชุณุชุซูุฑูููุง ุจููุณู ุชุฑุฌุนูู ุฃุถุนุงู',
    'ุงููุฑู ุจูู ุงูุนุงุฏูุฉ ูุงูุงุณุชุซูุงุฆูุฉ = ุงูุฌูุฏ ุงูุฅุถุงูู',
    'ุฃูุชู ููุง ูุฃูู ูู ุฃูุถู ูฃ โ ูุฎุฑ ูููุฑูู!',
    'ุงูุชูุฑุงุฑ ุงููุชุนูุฏ ูุตูุน ุงููุญุชุฑููู',
    'ุงููุงุฌุญุฉ ูุง ุชุชุฏุฑุจ ููู ุชุตุญ โ ุชุชุฏุฑุจ ููู ูุง ุชุบูุท',
  ]:[
    'ุฃูุช ูู ุงูููุฉ ุงููู ูุณุชุซูุฑูู ุจุฃููุณูู โ ุงุณุชูุฑ!',
    'ุงูุชูููุฒ ูุง ุฌุงู ุตุฏูุฉ โ ุฌุงู ูุฃูู ุชุณุชุงูู',
    'ูู ุฏูููุฉ ุชุณุชุซูุฑูุง ุจููุณู ุชุฑุฌุนูู ุฃุถุนุงู',
    'ุงููุฑู ุจูู ุงูุนุงุฏู ูุงูุงุณุชุซูุงุฆู = ุงูุฌูุฏ ุงูุฅุถุงูู',
    'ุฃูุช ููุง ูุฃูู ูู ุฃูุถู ูฃ โ ูุฎุฑ ูููุฑูู!',
    'ุงูุชูุฑุงุฑ ุงููุชุนูุฏ ูุตูุน ุงููุญุชุฑููู',
    'ุงููุงุฌุญ ูุง ูุชุฏุฑุจ ููู ูุตุญ โ ูุชุฏุฑุจ ููู ูุง ูุบูุท',
  ];
  return q[Math.floor(Math.random()*q.length)];
}

window.startGoldenSession=function(){
  S.data.goldenStart=Date.now();
  S.data.goldenExDone=0;
  saveU(S.data);
  launchGoldenEx();
};

function launchGoldenEx(){
  const elapsed=Math.round((Date.now()-(S.data.goldenStart||Date.now()))/1000);
  const remaining=900-elapsed; // 15 mins = 900 seconds
  if(remaining<=0){finishGoldenSession();return;}
  
  // Pick random exercise
  const exTypes=['memory','sequence','schulte','stroop','math','raven'];
  const type=exTypes[Math.floor(Math.random()*exTypes.length)];
  const ex=EXT.find(e=>e.id===type);
  
  $('exSel').style.display='none';$('exAct').style.display='block';
  S.curEx=type;
  
  // Golden header with countdown + motivational quote
  const quote=getGoldenQuote();
  const mins=Math.floor(remaining/60);const secs=remaining%60;
  $('exT').innerHTML=`<span style="color:${C.gld}">๐</span> ${ex.ic} ${ex.n}`;
  $('exTm').innerHTML=`โฑ๏ธ ูุชุจูู: ${mins}:${String(secs).padStart(2,'0')}`;
  $('exTm').style.background='rgba(253,203,110,0.12)';$('exTm').style.borderColor='rgba(253,203,110,0.3)';
  
  // Show quote before exercise
  $('exA').innerHTML=`<div style="text-align:center;padding:20px">
    <div style="font-size:40px;margin-bottom:12px">๐</div>
    <div style="font-size:16px;color:${C.gld};font-weight:600;line-height:2;max-width:400px;margin:0 auto">"${quote}"</div>
    <div style="font-size:13px;color:${C.dim};margin-top:12px">ุงูุชูุฑูู ${(S.data.goldenExDone||0)+1} โ ูุชุจูู ${mins} ุฏูููุฉ</div>
    <button class="btn" onclick="launchGoldenExNow('${type}')" style="max-width:200px;margin:18px auto 0;background:linear-gradient(135deg,${C.gld},#f39c12);font-size:16px;padding:14px">๐ช ููุง!</button>
  </div>`;
  
  // Update countdown
  clearInterval(S.goldenTimer);
  S.goldenTimer=setInterval(()=>{
    const el=Math.round((Date.now()-(S.data.goldenStart||Date.now()))/1000);
    const rem=900-el;
    if(rem<=0){clearInterval(S.goldenTimer);finishGoldenSession();return;}
    const m=Math.floor(rem/60);const s=rem%60;
    if($('exTm'))$('exTm').innerHTML=`โฑ๏ธ ูุชุจูู: ${m}:${String(s).padStart(2,'0')}`;
  },1000);
};

window.launchGoldenExNow=function(type){
  EX={start:Date.now(),correct:0,total:0,step:0};
  S.goldenMode=true;
  let sec=0;clearInterval(S.timer);
  S.timer=setInterval(()=>{sec++;},1000);
  if(type==='memory')exMemory();else if(type==='sequence')exSequence();else if(type==='schulte')exSchulte();
  else if(type==='stroop')exStroop();else if(type==='math')exMathS();else if(type==='raven')exRaven();
};

// Override finishEx to handle golden mode
const _origFinishEx=finishEx;

function finishGoldenSession(){
  clearInterval(S.goldenTimer);clearInterval(S.timer);
  S.goldenMode=false;
  const totalMins=Math.round((Date.now()-(S.data.goldenStart||Date.now()))/60000);
  const exDone=S.data.goldenExDone||0;
  
  // Save golden session record
  if(!S.data.goldenHist)S.data.goldenHist=[];
  S.data.goldenHist.push({date:new Date().toISOString(),mins:totalMins,exercises:exDone});
  saveU(S.data);
  
  $('exAct').style.display='block';$('exSel').style.display='none';
  $('exT').innerHTML=`<span style="color:${C.gld}">๐</span> ุงูุฌูุณุฉ ุงูุฐูุจูุฉ`;
  $('exTm').innerHTML='ุงูุชูุช!';
  $('exA').innerHTML=`<div style="text-align:center;padding:20px">
    <div style="font-size:50px;margin-bottom:8px">๐</div>
    <div style="font-family:'Readex Pro';font-size:22px;font-weight:800;color:${C.gld};margin-bottom:8px">ุฃุญุณูุช! ุฌูุณุฉ ุฐูุจูุฉ ููุชููุฉ</div>
    <div style="display:flex;gap:16px;justify-content:center;margin:14px 0;font-size:14px">
      <span>โฑ๏ธ ${totalMins} ุฏูููุฉ</span>
      <span>๐ ${exDone} ุชูุฑูู</span>
    </div>
    <div style="padding:14px;background:rgba(253,203,110,0.08);border:1px solid rgba(253,203,110,0.15);border-radius:12px;margin:14px 0;font-size:14px;color:${C.gld};line-height:1.8">
      โฐ ูุงูููุช ูุญุณูุจ ูุจุฏู ุฎุงุฑุฌ ุฏูุงู<br>ุดูุฑุงู ุนูู ุงุณุชุซูุงุฑู ุจููุณู!
    </div>
    <button class="btn" onclick="rExercises()" style="max-width:200px;margin:14px auto;font-size:15px;padding:13px">โ ุงูุนูุฏุฉ</button>
  </div>`;
}

// Weekend training (doesn't affect scores)
window.startWeekendTraining=function(){
  const exTypes=['memory','sequence','schulte','stroop','math','raven'];
  const type=exTypes[Math.floor(Math.random()*exTypes.length)];
  const ex=EXT.find(e=>e.id===type);
  S.curEx=type;S.weekendMode=true;
  $('exSel').style.display='none';$('exAct').style.display='block';
  $('exT').innerHTML=`<span>๐๏ธ</span> ${ex.ic} ${ex.n} <span style="font-size:11px;color:${C.ac2}">(ุชุฏุฑูุจ)</span>`;
  EX={start:Date.now(),correct:0,total:0,step:0};
  let sec=0;clearInterval(S.timer);
  S.timer=setInterval(()=>{sec++;$('exTm').textContent='โฑ๏ธ '+String(Math.floor(sec/60)).padStart(2,'0')+':'+String(sec%60).padStart(2,'0');},1000);
  if(type==='memory')exMemory();else if(type==='sequence')exSequence();else if(type==='schulte')exSchulte();
  else if(type==='stroop')exStroop();else if(type==='math')exMathS();else if(type==='raven')exRaven();
};

// ============ EXERCISE INTROS (Dialect-aware) ============
function getDlIntro(type){
  const dl=S.data?.dialect||'sa';
  const g=G?G():'m';
  const base={
  memory:{
    title:'๐งฉ ุชุทุงุจู ุงูุฐุงูุฑุฉ',
    what:{
      sa:g==='f'?'ุจุชุธูุฑ ูู ุจุทุงูุงุช ููููุจุฉุ ูู ูุฑุฉ ุชููุจูู ุจุทุงูุชูู ูุชุฏูุฑูู ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.':'ุจุชุธูุฑ ูู ุจุทุงูุงุช ููููุจุฉุ ูู ูุฑุฉ ุชููุจ ุจุทุงูุชูู ูุชุฏูุฑ ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.',
      eg:g==='f'?'ุญุชุธูุฑูู ูุฑูุช ููููุจุฉุ ูู ูุฑุฉ ุจุชููุจู ุงุชููู ูุชุฏูุฑู ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.':'ุญุชุธูุฑูู ูุฑูุช ููููุจุฉุ ูู ูุฑุฉ ุจุชููุจ ุงุชููู ูุชุฏูุฑ ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.',
      sd:g==='f'?'ุจุชุธูุฑ ููู ุจุทุงูุงุช ููููุจุฉุ ูู ูุฑุฉ ุจุชููุจู ุจุทุงูุชูู ูุจุชุฏูุฑู ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.':'ุจุชุธูุฑ ููู ุจุทุงูุงุช ููููุจุฉุ ูู ูุฑุฉ ุจุชููุจ ุจุทุงูุชูู ูุจุชุฏูุฑ ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.',
    },
    goal:'ุชูููุฉ ุงูุฐุงูุฑุฉ ุงูุจุตุฑูุฉ ูุตูุฑุฉ ุงููุฏู.',
    benefit:{
      sa:'ูู ุดุบูู: ุชุชุฐูุฑ ุฃุฑูุงู ูุฃุณูุงุก ูุชูุงุตูู ุจุฏูู ูุง ุชูุณู.',
      eg:'ูู ุดุบูู: ุญุชูุชูุฑ ุฃุฑูุงู ูุฃุณุงูู ูุชูุงุตูู ูู ุบูุฑ ูุง ุชูุณู.',
      sd:'ูู ุดุบูู: ุจุชุชุฐูุฑ ุฃุฑูุงู ูุฃุณุงูู ูุชูุงุตูู ูู ุบูุฑ ูุง ุชูุณู.',
    },
    tips:{
      sa:[g==='f'?'ุฑููุฒู ุนูู ููุงู ูู ุจุทุงูุฉ':'ุฑููุฒ ุนูู ููุงู ูู ุจุทุงูุฉ','ูุง ุชูุฏุฑ ุชุฑุฌุน โ ูู ุถุบุทุฉ ูุญุณูุจุฉ'],
      eg:[g==='f'?'ุฑูุฒู ุนูู ููุงู ูู ูุงุฑุช':'ุฑูุฒ ุนูู ููุงู ูู ูุงุฑุช','ูููุด ุฑุฌูุน โ ูู ุถุบุทุฉ ูุญุณูุจุฉ'],
      sd:[g==='f'?'ุฑูุฒู ุนูู ููุงู ูู ุจุทุงูุฉ':'ุฑูุฒ ุนูู ููุงู ูู ุจุทุงูุฉ','ูุง ูู ุฑุฌูุน โ ูู ุถุบุทุฉ ูุญุณูุจุฉ'],
    }
  },
  schulte:{
    title:'๐ฏ ุฌุฏูู ุดููุชู',
    what:{
      sa:g==='f'?'ุฌุฏูู ููู ุฃุฑูุงู ูุจุนุซุฑุฉ. ุงุถุบุทู ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.':'ุฌุฏูู ููู ุฃุฑูุงู ูุจุนุซุฑุฉ. ุงุถุบุท ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.',
      eg:g==='f'?'ุฌุฏูู ููู ุฃุฑูุงู ูุชุจุนุชุฑุฉ. ุฏูุณู ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.':'ุฌุฏูู ููู ุฃุฑูุงู ูุชุจุนุชุฑุฉ. ุฏูุณ ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.',
      sd:g==='f'?'ุฌุฏูู ูููู ุฃุฑูุงู ูุจุนุซุฑุฉ. ุงุถุบุทู ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.':'ุฌุฏูู ูููู ุฃุฑูุงู ูุจุนุซุฑุฉ. ุงุถุบุท ุนูููุง ุจุงูุชุฑุชูุจ ุจุฃุณุฑุน ููุช.',
    },
    goal:'ุชูููุฉ ุงูุชุฑููุฒ ุงูุจุตุฑู ูุงูุงูุชุจุงู.',
    benefit:{
      sa:'ูู ุดุบูู: ุณุฑุนุฉ ูุฑุงุกุฉ ุงูุจูุงูุงุช ูุงูุฌุฏุงูู.',
      eg:'ูู ุดุบูู: ุณุฑุนุฉ ูุฑุงูุฉ ุงูุฏุงุชุง ูุงูุฌุฏุงูู.',
      sd:'ูู ุดุบูู: ุณุฑุนุฉ ูุฑุงุกุฉ ุงูุจูุงูุงุช ูุงูุฌุฏุงูู.',
    },
    tips:{
      sa:[g==='f'?'ุซุจูุชู ูุธุฑู ูู ูุณุท ุงูุฌุฏูู':'ุซุจูุช ูุธุฑู ูู ูุณุท ุงูุฌุฏูู','ุงูุณุฑุนุฉ ุชุฌู ูุน ุงูุชูุฑุงุฑ'],
      eg:[g==='f'?'ุซุจูุชู ูุธุฑู ูู ูุต ุงูุฌุฏูู':'ุซุจูุช ูุธุฑู ูู ูุต ุงูุฌุฏูู','ุงูุณุฑุนุฉ ุจุชูุฌู ูุน ุงูุชูุฑุงุฑ'],
      sd:[g==='f'?'ุซุจูุชู ูุธุฑู ูู ูุต ุงูุฌุฏูู':'ุซุจูุช ูุธุฑู ูู ูุต ุงูุฌุฏูู','ุงูุณุฑุนุฉ ุจุชุฌู ูุน ุงูุชูุฑุงุฑ'],
    }
  }};
  
  const ex=base[type];
  if(!ex)return EX_INTRO_FALLBACK[type]||{};
  const d=dl==='ar'?'sa':dl; // fallback
  return{
    title:ex.title,
    what:ex.what[d]||ex.what.sa,
    goal:ex.goal,
    benefit:ex.benefit[d]||ex.benefit.sa,
    tips:ex.tips[d]||ex.tips.sa
  };
}

const EX_INTRO_FALLBACK={
  memory:{
    title:'๐งฉ ุชุทุงุจู ุงูุฐุงูุฑุฉ',
    what:'ุจุชุธูุฑ ูู ุจุทุงูุงุช ููููุจุฉุ ูู ูุฑุฉ ุชููุจ ุจุทุงูุชูู ูุชุฏูุฑ ุนูู ุงูุฃุฒูุงุฌ ุงููุชุดุงุจูุฉ.',
    goal:'ุชูููุฉ ุงูุฐุงูุฑุฉ ุงูุจุตุฑูุฉ ูุตูุฑุฉ ุงููุฏู โ ุชุณุงุนุฏู ุชุชุฐูุฑ ุงูุฃุดูุงุก ุจุณุฑุนุฉ.',
    benefit:'ูู ุดุบูู: ุชุฐูุฑ ุฃุฑูุงูุ ุฃุณูุงุกุ ุชูุงุตูู ุจุฏูู ูุง ุชูุณู.',
    tips:['ุชุจุฏุฃ ุจู ูจ ุฃุฒูุงุฌ ูุชุฒูุฏ ูุน ุชุทูุฑู','ุฑููุฒ ุนูู ููุงู ูู ุจุทุงูุฉ','ูุง ุชูุฏุฑ ุชุฑุฌุน โ ูู ุถุบุทุฉ ูุญุณูุจุฉ']
  },
  sequence:{
    title:'๐ข ุชุณูุณู ุงูุฃุฑูุงู',
    what:'ุจุชุธูุฑ ูู ุฃุฑูุงู ููุฏุฉ ูฅ ุซูุงููุ ุจุนุฏูุง ูุงุฒู ุชุนูุฏ ูุชุงุจุชูุง ุจููุณ ุงูุชุฑุชูุจ.',
    goal:'ุชูููุฉ ุงูุฐุงูุฑุฉ ุงูุนุงููุฉ โ ุงููุฏุฑุฉ ุนูู ุญูุธ ูุนูููุงุช ูุคูุชุฉ ูุงุณุชุฎุฏุงููุง.',
    benefit:'ูู ุดุบูู: ุชุชุฐูุฑ ุฃุฑูุงู ุชูููููุงุชุ ูุจุงูุบุ ุฃููุงุฏ ุจุฏูู ูุง ุชูุชุจูุง.',
    tips:['ุชุจุฏุฃ ุจู ูจ ุฃุฑูุงู โ ุงูููุช ูููุต ูู ูุง ุชุทูุฑุช!','ุญุงูู ุชูุณู ุงูุฃุฑูุงู ููุฌููุนุงุช','ูุง ุชูุฏุฑ ุชุดูููุง ูุฑุฉ ุซุงููุฉ!']
  },
  schulte:{
    title:'๐ฏ ุฌุฏูู ุดููุชู',
    what:'ุฌุฏูู ููู ุฃุฑูุงู ูู ูก ุฅูู ูขูฅ ูุจุนุซุฑุฉ. ุงุถุบุท ุนูููุง ุจุงูุชุฑุชูุจ ูู ูก ุฅูู ูขูฅ ุจุฃุณุฑุน ููุช.',
    goal:'ุชูููุฉ ุงูุชุฑููุฒ ุงูุจุตุฑู ูุงูุงูุชุจุงู โ ุชุฏุฑูุจ ุนููู ูุฏูุงุบู ูุดุชุบููู ูุน ุจุนุถ.',
    benefit:'ูู ุดุบูู: ุณุฑุนุฉ ูุฑุงุกุฉ ุงูุจูุงูุงุช ูุงูุฌุฏุงูู ูุงูุฃุฑูุงู.',
    tips:['ุญุงูู ุชุซุจุช ูุธุฑู ูู ูุณุท ุงูุฌุฏูู','ูุง ุชุจุญุซ ุฑูู ุฑูู โ ุฎูู ุนููู ุชููุทู','ุงูุณุฑุนุฉ ุชุฌู ูุน ุงูุชูุฑุงุฑ']
  },
  stroop:{
    title:'๐ ุงุฎุชุจุงุฑ ุณุชุฑูุจ',
    what:'ุจุชุธูุฑ ูู ูููุฉ ููู ููุชูุจุฉ ุจููู ูุฎุชูู. ูุฑุฉ ุงููุทููุจ ููู ุงูุฎุท ููุฑุฉ ุงููููุฉ ุงูููุชูุจุฉ โ ุงูุชุจู ููุณุคุงู!',
    goal:'ุชูููุฉ ููุงููุฉ ุงูุชุดุชุช โ ูุฏุฑุชู ุชุฑูุฒ ุนูู ุงูููู ูุชุชุฌุงูู ุงููุดุชุชุงุช.',
    benefit:'ูู ุดุบูู: ูุง ุชุชุดุชุช ุจุณูููุฉุ ุชุฑููุฒู ูููู ุนูู ุงูุฃูู.',
    tips:['โ๏ธ ุงูุณุคุงู ูุชุบูุฑ! ูุฑุฉ ููู ุงูุฎุท ููุฑุฉ ุงููููุฉ','๐จ = ููู ุงูุฎุท | ๐ = ุงููููุฉ ุงูููุชูุจุฉ','ูุงูุชูุฑูู ุตุนุจ ูู ุงูุจุฏุงูุฉ ููุฐุง ุทุจูุนู']
  },
  math:{
    title:'โ ุญุณุงุจ ุฐููู',
    what:'ุนูููุงุช ุญุณุงุจูุฉ ุณุฑูุนุฉ (ุฌูุนุ ุทุฑุญุ ุถุฑุจ). ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู ูค ุฎูุงุฑุงุช.',
    goal:'ุชุณุฑูุน ุงููุนุงูุฌุฉ ุงูุฐูููุฉ โ ุฏูุงุบู ูุญุณุจ ุฃุณุฑุน.',
    benefit:'ูู ุดุบูู: ุณุฑุนุฉ ูู ุงูุญุณุงุจุงุช ูุงูุชูุฏูุฑุงุช ุจุฏูู ุขูุฉ ุญุงุณุจุฉ.',
    tips:['ุญุงูู ุชุญุณุจ ูู ุฑุงุณู ูุจู ูุง ุชุดูู ุงูุฎูุงุฑุงุช','ุงูุตุนูุจุฉ ุชุฒูุฏ ูุน ูุณุชูุงู','ูกู ุฃุณุฆูุฉ ุจุณ โ ุฑููุฒ ูููุง']
  },
  raven:{
    title:'๐ท ุฃููุงุท ุฑููู ุงููุชูุฏูุฉ',
    what:'ูุตูููุฉ ูฃรูฃ ูููุง ุฃุดูุงู ุชุชุจุน ุฃููุงุท ููุทููุฉ. ุฎุงูุฉ ูุงุญุฏุฉ ูุงุถูุฉ โ ุงูุชุดู ุงููุงุนุฏุฉ ูุงุฎุชุฑ ุงูุดูู ุงูุตุญูุญ.',
    goal:'ุชูููุฉ ุงูุชูููุฑ ุงูููุทูู ูุงูุชุญูููู โ ุงุฎุชุจุงุฑ ุฐูุงุก ุนุงููู ููุณุชุฎุฏู ููุจุงูุบูู.',
    benefit:'ูู ุดุบูู: ุญู ุงููุดุงูู ุงููุนูุฏุฉ ูุชุญููู ุงูุจูุงูุงุช ูุงุชุฎุงุฐ ูุฑุงุฑุงุช ุฃุฐูู.',
    tips:['ุงุฏุฑุณ ุงูุตููู ูุงูุฃุนูุฏุฉ โ ูุด ุงููุงุนุฏุฉุ','ุงูุฃููุงุท ุชุดูู: ุนุฏุฏุ ุญุฌูุ ุฏูุฑุงูุ ุชูุฒูุนุ ุฌูุน/ุทุฑุญ','ุงูุตุนูุจุฉ ุชุฒูุฏ ูุน ุชุทูุฑู โ ุฎุฐ ููุชู ููููุฑ']
  },
  typing:{
    title:'โจ๏ธ ุชุนููู ุงููุชุงุจุฉ ุนูู ุงูููุจูุฑุฏ',
    what:'ูููุฌ ูุชุฏุฑุฌ ุญุฑู ุจุญุฑู โ ุชุจุฏุฃ ุจุญุฑููู ูุชุถูู ุฃุญุฑู ุฌุฏูุฏุฉ ูู ุฏุฑุณ ูุญุฏ ูุง ุชุชูู ุงูููุจูุฑุฏ ูุงูู.',
    goal:'ุชุนููู ุงููุชุงุจุฉ ุงูุตุญูุญุฉ ุจุฏูู ุงููุธุฑ ููููุจูุฑุฏ (Touch Typing) ุจุงูุนุฑุจู ูุงูุฅูุฌููุฒู.',
    benefit:'ูู ุดุบูู: ุชุฑุฏ ุนูู ุงูุฅููููุงุช ูุงูุฑุณุงุฆู ุจุณุฑุนุฉ ูุจุฏูู ุฃุฎุทุงุก โ ุชููุฑ ุณุงุนุงุช ูู ุฃุณุจูุน.',
    tips:['ูกู ุฏุฑูุณ ูุชุฏุฑุฌุฉ โ ูุงุฒู ุชุฌุชุงุฒ ูงู% ุนุดุงู ุชูุชูู ููุชุงูู','โ๏ธ ูุง ุชูุธุฑ ููููุจูุฑุฏ ุฃุจุฏุงู โ ุฃุจูู ุนูููู ุนูู ุงูุดุงุดุฉ','ุงูุญุฑู ุงูุชุงูู ูุธูุฑ ูู ุนูู ุงูุดุงุดุฉ โ ุซู ุจุฃุตุงุจุนู']
  },
  shortcuts:{
    title:'๐น ุงุฎุชุตุงุฑุงุช ุงูููุจูุฑุฏ',
    what:'ูุธูุฑ ูู ูุตู ุนูููุฉ ูููู ุชูุณุชุฎุฏู (ูููุฏูุฒ/Excel/ุงููุชุตูุญ). ุงุถุบุท ุงูุงุฎุชุตุงุฑ ุงูุตุญูุญ ุนูู ุงูููุจูุฑุฏ ูุจุงุดุฑุฉ!',
    goal:'ุญูุธ ุงุฎุชุตุงุฑุงุช ูููุฏูุฒ + Excel + ุงููุชุตูุญ ุนู ุทุฑูู ุงูุชุทุจูู ุงูุนููู.',
    benefit:'ูู ุดุบูู: ุชููุฑ ููุช ูุจูุฑ ูู ููู โ ุจุฏู ุงููุงูุณุ ุงุฎุชุตุงุฑ ูุฎูุงุต.',
    tips:['ุงูุฅุฌุงุจุฉ ุจุงูุถุบุท ุนูู ุงูููุจูุฑุฏ ูุจุงุดุฑุฉ โ ูู ุงุฎุชูุงุฑุงุช!','ุงูุชุจู ูููุงู ุงูุงุณุชุฎุฏุงู (ูููุฏูุฒ/Excel/ูุชุตูุญ)','ูู ุบูุทุช ุจููุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ โ ุชุนููู ูููุง']
  }
};

window.startEx=function(type){
  S.curEx=type;
  const info=getDlIntro(type)||EX_INTRO_FALLBACK[type];
  if(!info||!info.what){launchEx(type);return;}
  $('exSel').style.display='none';$('exAct').style.display='block';
  $('exT').textContent=info.title;
  $('exA').innerHTML=`<div style="text-align:right;width:100%;max-width:550px;padding:10px">
    <div style="font-size:17px;line-height:2;margin-bottom:16px">
      <div style="font-weight:700;color:${C.ac};font-size:15px;margin-bottom:6px">๐ ูุด ุงูุชูุฑููุ</div>
      <div style="font-size:16px">${info.what}</div>
    </div>
    <div style="font-size:17px;line-height:2;margin-bottom:16px">
      <div style="font-weight:700;color:${C.ac2};font-size:15px;margin-bottom:6px">๐ฏ ูุด ุงููุฏูุ</div>
      <div style="font-size:16px">${info.goal}</div>
    </div>
    <div style="font-size:17px;line-height:2;margin-bottom:16px">
      <div style="font-weight:700;color:${C.gld};font-size:15px;margin-bottom:6px">๐ผ ูุด ุงููุงุฆุฏุฉ ูู ุดุบููุ</div>
      <div style="font-size:16px">${info.benefit}</div>
    </div>
    <div style="background:rgba(255,118,117,0.06);border:1px solid rgba(255,118,117,0.15);border-radius:12px;padding:16px;margin-bottom:18px">
      <div style="font-weight:700;color:${C.dng};font-size:15px;margin-bottom:8px">โ๏ธ ุงูุชุจู ูุจู ูุง ุชุจุฏุฃ:</div>
      ${info.tips.map(t=>`<div style="font-size:15px;padding:4px 0;color:#E8ECF1">โข ${t}</div>`).join('')}
    </div>
    <button class="btn" onclick="launchEx('${type}')" style="font-size:18px;padding:16px">๐ช ุฌุงูุฒ โ ุงุจุฏุฃ ุงูุชูุฑูู!</button>
    <div onclick="rExercises()" style="text-align:center;margin-top:10px;font-size:14px;color:${C.dim};cursor:pointer">โ ุฑุฌูุน ูููุงุฆูุฉ</div>
  </div>`;
};

function launchEx(type){
  EX._rng=null; // Reset RNG for fresh seed per exercise
  const ex=EXT.find(e=>e.id===type);
  $('exT').textContent=ex.ic+' '+ex.n;
  EX={start:Date.now(),correct:0,total:0,step:0};
  let sec=0;clearInterval(S.timer);
  S.timer=setInterval(()=>{sec++;$('exTm').textContent='โฑ๏ธ '+String(Math.floor(sec/60)).padStart(2,'0')+':'+String(sec%60).padStart(2,'0');},1000);
  if(type==='memory')exMemory();else if(type==='sequence')exSequence();else if(type==='schulte')exSchulte();
  else if(type==='stroop')exStroop();else if(type==='math')exMathS();else if(type==='raven')exRaven();
  else if(type==='typing')exTyping();else if(type==='shortcuts')exShortcuts();
}

function finishEx(){
  clearInterval(S.timer);const dur=Math.round((Date.now()-EX.start)/1000);
  const score=EX.total>0?Math.round((EX.correct/EX.total)*100):0;
  
  // Golden mode: don't save to todayEx, just count and continue
  if(S.goldenMode){
    S.data.goldenExDone=(S.data.goldenExDone||0)+1;
    // Save to hist but marked as golden
    S.data.hist.push({type:S.curEx,score,duration:dur,correct:EX.correct,total:EX.total,date:new Date().toISOString(),golden:true});
    saveU(S.data);
    $('exP').style.width=score+'%';
    $('exA').innerHTML=`<div style="text-align:center;padding:20px">
      <div style="font-size:16px;color:${C.gld}">๐ ุงูุชูุฑูู ${S.data.goldenExDone}</div>
      <div style="font-family:'Readex Pro';font-size:60px;font-weight:800;color:${C.gld};margin:8px 0">${score}%</div>
      <p style="color:${C.dim};font-size:14px">โ ${EX.correct}/${EX.total} | โฑ๏ธ ${dur} ุซุงููุฉ</p>
      ${score>=80?`<p style="color:${C.gld};font-size:16px;font-weight:600;margin-top:8px">๐ฅ ุฃุฏุงุก ุฐูุจู!</p>`:`<p style="color:${C.ac};font-size:16px;font-weight:600;margin-top:8px">๐ ุงุณุชูุฑ!</p>`}
      <button class="btn" onclick="launchGoldenEx()" style="max-width:200px;margin:16px auto;background:linear-gradient(135deg,${C.gld},#f39c12);font-size:15px;padding:13px">ุงูุชูุฑูู ุงูุชุงูู ๐</button>
    </div>`;
    return;
  }
  
  // Weekend mode: save to hist but marked, don't count in todayEx
  if(S.weekendMode){
    S.data.hist.push({type:S.curEx,score,duration:dur,correct:EX.correct,total:EX.total,date:new Date().toISOString(),weekend:true});
    S.data.weekendMins=(S.data.weekendMins||0)+Math.round(dur/60);
    saveU(S.data);S.weekendMode=false;
    $('exP').style.width=score+'%';
    $('exA').innerHTML=`<div style="text-align:center;padding:20px">
      <div style="font-size:16px;color:${C.ac2}">๐๏ธ ุชุฏุฑูุจ ุงูููููุฏ</div>
      <div style="font-family:'Readex Pro';font-size:60px;font-weight:800;background:linear-gradient(135deg,${C.ac2},#a29bfe);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:8px 0">${score}%</div>
      <p style="color:${C.dim};font-size:14px">โ ${EX.correct}/${EX.total} | โฑ๏ธ ${dur} ุซุงููุฉ</p>
      <div style="padding:10px;background:rgba(108,92,231,0.06);border-radius:8px;margin-top:10px;font-size:13px;color:${C.ac2}">ูุงููุชูุฌุฉ ููุชุฏุฑูุจ ููุท โ ูุง ุชุฃุซุฑ ุนูู ุชุฑุชูุจู</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button class="btn" onclick="startWeekendTraining()" style="max-width:180px;font-size:14px;padding:12px;background:linear-gradient(135deg,${C.ac2},#a29bfe)">๐๏ธ ุชูุฑูู ุซุงูู</button>
        <button onclick="rExercises()" style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid ${C.gb};border-radius:10px;color:${C.dim};font-family:'Tajawal';font-size:14px;cursor:pointer">โ ุงูุนูุฏุฉ</button>
      </div>
    </div>`;
    return;
  }
  
  // Normal mode
  S.data.todayEx[S.curEx]={type:S.curEx,score,duration:dur,correct:EX.correct,total:EX.total,date:new Date().toISOString()};
  S.data.hist.push(S.data.todayEx[S.curEx]);saveU(S.data);
  
  // Find next undone exercise in sequence
  const exOrder=['memory','sequence','schulte','stroop','math','raven','typing','shortcuts'];
  const curIdx=exOrder.indexOf(S.curEx);
  let nextEx=null;
  for(let i=curIdx+1;i<exOrder.length;i++){
    if(!S.data.todayEx[exOrder[i]]){nextEx=exOrder[i];break;}
  }
  const doneCnt=Object.keys(S.data.todayEx).length;
  const totalEx=8;
  const overallPct=Math.round((doneCnt/totalEx)*100);
  
  $('exP').style.width=(score)+'%';
  $('exA').innerHTML=`<div style="text-align:center;padding:24px"><div style="font-size:16px;color:${C.dim}">ูุชูุฌุฉ ุงูุชูุฑูู</div><div style="font-family:'Readex Pro';font-size:64px;font-weight:800;background:linear-gradient(135deg,${C.ac},${C.ac2});-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:8px 0">${score}%</div>
    <p style="color:${C.dim};font-size:15px">โ ${EX.correct}/${EX.total} ุฅุฌุงุจุฉ ุตุญูุญุฉ | โฑ๏ธ ${dur} ุซุงููุฉ</p>
    ${score>=80?`<p style="color:${C.ac};margin-top:10px;font-size:17px;font-weight:600">๐ ููุชุงุฒ! ุฃุฏุงุก ุฑุงุฆุน</p>`:score>=50?`<p style="color:${C.gld};margin-top:10px;font-size:17px;font-weight:600">๐ ุฌูุฏ! ูููู ูุจุชุชุญุณู</p>`:`<p style="color:${C.dng};margin-top:10px;font-size:17px;font-weight:600">๐ช ูุง ุชููู โ ุงูุชูุฑุงุฑ ูุตูุน ุงููุฑู</p>`}
    <div style="margin-top:14px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid ${C.gb};border-radius:10px">
      <div style="font-size:13px;color:${C.dim};margin-bottom:6px">ุฅูุฌุงุฒ ุงูููู: ${doneCnt}/${totalEx} ุชูุงุฑูู</div>
      <div style="width:100%;height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden"><div style="height:100%;width:${overallPct}%;background:linear-gradient(90deg,${C.ac},${C.ac2});border-radius:3px;transition:width 0.5s"></div></div>
    </div>
    ${nextEx?`<button class="btn" onclick="startEx('${nextEx}')" style="max-width:280px;margin:18px auto 0;display:block;font-size:16px;padding:14px">ุงูุชูุฑูู ุงูุชุงูู: ${EXT.find(e=>e.id===nextEx).ic} ${EXT.find(e=>e.id===nextEx).n} โ</button>`:`<button class="btn" onclick="rExercises()" style="max-width:220px;margin:18px auto 0;display:block;font-size:16px;padding:14px">๐ ุฃูููุช ูู ุงูุชูุงุฑูู!</button>`}
    <div onclick="rExercises()" style="text-align:center;margin-top:10px;font-size:13px;color:${C.dim};cursor:pointer">โ ุงูุนูุฏุฉ ููุงุฆูุฉ ุงูุชูุงุฑูู</div></div>`;
}

// ============ ADAPTIVE DIFFICULTY ============
// Per-skill level based on recent performance (last 5 attempts)
function getSkillLv(type){
  const h=S.data.hist.filter(x=>x.type===type).slice(-5);
  if(h.length===0)return 2; // Start at level 2 (not 1 = children)
  const avg=Math.round(h.reduce((a,b)=>a+b.score,0)/h.length);
  if(avg>=85&&h.length>=4)return 5;
  if(avg>=70&&h.length>=3)return 4;
  if(avg>=55&&h.length>=2)return 3;
  if(avg>=40)return 2;
  return 2; // Never go below 2
}

// --- Memory --- (Start at 8 pairs, grow to 12)
function exMemory(){const em=['๐','๐','๐ฅ','๐','๐ฆ','๐ธ','๐ต','โก','๐','๐ฏ','๐','๐'];const lv=getSkillLv('memory');const p=[8,9,10,11,12][lv-1];const cols=p<=8?4:p<=10?5:6;const cards=empShuf([...em.slice(0,p),...em.slice(0,p)]);EX.total=p;EX.cards=cards;EX.fl=[];EX.mt=new Set();
  $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:6px">ุงุจุญุซ ุนู ุงูุฃุฒูุงุฌ ุงููุชุทุงุจูุฉ</div><div style="font-size:13px;color:${C.ac2};text-align:center;margin-bottom:12px">ุงููุณุชูู ${lv} โ ${p} ุฃุฒูุงุฌ</div><div style="display:grid;grid-template-columns:repeat(${cols},62px);gap:6px;direction:ltr">${cards.map((_,i)=>`<div class="mc" onclick="mF(${i})" style="width:62px;height:62px;background:rgba(255,255,255,0.04);border:2px solid rgba(255,255,255,0.08);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:all 0.3s">โ</div>`).join('')}</div>`;}
window.mF=function(i){if(EX.fl.length>=2||EX.mt.has(i)||EX.fl.includes(i))return;const c=document.querySelectorAll('.mc');c[i].textContent=EX.cards[i];c[i].style.background='rgba(0,229,184,0.1)';c[i].style.borderColor=C.ac;EX.fl.push(i);
  if(EX.fl.length===2){const[a,b]=EX.fl;if(EX.cards[a]===EX.cards[b]){EX.mt.add(a);EX.mt.add(b);EX.correct++;c[a].style.background='rgba(0,229,184,0.2)';c[b].style.background='rgba(0,229,184,0.2)';EX.fl=[];$('exP').style.width=(EX.correct/EX.total*100)+'%';if(EX.correct===EX.total)setTimeout(finishEx,400);}
    else setTimeout(()=>{c[a].textContent='โ';c[b].textContent='โ';[a,b].forEach(x=>{c[x].style.background='rgba(255,255,255,0.04)';c[x].style.borderColor='rgba(255,255,255,0.08)';});EX.fl=[];},700);}};

// --- Sequence --- (Start 8 digits/5s, grow digits, shrink time to 3s)
function exSequence(){const lv=getSkillLv('sequence');const len=[8,9,10,11,12][lv-1];const showMs=[5000,4500,4000,3500,3000][lv-1];const seq=Array.from({length:len},()=>Math.floor(empRand()*9)+1);EX.total=1;EX.seq=seq;
  const showSec=(showMs/1000).toFixed(1);
  $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:6px">ุงุญูุธ ุงูุชุณูุณู</div><div style="font-size:13px;color:${C.ac2};text-align:center;margin-bottom:12px">ุงููุณุชูู ${lv} โ ${len} ุฃุฑูุงู ูู ${showSec} ุซุงููุฉ</div><div style="font-family:'Readex Pro';font-size:32px;letter-spacing:10px;text-align:center;direction:ltr">${seq.join('  ')}</div><div style="width:100%;height:4px;background:rgba(255,255,255,0.05);border-radius:2px;margin-top:14px;overflow:hidden"><div id="seqBar" style="height:100%;width:100%;background:${C.gld};border-radius:2px;transition:width ${showMs}ms linear"></div></div>`;
  setTimeout(()=>{if($('seqBar'))$('seqBar').style.width='0%';},50);
  setTimeout(()=>{$('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:14px">ุฃุนุฏ ูุชุงุจุฉ ุงูุชุณูุณู</div><div style="display:flex;gap:6px;justify-content:center;direction:ltr;flex-wrap:wrap" id="sI">${Array.from({length:len},()=>`<input class="inp" type="text" maxlength="1" inputmode="numeric" style="width:44px;height:50px;text-align:center;font-family:'Readex Pro';font-size:20px;padding:0">`).join('')}</div><button class="btn" onclick="sChk()" style="max-width:180px;margin:16px auto 0;display:block;font-size:15px;padding:12px">โ ุชุญูู</button>`;document.querySelector('#sI input')?.focus();const ins=document.querySelectorAll('#sI input');ins.forEach((el,idx)=>el.addEventListener('keyup',e=>{if(e.key>='0'&&e.key<='9'&&idx<ins.length-1)ins[idx+1].focus();}));},showMs);}
window.sChk=function(){const ins=document.querySelectorAll('#sI input');let ok=true;Array.from(ins).forEach((el,i)=>{if(parseInt(el.value)===EX.seq[i]){el.style.borderColor=C.ac;el.style.background='rgba(0,229,184,0.12)';}else{el.style.borderColor=C.dng;el.style.background='rgba(255,118,117,0.12)';ok=false;}});EX.correct=ok?1:0;setTimeout(finishEx,800);};

// --- Schulte ---
function exSchulte(){const lv=getSkillLv('schulte');const grid=[16,25,25,36,36][lv-1];const cols=[4,5,5,6,6][lv-1];const reverse=lv>=4;const nums=empShuf(Array.from({length:grid},(_,i)=>i+1));EX.total=grid;EX.correct=0;EX.next=reverse?grid:1;EX.reverse=reverse;
  const sz=grid<=9?70:grid<=16?62:grid<=25?56:48;
  $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:6px">${reverse?`ุงุถุบุท ${grid} ุฅูู 1 ุจุงูุนูุณ`:`ุงุถุบุท 1 ุฅูู ${grid} ุจุงูุชุฑุชูุจ`}</div><div style="font-size:13px;color:${C.ac2};text-align:center;margin-bottom:10px">ุงููุณุชูู ${lv} โ ุฌุฏูู ${cols}ร${cols}</div><div style="text-align:center;margin-bottom:8px;color:${C.gld};font-weight:700;font-size:18px">ุงูุชุงูู: <span id="sN">${EX.next}</span></div>
  <div style="display:grid;grid-template-columns:repeat(${cols},${sz}px);gap:5px;direction:ltr">${nums.map(n=>`<div class="sc" onclick="scC(${n},this)" style="width:${sz}px;height:${sz}px;background:rgba(255,255,255,0.04);border:2px solid rgba(255,255,255,0.08);border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Readex Pro';font-size:${grid<=16?18:15}px;font-weight:600;cursor:pointer;transition:all 0.2s">${n}</div>`).join('')}</div>`;}
window.scC=function(n,el){if(n===EX.next){el.style.background='rgba(0,229,184,0.15)';el.style.borderColor=C.ac;el.style.color=C.ac;el.style.pointerEvents='none';EX.correct++;EX.next+=EX.reverse?-1:1;$('sN').textContent=EX.next;$('exP').style.width=(EX.correct/EX.total*100)+'%';if(EX.correct===EX.total)setTimeout(finishEx,300);}else{el.style.borderColor=C.dng;setTimeout(()=>el.style.borderColor='rgba(255,255,255,0.08)',300);}};

// --- Stroop --- (Alternates: "ููู ุงูุฎุท" vs "ุงููููุฉ ุงูููุชูุจุฉ")
function exStroop(){const allCl=[{n:'ุฃุญูุฑ',h:'#FF6B6B'},{n:'ุฃุฒุฑู',h:'#74b9ff'},{n:'ุฃุฎุถุฑ',h:'#00E5B8'},{n:'ุฃุตูุฑ',h:'#FDCB6E'},{n:'ุจููุณุฌู',h:'#a29bfe'},{n:'ุจุฑุชูุงูู',h:'#e17055'}];const lv=getSkillLv('stroop');const nColors=[4,4,5,6,6][lv-1];EX.cl=allCl.slice(0,nColors);EX.total=[8,10,12,14,16][lv-1];EX.correct=0;EX.step=0;stQ();}
function stQ(){if(EX.step>=EX.total){finishEx();return;}const c=EX.cl;
  // Random question type with streaks allowed (not alternating)
  if(!EX.stMode)EX.stMode=[];
  if(EX.stMode.length===0){
    // Generate a shuffled random sequence for the whole exercise
    const half=Math.ceil(EX.total/2);
    const modes=[...Array(half).fill(true),...Array(EX.total-half).fill(false)];
    EX.stMode=shuf(modes);
  }
  const askInk=EX.stMode[EX.step];
  const word=c[Math.floor(Math.random()*c.length)];let ink;do{ink=c[Math.floor(Math.random()*c.length)];}while(ink.n===word.n);
  EX.stA=askInk?ink.n:word.n;
  const qLabel=askInk?'๐จ ูุง <b>ููู ุงูุฎุท</b>ุ':'๐ ูุง <b>ุงููููุฉ ุงูููุชูุจุฉ</b>ุ';
  const qColor=askInk?'rgba(0,229,184,0.15)':'rgba(108,92,231,0.15)';
  $('exA').innerHTML=`<div style="padding:8px 16px;border-radius:8px;background:${qColor};display:inline-block;font-size:16px;margin-bottom:10px">${qLabel} <span style="font-size:13px;color:${C.dim}">(${EX.step+1}/${EX.total})</span></div>
  <div style="font-family:'Readex Pro';font-size:56px;font-weight:800;text-align:center;margin:10px 0 22px;color:${ink.h}">${word.n}</div>
  <div style="display:grid;grid-template-columns:repeat(${c.length<=4?2:3},1fr);gap:9px;max-width:500px;width:100%">${[...c].sort(()=>Math.random()-0.5).map(o=>`<div class="ob" onclick="stA('${o.n}',this)" style="padding:16px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.06);border-radius:12px;text-align:center;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s">${o.n}</div>`).join('')}</div>`;$('exP').style.width=(EX.step/EX.total*100)+'%';}
window.stA=function(a,el){document.querySelectorAll('.ob').forEach(b=>b.style.pointerEvents='none');if(a===EX.stA){el.style.borderColor=C.ac;el.style.background='rgba(0,229,184,0.12)';EX.correct++;}else{el.style.borderColor=C.dng;el.style.background='rgba(255,118,117,0.12)';document.querySelectorAll('.ob').forEach(b=>{if(b.textContent===EX.stA){b.style.borderColor=C.ac;b.style.background='rgba(0,229,184,0.12)';}});}EX.step++;setTimeout(stQ,700);};

// --- Math --- (Mixed ops from start, close answers ยฑ1~3)
function exMathS(){EX.total=10;EX.correct=0;EX.step=0;EX.fracCount=0;mQ();}
function mQ(){if(EX.step>=10){finishEx();return;}const lv=getSkillLv('math');let a,b,op,ans,display;
  
  // Add fraction questions at level 3+ (2-3 per exercise)
  const doFraction=lv>=3&&EX.fracCount<3&&empRand()>0.5;
  
  if(doFraction){
    EX.fracCount++;
    const fracOps=['+','-','ร'];
    op=fracOps[Math.floor(empRand()*fracOps.length)];
    // Simple fractions with common denominators
    const denoms=[2,3,4,5,6,8];
    const d1=denoms[Math.floor(empRand()*denoms.length)];
    const n1=Math.floor(empRand()*(d1-1))+1;
    const d2=lv>=4?denoms[Math.floor(empRand()*denoms.length)]:d1;
    const n2=Math.floor(empRand()*(d2-1))+1;
    
    if(op==='+'){ans=Math.round(((n1/d1)+(n2/d2))*100)/100;}
    else if(op==='-'){
      if(n1/d1<n2/d2){ans=Math.round(((n2/d2)-(n1/d1))*100)/100;display=`<sup>${n2}</sup>โ<sub>${d2}</sub> โ <sup>${n1}</sup>โ<sub>${d1}</sub>`;}
      else{ans=Math.round(((n1/d1)-(n2/d2))*100)/100;}
    }
    else{ans=Math.round(((n1/d1)*(n2/d2))*100)/100;}
    
    if(!display)display=`<sup>${n1}</sup>โ<sub>${d1}</sub> ${op==='ร'?'ร':op} <sup>${n2}</sup>โ<sub>${d2}</sub>`;
    EX.mA=ans;
    
    const opts=new Set([ans]);
    const offsets=[-0.5,-0.25,-0.1,0.1,0.25,0.5].sort(()=>empRand()-0.5);
    for(const off of offsets){if(opts.size>=4)break;const w=Math.round((ans+off)*100)/100;if(w>=0&&w!==ans)opts.add(w);}
    while(opts.size<4){opts.add(Math.round((ans+empRand()*2)*100)/100);}
    
    $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center">(${EX.step+1}/10) <span style="font-size:12px;color:${C.ac2}">ูุณุชูู ${lv}</span> <span style="font-size:11px;color:${C.gld}">ูุณูุฑ</span></div><div style="font-family:'Readex Pro';font-size:36px;font-weight:600;text-align:center;margin:14px 0 22px;direction:ltr">${display} = ?</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:440px;width:100%">${[...opts].sort(()=>empRand()-0.5).map(n=>`<div class="ob" onclick="mA(${n},this)" style="padding:18px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.06);border-radius:12px;text-align:center;font-size:22px;font-weight:600;cursor:pointer;transition:all 0.3s">${n}</div>`).join('')}</div>`;$('exP').style.width=(EX.step/10*100)+'%';
    return;
  }
  
  const ops=lv>=2?['+','-','ร','รท']:['+','-','ร'];
  op=ops[Math.floor(empRand()*ops.length)];
  if(op==='รท'){b=Math.floor(empRand()*(lv*4))+2;a=b*(Math.floor(empRand()*(lv*5))+2);}
  else if(op==='ร'){a=Math.floor(empRand()*(lv*6))+3;b=Math.floor(empRand()*(lv*5))+2;}
  else{const mx=[50,80,120,200,350][lv-1];a=Math.floor(empRand()*mx)+10;b=Math.floor(empRand()*Math.floor(mx*0.7))+5;}
  if(op==='-'&&b>a)[a,b]=[b,a];
  ans=op==='+'?a+b:op==='-'?a-b:op==='ร'?a*b:Math.round(a/b);EX.mA=ans;
  // Close wrong answers (ยฑ1, ยฑ2, ยฑ3)
  const opts=new Set([ans]);
  const offsets=[-3,-2,-1,1,2,3].sort(()=>Math.random()-0.5);
  for(const off of offsets){if(opts.size>=4)break;const w=ans+off;if(w>=0&&w!==ans)opts.add(w);}
  while(opts.size<4){opts.add(ans+Math.floor(Math.random()*10)+4);}
  $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center">(${EX.step+1}/10) <span style="font-size:12px;color:${C.ac2}">ูุณุชูู ${lv}</span></div><div style="font-family:'Readex Pro';font-size:42px;font-weight:600;text-align:center;margin:14px 0 22px;direction:ltr">${a} ${op} ${b} = ?</div>
  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:440px;width:100%">${[...opts].sort(()=>Math.random()-0.5).map(n=>`<div class="ob" onclick="mA(${n},this)" style="padding:18px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.06);border-radius:12px;text-align:center;font-size:22px;font-weight:600;cursor:pointer;transition:all 0.3s">${n}</div>`).join('')}</div>`;$('exP').style.width=(EX.step/10*100)+'%';}
window.mA=function(a,el){document.querySelectorAll('.ob').forEach(b=>b.style.pointerEvents='none');if(a===EX.mA){el.style.borderColor=C.ac;el.style.background='rgba(0,229,184,0.12)';EX.correct++;}else{el.style.borderColor=C.dng;el.style.background='rgba(255,118,117,0.12)';document.querySelectorAll('.ob').forEach(b=>{if(parseInt(b.textContent)===EX.mA){b.style.borderColor=C.ac;b.style.background='rgba(0,229,184,0.12)';}});}EX.step++;setTimeout(mQ,500);};

// --- Raven --- (Professional Progressive Matrices)
function exRaven(){const lv=getSkillLv('raven');EX.total=[6,7,8,9,10][lv-1];EX.correct=0;EX.step=0;rQ();}

// SVG drawing engine for shapes
function rvSVG(cell,sz){
  if(!cell)return'';const s=sz||70;const h=s/2;
  let svg=`<svg width="${s}" height="${s}" viewBox="0 0 ${s} ${s}" xmlns="http://www.w3.org/2000/svg">`;
  (cell.items||[]).forEach(it=>{
    const cx=it.x!==undefined?it.x*s:h;const cy=it.y!==undefined?it.y*s:h;
    const r=(it.size||0.35)*s*0.5;const fill=it.fill||'#8899aa';const stroke=it.stroke||'none';const sw=it.sw||2;const rot=it.rot||0;
    const op=it.opacity||0.9;
    if(it.shape==='circle')svg+=`<circle cx="${cx}" cy="${cy}" r="${r}" fill="${fill}" stroke="${stroke}" stroke-width="${sw}" opacity="${op}"/>`;
    else if(it.shape==='rect'){const g=`translate(${cx},${cy}) rotate(${rot})`;svg+=`<rect x="${-r}" y="${-r}" width="${r*2}" height="${r*2}" fill="${fill}" stroke="${stroke}" stroke-width="${sw}" opacity="${op}" transform="${g}" rx="2"/>`;}
    else if(it.shape==='triangle'){const g=`translate(${cx},${cy}) rotate(${rot})`;svg+=`<polygon points="0,${-r} ${r},${r} ${-r},${r}" fill="${fill}" stroke="${stroke}" stroke-width="${sw}" opacity="${op}" transform="${g}"/>`;}
    else if(it.shape==='diamond'){const g=`translate(${cx},${cy}) rotate(${rot})`;svg+=`<polygon points="0,${-r} ${r},0 0,${r} ${-r},0" fill="${fill}" stroke="${stroke}" stroke-width="${sw}" opacity="${op}" transform="${g}"/>`;}
    else if(it.shape==='cross'){const t=r*0.3;const g=`translate(${cx},${cy}) rotate(${rot})`;svg+=`<rect x="${-r}" y="${-t}" width="${r*2}" height="${t*2}" fill="${fill}" opacity="${op}" transform="${g}"/><rect x="${-t}" y="${-r}" width="${t*2}" height="${r*2}" fill="${fill}" opacity="${op}" transform="${g}"/>`;}
    else if(it.shape==='line'){const len=r;const g=`translate(${cx},${cy}) rotate(${rot})`;svg+=`<line x1="${-len}" y1="0" x2="${len}" y2="0" stroke="${fill}" stroke-width="${sw+1}" opacity="${op}" transform="${g}"/>`;}
    else if(it.shape==='dots'){const n=it.count||3;for(let i=0;i<n;i++){const a=(i/n)*Math.PI*2-Math.PI/2;const dx=cx+Math.cos(a)*r*0.7;const dy=cy+Math.sin(a)*r*0.7;svg+=`<circle cx="${dx}" cy="${dy}" r="${s*0.04}" fill="${fill}" opacity="${op}"/>`;}}
  });
  return svg+'</svg>';
}

// Generate a Raven question based on rule type
function genRaven(lv){
  const colors=['#74b9ff','#ff7675','#00E5B8','#a29bfe','#FDCB6E','#e17055'];
  const shapes=['circle','rect','triangle','diamond','cross'];
  
  // Pick rule type based on level โ harder rules from start
  const ruleTypes=lv<=2?['rotation','distribute3','countProgression','dualAttribute']:lv<=3?['distribute3','addSubtract','dualAttribute','xorPattern']:lv<=4?['addSubtract','dualAttribute','xorPattern','distribute3']:['xorPattern','addSubtract','dualAttribute','distribute3'];
  const rule=ruleTypes[Math.floor(Math.random()*ruleTypes.length)];
  
  const matrix=[];let answer;
  const sh=empShuf(shapes);const co=empShuf(colors);
  
  if(rule==='countProgression'){
    // Count increases + color changes per row
    const baseShape=sh[0];const rowFills=[co[0],co[1],co[2]];
    const rowSizes=[0.22,0.2,0.18]; // smaller as count grows
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const count=c+1;const items=[];
      for(let i=0;i<count;i++){
        const x=count===1?0.5:count===2?(i===0?0.33:0.67):(i===0?0.22:i===1?0.5:0.78);
        items.push({shape:sh[r],x,y:0.5,size:rowSizes[c],fill:rowFills[r]});
      }
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else if(rule==='dualAttribute'){
    // Two attributes change: shape changes per row, color changes per column
    const rowShapes=[sh[0],sh[1],sh[2]];const colFills=[co[0],co[1],co[2]];
    const sizes=[0.25,0.3,0.35]; // size increases diagonally
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const items=[{shape:rowShapes[r],x:0.5,y:0.5,size:sizes[(r+c)%3],fill:colFills[c],rot:r*30}];
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else if(rule==='xorPattern'){
    // Row 3 = elements in row1 XOR row2 (present in one but not both)
    const s=[sh[0],sh[1],sh[2]];const f=[co[0],co[1],co[2]];
    // Row 0: shape 0+1, Row 1: shape 1+2, Row 2: shape 0+2 (XOR)
    const rowItems=[[0,1],[1,2],[0,2]];
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const items=rowItems[r].map((si,i)=>({shape:s[si],x:i===0?0.33:0.67,y:0.5,size:0.2+(c*0.04),fill:f[(si+c)%3]}));
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else if(rule==='sizeProgression'){
    // Size grows: small,medium,large across each row
    const sizes=[0.18,0.28,0.38];const rowShapes=[sh[0],sh[1],sh[2]];
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const items=[{shape:rowShapes[r],x:0.5,y:0.5,size:sizes[c],fill:co[r]}];
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else if(rule==='rotation'){
    // Shape rotates 45ยฐ across columns
    const rots=[0,45,90];const rowShapes=[sh[0],sh[1],sh[2]];
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const items=[{shape:rowShapes[r],x:0.5,y:0.5,size:0.32,fill:co[r],rot:rots[c]}];
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else if(rule==='distribute3'){
    // Each row has 3 different shapes AND 3 different colors
    const perms=[[0,1,2],[1,2,0],[2,0,1]];
    for(let r=0;r<3;r++){for(let c=0;c<3;c++){
      const si=perms[r][c];const ci=(r+c)%3;
      const items=[{shape:sh[si],x:0.5,y:0.5,size:0.3,fill:co[ci]}];
      if(r===2&&c===2){answer={items};matrix.push(null);}
      else matrix.push({items});
    }}
  }else{
    // addSubtract: row3 = row1 + row2 (overlay items)
    const s1=sh[0],s2=sh[1];const f1=co[0],f2=co[1];
    for(let r=0;r<3;r++){
      const items=[];
      if(r===0||r===2)items.push({shape:s1,x:0.35,y:0.5,size:0.22,fill:f1});
      if(r===1||r===2)items.push({shape:s2,x:0.65,y:0.5,size:0.22,fill:f2});
      for(let c=0;c<3;c++){
        const citems=items.map(it=>({...it,size:it.size+(c*0.04)}));
        if(r===2&&c===2){answer={items:citems};matrix.push(null);}
        else matrix.push({items:citems});
      }
    }
  }
  
  // Generate wrong answers
  const wrongs=[];
  for(let w=0;w<5;w++){
    const items=answer.items.map(it=>{
      const mods=[
        {...it,fill:co[(co.indexOf(it.fill)+w+1)%co.length]},
        {...it,shape:sh[(sh.indexOf(it.shape)+w+1)%sh.length]},
        {...it,size:it.size*(w%2===0?0.6:1.4)},
        {...it,rot:(it.rot||0)+90},
      ];
      return mods[w%mods.length];
    });
    wrongs.push({items});
  }
  
  const optCount=lv<=2?4:lv<=3?5:6;
  const opts=shuf([answer,...wrongs.slice(0,optCount-1)]);
  return{matrix,answer,opts,ansIdx:opts.indexOf(answer),rule};
}

function rQ(){
  if(EX.step>=EX.total){finishEx();return;}
  const lv=getSkillLv('raven');
  const q=genRaven(lv);EX.rA=q.ansIdx;
  const sz=80;const optSz=68;const optCols=q.opts.length<=4?4:3;
  
  $('exA').innerHTML=`<div style="font-size:15px;color:${C.dim};text-align:center;margin-bottom:4px">ุฃููู ุงููุตูููุฉ (${EX.step+1}/${EX.total})</div>
  <div style="font-size:12px;color:${C.ac2};text-align:center;margin-bottom:10px">ุงููุณุชูู ${lv}</div>
  <div style="display:grid;grid-template-columns:repeat(3,${sz}px);gap:2px;background:rgba(255,255,255,0.04);border-radius:12px;padding:8px;direction:ltr;margin:0 auto;border:1px solid rgba(255,255,255,0.06)">${q.matrix.map(c=>c?`<div style="width:${sz}px;height:${sz}px;background:rgba(255,255,255,0.06);border-radius:6px;display:flex;align-items:center;justify-content:center">${rvSVG(c,sz-10)}</div>`:`<div style="width:${sz}px;height:${sz}px;background:rgba(253,203,110,0.08);border:2px dashed rgba(253,203,110,0.25);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:24px;color:${C.gld}">โ</div>`).join('')}</div>
  <div style="display:grid;grid-template-columns:repeat(${optCols},1fr);gap:6px;max-width:${optCols*76}px;margin:14px auto;direction:ltr">${q.opts.map((o,i)=>`<div class="rv" onclick="rA(${i},this)" style="width:${optSz}px;height:${optSz}px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.08);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.3s;margin:0 auto">${rvSVG(o,optSz-12)}</div>`).join('')}</div>`;
  $('exP').style.width=(EX.step/EX.total*100)+'%';
}
window.rA=function(c,el){document.querySelectorAll('.rv').forEach(o=>o.style.pointerEvents='none');if(c===EX.rA){el.style.borderColor=C.ac;el.style.background='rgba(0,229,184,0.1)';EX.correct++;}else{el.style.borderColor=C.dng;el.style.background='rgba(255,118,117,0.1)';document.querySelectorAll('.rv')[EX.rA].style.borderColor=C.ac;document.querySelectorAll('.rv')[EX.rA].style.background='rgba(0,229,184,0.1)';}EX.step++;setTimeout(rQ,900);};

// --- Typing --- (Quick drill โ auto-picks level, no menu)
function exTyping(){
  if(!S.data.typingProgress||typeof S.data.typingProgress!=='object'){
    S.data.typingProgress={ar:1,en:1};
  }
  const tpData=S.data.typingProgress;
  if(!tpData.ar||tpData.ar<1||tpData.ar>10)tpData.ar=1;
  if(!tpData.en||tpData.en<1||tpData.en>10)tpData.en=1;
  if(tpData.ar>=10){const h=S.data.hist.filter(x=>x.type==='typing');if(h.length<10)tpData.ar=1;}
  if(tpData.en>=10){const h=S.data.hist.filter(x=>x.type==='typing');if(h.length<10)tpData.en=1;}
  saveU(S.data);
  
  // Auto-pick: alternate ar/en, or based on which is lower level
  const lang=tpData.ar<=tpData.en?'ar':'en';
  const lv=Math.min(tpData[lang],10);
  const lesson=TYPING_LESSONS[lang][lv-1];
  const drill=lesson.drills[Math.floor(Math.random()*lesson.drills.length)];
  const isAr=lang==='ar';
  
  EX.total=drill.length;EX.correct=0;EX.typed=0;EX.text=drill;EX.isAr=isAr;EX.errors=0;EX.tpLang=lang;EX.tpLv=lv;
  EX.start=Date.now();
  
  // Build UI โ single screen, no menu
  let charSpans=drill.split('').map((ch,i)=>`<span id="tc${i}" style="color:${i===0?C.gld:'rgba(255,255,255,0.25)'};${i===0?'border-bottom:2px solid '+C.gld:''};font-size:22px">${ch===' '?'ยท':ch}</span>`).join('');
  
  $('exA').innerHTML=`<div style="width:100%;max-width:600px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-size:14px;color:${C.dim}">${isAr?'๐ธ๐ฆ':'๐ฌ๐ง'} ${lv>=10?'ุชุฏุฑูุจ':'ุฏุฑุณ '+lv} <b style="color:#fff">${lesson.title}</b></div>
      <div style="font-size:13px"><span>ุฏูุฉ: <b id="tpAcc" style="color:${C.ac}">100%</b></span> <span style="margin-right:10px">ุฃุฎุทุงุก: <b id="tpErr" style="color:${C.dng}">0</b></span></div>
    </div>
    <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;line-height:2.5;letter-spacing:2px;direction:${isAr?'rtl':'ltr'};text-align:${isAr?'right':'left'};position:relative;cursor:text" onclick="document.getElementById('tpHid').focus()">${charSpans}<textarea id="tpHid" style="position:absolute;opacity:0;width:1px;height:1px;top:0;left:0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea></div>
    <div style="text-align:center;margin:14px 0">
      <span style="font-size:14px;color:${C.dim}">ุงูุชุงูู:</span>
      <span id="tpNext" style="font-size:30px;font-weight:800;color:${C.ac};margin:0 8px;font-family:'Readex Pro'">${drill[0]===' '?'ูุณุงูุฉ':drill[0]}</span>
    </div>
    <div style="text-align:center;padding:8px;background:rgba(255,118,117,0.06);border-radius:8px;font-size:13px;color:${C.gld}">โ๏ธ ูุง ุชูุธุฑ ููููุจูุฑุฏ</div>
    <div style="width:100%;height:5px;background:rgba(255,255,255,0.05);border-radius:3px;margin-top:10px;overflow:hidden"><div id="tpBar" style="height:100%;width:0%;background:linear-gradient(90deg,${C.ac},${C.ac2});border-radius:3px;transition:width 0.3s"></div></div>
  </div>`;
  
  const hidInp=$('tpHid');hidInp.focus();
  
  function processChar(ch){
    const expected=EX.text[EX.typed];
    const span=$('tc'+EX.typed);
    if(ch===expected){
      EX.typed++;EX.correct++;
      if(span){span.style.color=C.ac;span.style.borderBottom='none';}
    }else{
      EX.errors++;
      if(span){span.style.color=C.dng;span.style.borderBottom='2px solid '+C.dng;}
      EX.typed++;
    }
    $('tpBar').style.width=(EX.typed/EX.total*100)+'%';
    $('exP').style.width=(EX.typed/EX.total*100)+'%';
    $('tpErr').textContent=EX.errors;
    const acc=EX.typed>0?Math.round(EX.correct/EX.typed*100):100;
    const accEl=$('tpAcc');accEl.textContent=acc+'%';accEl.style.color=acc>=90?C.ac:acc>=70?C.gld:C.dng;
    
    if(EX.typed>=EX.total){finishTypingLesson();return;}
    
    const nextSpan=$('tc'+EX.typed);
    if(nextSpan){nextSpan.style.color=C.gld;nextSpan.style.borderBottom='2px solid '+C.gld;}
    const nextCh=EX.text[EX.typed];
    $('tpNext').textContent=nextCh===' '?'ูุณุงูุฉ':nextCh;
  }
  
  hidInp.oninput=function(){
    const v=hidInp.value;
    if(v.length>0){
      const lastChar=v[v.length-1];
      hidInp.value='';
      processChar(lastChar);
    }
  };
  hidInp.onkeydown=function(e){
    if(e.key===' '){e.preventDefault();processChar(' ');}
    else if(e.key==='Backspace')e.preventDefault();
    else if(!isAr&&e.key.length===1){e.preventDefault();processChar(e.key);}
  };
  document.addEventListener('click',function tpFocus(){
    if(EX.tpLang&&$('tpHid'))$('tpHid').focus();
    else document.removeEventListener('click',tpFocus);
  });
}

function finishTypingLesson(){
  const dur=Math.round((Date.now()-EX.start)/1000);
  const accuracy=EX.typed>0?Math.round(EX.correct/EX.typed*100):0;
  const passed=accuracy>=70;
  
  // Level up if passed
  if(passed&&EX.tpLv<10){
    S.data.typingProgress[EX.tpLang]=EX.tpLv+1;
  }
  saveU(S.data);
  
  // Use standard finishEx
  EX.total=EX.text.length;
  finishEx();
}

// --- Shortcuts --- (Keyboard-based answers with context labels)
function exShortcuts(){
  EX.total=8;EX.correct=0;EX.step=0;EX.pool=shuf([...SHORTCUTS]).slice(0,8);
  showSCQ();
}
function showSCQ(){
  if(EX.step>=8){finishEx();return;}
  const sc=EX.pool[EX.step];
  const catColors={'ูููุฏูุฒ':'rgba(0,229,184,0.15);color:#00E5B8','Excel':'rgba(108,92,231,0.15);color:#a29bfe','ุงููุชุตูุญ':'rgba(253,203,110,0.15);color:#FDCB6E'};
  const catStyle=catColors[sc.cat]||catColors['ูููุฏูุฒ'];
  
  $('exP').style.width=(EX.step/8*100)+'%';
  
  if(sc.noPress){
    // Multiple choice for dangerous shortcuts
    const correct=sc.keys.join(' + ');
    const others=SHORTCUTS.filter(s=>s!==sc).sort(()=>Math.random()-0.5).slice(0,3).map(s=>s.keys.join(' + '));
    const opts=[correct,...others].sort(()=>Math.random()-0.5);
    $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:8px">(${EX.step+1}/8)</div>
      <div style="font-family:'Readex Pro';font-size:26px;font-weight:700;text-align:center;margin:10px 0 8px">${sc.desc}</div>
      <div style="text-align:center;margin-bottom:8px"><span style="font-size:13px;padding:5px 14px;border-radius:6px;background:${catStyle};font-weight:600">๐ฅ๏ธ ${sc.cat}</span></div>
      <div style="text-align:center;margin-bottom:14px;font-size:14px;color:${C.gld}">โ๏ธ ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:500px;direction:ltr">${opts.map(o=>`<div class="ob" onclick="scMC('${o.replace(/'/g,"\\'")}',this,'${correct.replace(/'/g,"\\'")}','${sc.desc}')" style="padding:16px;background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.06);border-radius:12px;text-align:center;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.3s">${o}</div>`).join('')}</div>`;
    return;
  }
  
  // Normal keypress mode
  $('exA').innerHTML=`<div style="font-size:16px;color:${C.dim};text-align:center;margin-bottom:8px">(${EX.step+1}/8)</div>
    <div style="font-family:'Readex Pro';font-size:26px;font-weight:700;text-align:center;margin:10px 0 8px">${sc.desc}</div>
    <div style="text-align:center;margin-bottom:14px"><span style="font-size:13px;padding:5px 14px;border-radius:6px;background:${catStyle};font-weight:600">๐ฅ๏ธ ${sc.cat}</span></div>
    <div style="text-align:center;margin-bottom:14px;font-size:14px;color:${C.dim}">โจ๏ธ ุงุถุบุท ุงูุงุฎุชุตุงุฑ ุนูู ุงูููุจูุฑุฏ</div>
    <div style="text-align:center;padding:18px;background:rgba(255,255,255,0.03);border:2px dashed rgba(255,255,255,0.1);border-radius:14px;min-height:60px;display:flex;align-items:center;justify-content:center;direction:ltr" id="scKeys">
      <span style="color:${C.dim};font-size:15px">ูู ุงูุชุธุงุฑ ุงูุถุบุท...</span>
    </div>
    <div id="scFeedback" style="text-align:center;margin-top:14px;font-size:16px;min-height:60px"></div>`;
  $('exP').style.width=(EX.step/8*100)+'%';
  
  // Listen for keyboard
  EX.scPressed=new Set();EX.scDone=false;
  const expectedKeys=sc.keys.map(k=>k.toLowerCase());
  
  document.onkeydown=function(e){
    if(EX.scDone)return;
    e.preventDefault();
    let key=e.key.toLowerCase();
    if(key==='control')key='ctrl';
    if(key===' ')key='space';
    EX.scPressed.add(key);
    // Show pressed keys
    const pressedArr=[...EX.scPressed];
    $('scKeys').innerHTML=pressedArr.map(k=>`<span class="shortcut-key" style="font-size:16px;padding:8px 14px">${k}</span>`).join('<span class="shortcut-plus" style="font-size:14px">+</span>');
  };
  document.onkeyup=function(e){
    if(EX.scDone)return;
    const pressedArr=[...EX.scPressed].sort().join('+');
    const expectedArr=expectedKeys.sort().join('+');
    const isCorrect=pressedArr===expectedArr;
    EX.scDone=true;
    
    if(isCorrect){
      EX.correct++;
      $('scKeys').style.borderColor=C.ac;$('scKeys').style.background='rgba(0,229,184,0.08)';
      $('scFeedback').innerHTML=`<div style="color:${C.ac};font-weight:700;font-size:18px">โ ุตุญูุญ! ุฃุญุณูุช</div>`;
    }else{
      $('scKeys').style.borderColor=C.dng;$('scKeys').style.background='rgba(255,118,117,0.08)';
      $('scFeedback').innerHTML=`<div style="color:${C.dng};font-weight:700;font-size:17px;margin-bottom:6px">โ ุฎุทุฃ</div><div style="font-size:15px;color:${C.dim}">ุงูุตุญูุญ ูู:</div><div style="margin-top:8px;direction:ltr">${sc.keys.map(k=>`<span class="shortcut-key" style="font-size:15px;padding:6px 12px;border-color:${C.ac}">${k}</span>`).join('<span class="shortcut-plus">+</span>')}</div>`;
    }
    EX.step++;
    setTimeout(()=>{EX.scPressed=new Set();document.onkeydown=null;document.onkeyup=null;showSCQ();},2200);
  };
}

function shuf(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

window.scMC=function(ans,el,correct,desc){
  document.querySelectorAll('.ob').forEach(b=>b.style.pointerEvents='none');
  if(ans===correct){
    EX.correct++;el.style.borderColor=C.ac;el.style.background='rgba(0,229,184,0.12)';
  }else{
    el.style.borderColor=C.dng;el.style.background='rgba(255,118,117,0.12)';
    document.querySelectorAll('.ob').forEach(b=>{if(b.textContent===correct){b.style.borderColor=C.ac;b.style.background='rgba(0,229,184,0.12)';}});
  }
  EX.step++;setTimeout(showSCQ,1500);
};

// ============ PROGRESS + GROWTH ============
function rProgress(){
  const u=S.data;const emps=getEmpList();
  // 30 days
  let dH='';for(let i=29;i>=0;i--){const d=new Date(Date.now()-i*864e5);const ds=d.toDateString();const done=u.hist.some(h=>new Date(h.date).toDateString()===ds);dH+=`<div style="width:30px;height:30px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;border:1.5px solid ${done?C.ac:i===0?C.gld:'rgba(255,255,255,0.08)'};background:${done?'rgba(0,229,184,0.15)':'rgba(255,255,255,0.02)'};color:${done?C.ac:i===0?C.gld:'inherit'}">${d.getDate()}</div>`;}

  const t=u.hist.length;const avgA=t?Math.round(u.hist.reduce((a,b)=>a+b.score,0)/t):0;

  // Per-skill deep analysis
  let skillCards='';
  EXT.forEach(ex=>{
    const myH=u.hist.filter(h=>h.type===ex.id);
    const myAvg=myH.length?Math.round(myH.reduce((a,b)=>a+b.score,0)/myH.length):0;
    // My growth: first half vs second half
    let growth=0,growthMsg='';
    if(myH.length>=4){
      const m=Math.floor(myH.length/2);
      const firstAvg=Math.round(myH.slice(0,m).reduce((a,b)=>a+b.score,0)/m);
      const secAvg=Math.round(myH.slice(m).reduce((a,b)=>a+b.score,0)/(myH.length-m));
      growth=secAvg-firstAvg;
    }
    if(growth>10)growthMsg=`<span style="color:${C.ac}">๐ ุชุทูุฑ ููุชุงุฒ! ุชุญุณูุช +${growth}% ุนู ุจุฏุงูุชู</span>`;
    else if(growth>0)growthMsg=`<span style="color:${C.ac}">๐ ุชุชุญุณู! +${growth}% ุนู ุจุฏุงูุชู</span>`;
    else if(growth===0&&myH.length>0)growthMsg=`<span style="color:${C.gld}">โก๏ธ ูุณุชูุฑุ ูุงุตู ูุจุชุดูู ุงููุฑู</span>`;
    else if(growth<0)growthMsg=`<span style="color:${C.gld}">๐ช ูุง ุชูููุ ุงูุตุนูุจุฉ ุชุฒูุฏ ูุน ุชูุฏูู</span>`;
    else growthMsg=`<span style="color:${C.dim}">โณ ุงุจุฏุฃ ุงูุชูุฑูู ูุดูู ุชูุฏูู</span>`;

    // Level description
    const lvl=myAvg>=85?'ูุชูุฏู ๐':myAvg>=70?'ุฌูุฏ ุฌุฏุงู ๐ช':myAvg>=50?'ุฌูุฏ ๐':myAvg>0?'ูุจุชุฏุฆ ๐ฑ':'ูู ูุจุฏุฃ';
    const lvlC=myAvg>=85?C.ac:myAvg>=70?C.ac2:myAvg>=50?C.gld:C.dim;

    // Peer comparison (anonymous)
    const peerScores=emps.filter(e=>e.uid!==S.user.uid&&e.role!=='admin').map(e=>{
      const d=gs('u_'+e.email);const h=(d?.hist||[]).filter(x=>x.type===ex.id);
      return h.length?Math.round(h.reduce((a,b)=>a+b.score,0)/h.length):-1;
    }).filter(v=>v>=0);
    const peerAvg=peerScores.length?Math.round(peerScores.reduce((a,b)=>a+b,0)/peerScores.length):0;
    const betterCount=peerScores.filter(v=>v<myAvg).length;
    const peerPct=peerScores.length?Math.round((betterCount/peerScores.length)*100):0;

    let peerMsg='';
    if(!myH.length) peerMsg='';
    else if(peerPct>=80) peerMsg=`<span style="color:${C.ac}">ุฃูุช ูุชูุฏู ุนูู ${peerPct}% ูู ุงูุฒููุงุก โ ุงุณุชูุฑ!</span>`;
    else if(peerPct>=50) peerMsg=`<span style="color:${C.gld}">ูุณุจุชู ุฃูุถู ูู ${peerPct}% โ ุดุบู ุญููุ ูููู!</span>`;
    else if(peerPct>=20) peerMsg=`<span style="color:${C.gld}">ุงูุฒููุงุก ููุงู ูุดุชุบููู ุนูู <b>ุฃููุณูู</b> โ ุฑููุฒ ุนูู ุชุทูุฑู ุฃูุช</span>`;
    else if(peerScores.length) peerMsg=`<span style="color:${C.dim}">ุงููุฏู ุชุทูุฑู ุฃูุช โ ูู ูุงุญุฏ ูุจูู ููุณู ุจููุณู</span>`;

    skillCards+=`<div style="background:rgba(255,255,255,0.02);border:1px solid ${C.gb};border-radius:14px;padding:18px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
        <span style="font-size:28px">${ex.ic}</span>
        <div style="flex:1"><div style="font-weight:700;font-size:15px">${ex.n}</div><div style="font-size:11px;color:${C.dim}">${ex.d}</div></div>
        <div style="text-align:left"><div style="font-family:'Readex Pro';font-size:22px;font-weight:700;color:${lvlC}">${myAvg}%</div><div style="font-size:10px;color:${lvlC}">${lvl}</div></div>
      </div>
      <div style="width:100%;height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin-bottom:12px"><div style="height:100%;width:${myAvg}%;background:linear-gradient(90deg,${C.ac},${C.ac2});border-radius:3px"></div></div>
      <div style="font-size:12px;line-height:2">
        <div>๐ ุนุฏุฏ ุงููุญุงููุงุช: <b>${myH.length}</b></div>
        <div>${growthMsg}</div>
        ${peerMsg?`<div style="margin-top:4px;padding:6px 10px;background:rgba(255,255,255,0.02);border-radius:6px">${peerMsg}</div>`:''}
      </div>
    </div>`;
  });

  $('ct').innerHTML=`
  <div class="card fi"><div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:14px">๐ ุขุฎุฑ 30 ููู</div><div style="display:flex;gap:4px;flex-wrap:wrap">${dH}</div></div>

  <div class="card fi">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:6px">๐ ููุฎุต ุฑุญูุชู</div>
    <div style="font-size:12px;color:${C.dim};margin-bottom:16px;line-height:1.8">ุงููุฏู ูู ุชุทูุฑู <b style="color:#fff">ุฃูุช</b> โ ููุงุฑูุชู ุงูุญููููุฉ ูุน ููุณู ุจุงูุฃูุณ. ุงูุขุฎุฑูู ููุงู ุดุบุงููู ุชุทููุฑ ุนูู <b style="color:#fff">ุฃููุณูู</b>.</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
      <div style="background:rgba(0,229,184,0.06);border:1px solid rgba(0,229,184,0.12);border-radius:12px;padding:14px;text-align:center"><div style="font-size:11px;color:${C.dim};margin-bottom:4px">ุงููุนุฏู ุงูุนุงู</div><div style="font-family:'Readex Pro';font-size:24px;font-weight:700;color:${C.ac}">${avgA}%</div></div>
      <div style="background:rgba(108,92,231,0.06);border:1px solid rgba(108,92,231,0.12);border-radius:12px;padding:14px;text-align:center"><div style="font-size:11px;color:${C.dim};margin-bottom:4px">ุงููุณุชูู</div><div style="font-family:'Readex Pro';font-size:24px;font-weight:700;color:${C.ac2}">${u.level}</div></div>
      <div style="background:rgba(253,203,110,0.06);border:1px solid rgba(253,203,110,0.12);border-radius:12px;padding:14px;text-align:center"><div style="font-size:11px;color:${C.dim};margin-bottom:4px">ุฅุฌูุงูู ุงูุชูุงุฑูู</div><div style="font-family:'Readex Pro';font-size:24px;font-weight:700;color:${C.gld}">${t}</div></div>
      <div style="background:rgba(255,118,117,0.06);border:1px solid rgba(255,118,117,0.12);border-radius:12px;padding:14px;text-align:center"><div style="font-size:11px;color:${C.dim};margin-bottom:4px">ุฃุทูู ุณูุณูุฉ</div><div style="font-family:'Readex Pro';font-size:24px;font-weight:700;color:#ff7675">๐ฅ ${u.best||u.streak}</div></div>
    </div>
  </div>

  <div class="card fi">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:6px">๐ฏ ุชุญููู ูู ููุงุฑุฉ</div>
    <div style="font-size:12px;color:${C.dim};margin-bottom:14px">ูู ุชูุฑูู ูู ูุตุฉ โ ุดูู ููู ุชุทูุฑุช ูููู ุชุญุชุงุฌ ุชุฑููุฒ ุฃูุซุฑ</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">${skillCards}</div>
  </div>`;
}

// ============ TEAM ============
function rTeam(){const emps=getEmpList().filter(e=>e.dept===S.user.dept);let rows='';
  emps.forEach(emp=>{const d=gs('u_'+emp.email);const lv=d?.level||0;const st=d?.streak||0;const hist=d?.hist||[];const avg=hist.length?Math.round(hist.reduce((a,b)=>a+b.score,0)/hist.length):0;const td_=d?.todayD===td()?Object.keys(d.todayEx||{}).length:0;const ad=new Set(hist.map(h=>new Date(h.date).toDateString())).size;const cm=Math.min(Math.round((ad/30)*100),100);
    const rt=cm>=80&&avg>=70?'ููุชุงุฒ':cm>=50&&avg>=50?'ุฌูุฏ':cm>0?'ูุญุชุงุฌ ุชุญุณูู':'โ';const rc=rt==='ููุชุงุฒ'?C.ac:rt==='ุฌูุฏ'?C.gld:C.dng;
    rows+=`<tr>${[emp.name+(emp.role==='manager'?' ๐':''),'Lv'+lv,td_+'/8',cm+'%',avg+'%',st+'๐ฅ',`<span style="padding:3px 8px;border-radius:5px;font-size:11px;font-weight:600;background:${rc}20;color:${rc}">${rt}</span>`].map(v=>`<td style="padding:11px 12px;font-size:13px;background:rgba(255,255,255,0.015)">${v}</td>`).join('')}</tr>`;});
  $('ct').innerHTML=`<div class="card fi"><div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:16px">๐ฅ ูุฑูู ${dn(S.user.dept)}</div><div style="overflow-x:auto"><table style="width:100%;border-collapse:separate;border-spacing:0 5px"><thead><tr>${['ุงูููุธู','ุงููุณุชูู','ุงูููู','ุงูุงูุชุฒุงู','ุงููุนุฏู','ูุชุชุงููุฉ','ุงูุชูููู'].map(h=>`<th style="text-align:right;padding:9px 12px;font-size:11px;color:${C.dim};font-weight:500;border-bottom:1px solid ${C.gb}">${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div></div>`;}

// ============ ADMIN ============
async function rAdmin(){
  // Load all employee data from Firebase
  $('ct').innerHTML='<div class="fi" style="text-align:center;padding:40px"><div style="font-size:30px;margin-bottom:10px">โณ</div><div style="color:'+C.dim+'">ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูููุธููู...</div></div>';
  const emps=getEmpList();
  // Fetch all users from Firestore
  try{
    const snap=await db.collection('users').get();
    snap.forEach(doc=>{ss('u_'+doc.data().email,doc.data());});
  }catch(e){console.warn('FB bulk read:',e);}
  
  let allD=emps.map(emp=>{const d=gs('u_'+emp.email);const hist=d?.hist||[];const avg=hist.length?Math.round(hist.reduce((a,b)=>a+b.score,0)/hist.length):0;const ad=new Set(hist.map(h=>new Date(h.date).toDateString())).size;
    // Calculate commitment from first exercise date (not fixed 30 days)
    let totalDays=1;
    if(hist.length>0){const firstDate=new Date(hist[0].date);const now=new Date();totalDays=Math.max(1,Math.floor((now-firstDate)/(864e5))+1);}
    const cm=hist.length>0?Math.min(Math.round((ad/totalDays)*100),100):0;
    const td_=d?.todayD===td()?Object.keys(d.todayEx||{}).length:0;
    let imp=0;if(hist.length>=4){const m=Math.floor(hist.length/2);imp=Math.round(hist.slice(m).reduce((a,b)=>a+b.score,0)/(hist.length-m)-hist.slice(0,m).reduce((a,b)=>a+b.score,0)/m);}
    return{...emp,level:d?.level||0,streak:d?.streak||0,avg,cm,td:td_,imp,points:d?.points||0};});
  const tA=allD.filter(d=>d.td>=8).length;const aC=Math.round(allD.reduce((a,b)=>a+b.cm,0)/allD.length);
  let dc='';DEPTS.forEach(dept=>{const de=allD.filter(e=>e.dept===dept.id);const da=de.length?Math.round(de.reduce((a,b)=>a+b.cm,0)/de.length):0;dc+=`<div style="background:rgba(255,255,255,0.02);border:1px solid ${C.gb};border-radius:12px;padding:14px;text-align:center"><div style="font-weight:600;font-size:13px;margin-bottom:6px">${dept.n}</div><div style="font-family:'Readex Pro';font-size:22px;font-weight:700;color:${C.ac}">${da}%</div><div style="font-size:10px;color:${C.dim}">${de.length} ููุธู</div></div>`;});
  allD.sort((a,b)=>b.cm-a.cm);
  let rows=allD.map(d=>{const rt=d.cm>=80&&d.avg>=70?'ููุชุงุฒ':d.cm>=50&&d.avg>=50?'ุฌูุฏ':d.cm>0?'ูุญุชุงุฌ ุชุญุณูู':'โ';const rc=rt==='ููุชุงุฒ'?C.ac:rt==='ุฌูุฏ'?C.gld:C.dng;
    return`<tr>${[d.name,dn(d.dept),'<span style="color:'+getRank(d.points).color+'">'+getRank(d.points).name+'</span>',d.points,d.td+'/8',d.cm+'%',d.avg+'%',(d.imp>=0?'โ':'โ')+Math.abs(d.imp)+'%',d.streak+'๐ฅ',`<span style="padding:3px 8px;border-radius:5px;font-size:11px;font-weight:600;background:${rc}20;color:${rc}">${rt}</span>`].map(v=>`<td style="padding:11px 12px;font-size:12px;background:rgba(255,255,255,0.015)">${v}</td>`).join('')}</tr>`;}).join('');
  
  // Sort by points (ranking)
  allD.sort((a,b)=>b.points-a.points);
  
  // Employee management table
  let empRows=emps.map((e,idx)=>{
    const supName=e.sup?emps.find(x=>x.uid===e.sup)?.name||'-':'-';
    return`<tr><td style="padding:8px 10px;font-size:12px;background:rgba(255,255,255,0.015);font-weight:600">${e.name}</td><td style="padding:8px 10px;font-size:11px;background:rgba(255,255,255,0.015);direction:ltr;color:${C.ac}">${e.uid}</td><td style="padding:8px 10px;font-size:11px;background:rgba(255,255,255,0.015);direction:ltr">${e.email}</td><td style="padding:8px 10px;font-size:12px;background:rgba(255,255,255,0.015)">${dn(e.dept)}</td><td style="padding:8px 10px;font-size:12px;background:rgba(255,255,255,0.015)">${ROLES[e.role]||e.role}</td><td style="padding:8px 10px;font-size:12px;background:rgba(255,255,255,0.015)">${supName}</td><td style="padding:8px 10px;font-size:12px;background:rgba(255,255,255,0.015)"><span onclick="delEmp(${idx})" style="color:${C.dng};cursor:pointer;font-size:11px">๐๏ธ</span></td></tr>`;
  }).join('');

  $('ct').innerHTML=`<div class="fi" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">${[['ุงูููุธููู',emps.length],['ุฃููููุง ุงูููู',tA+'/'+emps.length],['ุงูุงูุชุฒุงู',aC+'%'],['ุงูุฃูุณุงู',DEPTS.length]].map(([l,v])=>`<div style="background:${C.cb};border:1px solid ${C.gb};border-radius:16px;padding:18px"><div style="font-size:11px;color:${C.dim};margin-bottom:5px">${l}</div><div style="font-family:'Readex Pro';font-size:26px;font-weight:700">${v}</div></div>`).join('')}</div>
  <div class="card fi"><div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:12px">๐ข ุงูุฃูุณุงู</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px">${dc}</div></div>
  <div class="card fi"><div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:16px">๐ ุงูุชูุฑูุฑ ุงูุชูุตููู</div><div style="overflow-x:auto"><table style="width:100%;border-collapse:separate;border-spacing:0 5px"><thead><tr>${['ุงูููุธู','ุงููุณู','ุงููุฑุชุจุฉ','ุงูููุงุท','ุงูููู','ุงูุงูุชุฒุงู','ุงููุนุฏู','ุงูุชุญุณู','ูุชุชุงููุฉ','ุงูุชูููู'].map(h=>`<th style="text-align:right;padding:9px 12px;font-size:11px;color:${C.dim};font-weight:500;border-bottom:1px solid ${C.gb}">${h}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table></div></div>
  
  <div class="card fi"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><div style="font-family:'Readex Pro';font-size:17px;font-weight:600">๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู</div><div style="display:flex;gap:8px"><button class="btn" style="width:auto;padding:8px 18px;font-size:13px" onclick="showAddEmp()">โ ุฅุถุงูุฉ ููุธู</button><button class="btn2" style="padding:8px 18px;font-size:13px;background:rgba(253,203,110,0.1);color:${C.gld};border-color:rgba(253,203,110,0.2)" onclick="showImportPanel()">๐ฅ ุงุณุชูุฑุงุฏ ูู ููู</button></div></div>
    <div style="overflow-x:auto"><table style="width:100%;border-collapse:separate;border-spacing:0 4px"><thead><tr>${['ุงูุงุณู','ุงููุนุฑูู','ุงูุฅูููู','ุงููุณู','ุงูุฏูุฑ','ุงููุดุฑู',''].map(h=>`<th style="text-align:right;padding:8px 10px;font-size:11px;color:${C.dim};font-weight:500;border-bottom:1px solid ${C.gb}">${h}</th>`).join('')}</tr></thead><tbody>${empRows}</tbody></table></div>
  </div>

  <div class="card fi" id="importPanel" style="display:none;max-width:700px">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:10px">๐ฅ ุงุณุชูุฑุงุฏ ุงูููุธููู ูู ููู Excel</div>
    <p style="font-size:13px;color:${C.dim};margin-bottom:14px;line-height:1.8">ุงุฑูุน ููู ุงููุงูุจ ุจุนุฏ ุชุนุจุฆุชู. ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ: <b style="color:#fff">ุงูุงุณู ุจุงูุนุฑุจูุ ุงูุงุณู ุจุงูุฅูุฌููุฒูุ ุงููุนุฑููุ ุงูุฅููููุ ุงููุณูุ ุงูุฏูุฑ</b>. ุจุงูู ุงูุฃุนูุฏุฉ ุงุฎุชูุงุฑูุฉ.</p>
    <div style="padding:20px;background:rgba(253,203,110,0.04);border:2px dashed rgba(253,203,110,0.2);border-radius:14px;text-align:center;cursor:pointer;transition:all 0.3s" onclick="document.getElementById('impFile').click()" id="dropZone">
      <div style="font-size:36px;margin-bottom:8px">๐</div>
      <div style="font-size:14px;color:${C.gld}">ุงุถุบุท ููุง ูุงุฎุชูุงุฑ ุงูููู</div>
      <div style="font-size:12px;color:${C.dim};margin-top:4px">ูุฏุนู: .xlsx, .csv</div>
      <input type="file" id="impFile" accept=".xlsx,.csv" style="display:none" onchange="handleImportFile(this)">
    </div>
    <div id="impPreview" style="margin-top:14px;display:none"></div>
    <div id="impMsg" style="font-size:13px;margin-top:10px;display:none"></div>
    <div style="display:flex;gap:8px;margin-top:14px"><button class="btn" style="width:auto;padding:10px 24px;font-size:13px;display:none" id="impConfirm" onclick="confirmImport()">โ ุชุฃููุฏ ุงูุงุณุชูุฑุงุฏ</button><button class="btn2" onclick="$('importPanel').style.display='none'">ุฅูุบุงุก</button></div>
  </div>
  ${S.user.role==='gm'||S.user.role==='admin'?`<div class="card fi" style="max-width:600px">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:14px">๐ ูุชุญ ุนุฐุฑ / ุชูุฑูู ูุงุฆุช</div>
    <p style="font-size:13px;color:${C.dim};margin-bottom:14px;line-height:1.8">ุฅุฐุง ููุธู ุบุงุจ ุจุนุฐุฑ ุทุจู ุฃู ุธุฑู ุทุงุฑุฆ โ ูููู ุงูุฎุตู ูููุชุญ ูู ุชูุฑูู ุงูุฃูุณ.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงูููุธู</label>
        <select class="inp" id="excEmp">${emps.map(e=>`<option value="${e.email}">${e.name}</option>`).join('')}</select></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงูุณุจุจ</label>
        <select class="inp" id="excReason"><option value="medical">๐ฅ ุนุฐุฑ ุทุจู</option><option value="emergency">โ๏ธ ุธุฑู ุทุงุฑุฆ</option><option value="admin">๐ ุฅุฏุงุฑู</option></select></div>
    </div>
    <div style="margin-bottom:10px"><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label><input class="inp" id="excNote" placeholder="ุชูุงุตูู ุฅุถุงููุฉ..."></div>
    <div id="excMsg" style="font-size:12px;margin-top:8px;display:none"></div>
    <button class="btn" style="width:auto;padding:10px 24px;font-size:13px" onclick="grantExcuse()">โ ูุชุญ ุนุฐุฑ ูููู ุฃูุณ</button>
  </div>`:''}

  ${r==='admin'||r==='gm'?`<div class="card fi" style="max-width:600px">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:14px">๐ ุฅุนุงุฏุฉ ุชูุงุฑูู ุงูููู ูููุธู</div>
    <div style="margin-bottom:12px"><label style="font-size:12px;color:${C.dim};display:block;margin-bottom:5px">ุงุฎุชุฑ ุงูููุธู</label>
      <select class="inp" id="resetEmpSel">${emps.map(e=>`<option value="${e.email}">${e.name} (${e.uid})</option>`).join('')}</select></div>
    <div id="resetEmpMsg" style="font-size:12px;margin:8px 0;display:none"></div>
    <button class="btn" style="width:auto;padding:10px 24px;font-size:13px;background:linear-gradient(135deg,${C.ac2},#a29bfe)" onclick="resetEmpToday()">๐ ุฅุนุงุฏุฉ ุชูุงุฑูู ุงูููู</button>
  </div>`:''}

  <div class="card fi" id="addEmpForm" style="display:none;max-width:600px">
    <div style="font-family:'Readex Pro';font-size:17px;font-weight:600;margin-bottom:16px">โ ุฅุถุงูุฉ ููุธู ุฌุฏูุฏ</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงูุงุณู ุงููุงูู</label><input class="inp" id="nName" placeholder="ูุซุงู: ุนูู ุฃุญูุฏ"></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงููุนุฑูู (ูุตูุฑ)</label><input class="inp" id="nUid" placeholder="ูุซุงู: a.ahm" style="direction:ltr;text-align:left"></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงูุฅูููู</label><input class="inp" id="nEmail" placeholder="ali@fast.sa" style="direction:ltr;text-align:left"></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงููุณู</label><select class="inp" id="nDept">${DEPTS.map(d=>`<option value="${d.id}">${d.n}</option>`).join('')}</select></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงูุฏูุฑ</label><select class="inp" id="nRole"><option value="employee">ููุธู</option><option value="manager">ูุฏูุฑ/ูุดุฑู</option></select></div>
      <div><label style="font-size:11px;color:${C.dim};display:block;margin-bottom:4px">ุงููุดุฑู</label><select class="inp" id="nSup"><option value="">ุจุฏูู ูุดุฑู</option>${emps.filter(e=>e.role==='manager'||e.role==='admin').map(e=>`<option value="${e.uid}">${e.name}</option>`).join('')}</select></div>
    </div>
    <div id="addMsg" style="font-size:12px;margin-top:8px;display:none"></div>
    <div style="display:flex;gap:8px;margin-top:14px"><button class="btn" style="width:auto;padding:10px 24px;font-size:13px" onclick="addEmp()">โ ุฅุถุงูุฉ</button><button class="btn2" onclick="$('addEmpForm').style.display='none'">ุฅูุบุงุก</button></div>
  </div>`;
}

window.showAddEmp=function(){$('addEmpForm').style.display='block';$('addEmpForm').scrollIntoView({behavior:'smooth'});};

window.addEmp=async function(){
  const name=$('nName').value.trim();const uid=$('nUid').value.trim().toLowerCase();const email=$('nEmail').value.trim().toLowerCase();const dept=$('nDept').value;const role=$('nRole').value;const sup=$('nSup').value;
  const msg=$('addMsg');msg.style.display='block';
  if(!name||!uid||!email){msg.style.color=C.dng;msg.textContent='โ ุฌููุน ุงูุญููู ูุทููุจุฉ';return;}
  const emps=getEmpList();
  if(emps.find(e=>e.uid===uid)){msg.style.color=C.dng;msg.textContent='โ ุงููุนุฑูู ูุณุชุฎุฏู ูู ูุจู';return;}
  if(emps.find(e=>e.email===email)){msg.style.color=C.dng;msg.textContent='โ ุงูุฅูููู ูุณุชุฎุฏู ูู ูุจู';return;}
  emps.push({name,uid,email,dept,role,sup});await setEmps(emps);
  // Create user data in Firebase
  const ud=loadU(email);ud.pass='1234';saveU(ud);
  msg.style.color=C.ac;msg.textContent=`โ ุชู ุฅุถุงูุฉ ${name} (${uid}) โ ูููุฉ ุงููุฑูุฑ: 1234`;
  $('nName').value='';$('nUid').value='';$('nEmail').value='';
  setTimeout(()=>rAdmin(),1500);
};

window.delEmp=async function(idx){
  const emps=getEmpList();const emp=emps[idx];
  if(!confirm(`ุญุฐู ${emp.name}ุ`))return;
  // Delete from Firebase too
  await fbDel('users',emp.email.replace(/[.@]/g,'_'));
  emps.splice(idx,1);await setEmps(emps);rAdmin();
};

window.grantExcuse=function(){
  const email=$('excEmp').value;const reason=$('excReason').value;const note=$('excNote')?.value||'';
  const msg=$('excMsg');msg.style.display='block';
  const empData=gs('u_'+email);
  if(!empData){msg.style.color=C.dng;msg.textContent='โ ุจูุงูุงุช ุงูููุธู ุบูุฑ ููุฌูุฏุฉ';return;}
  
  const yesterday=new Date(Date.now()-864e5).toDateString();
  if(!empData.excusedDays)empData.excusedDays=[];
  
  // Check if already excused
  if(empData.excusedDays.some(e=>new Date(e.date).toDateString()===yesterday)){
    msg.style.color=C.gld;msg.textContent='โ๏ธ ูุฐุง ุงูููุธู ุนูุฏู ุนุฐุฑ ูููู ุฃูุณ ูุณุจูุงู';return;
  }
  
  empData.excusedDays.push({date:yesterday,reason,note,by:S.user.name,grantedAt:new Date().toISOString()});
  
  // Refund penalty points
  const penalty=calcMissedPenalty(empData);
  if(penalty<0)empData.points=Math.min(empData.points+Math.abs(penalty),empData.points+30); // refund up to 30
  
  ss('u_'+email,empData);
  
  // Log for transparency
  const logs=JSON.parse(localStorage.getItem('excuse_log')||'[]');
  const empInfo=getEmpList().find(e=>e.email===email);
  logs.push({email,empName:empInfo?.name||email,reason,note,by:S.user.name,date:new Date().toISOString()});
  localStorage.setItem('excuse_log',JSON.stringify(logs));
  
  msg.style.color=C.ac;msg.textContent=`โ ุชู ูุชุญ ุนุฐุฑ ูู ${empInfo?.name||email} ูููู ุฃูุณ โ ุงูุณุจุจ: ${reason==='medical'?'ุทุจู':reason==='emergency'?'ุทุงุฑุฆ':'ุฅุฏุงุฑู'}`;
  if($('excNote'))$('excNote').value='';
};

// ============ IMPORT FROM FILE ============
window.showImportPanel=function(){$('importPanel').style.display='block';$('importPanel').scrollIntoView({behavior:'smooth'});};
window.S_importData=null;

window.handleImportFile=function(input){
  const file=input.files[0];if(!file)return;
  const msg=$('impMsg');msg.style.display='block';msg.style.color=C.gld;msg.textContent='โณ ุฌุงุฑู ูุฑุงุกุฉ ุงูููู...';
  
  if(file.name.endsWith('.csv')){
    const reader=new FileReader();
    reader.onload=function(e){parseCSV(e.target.result);};
    reader.readAsText(file);
  }else if(file.name.endsWith('.xlsx')){
    const reader=new FileReader();
    reader.onload=function(e){parseXLSX(e.target.result);};
    reader.readAsArrayBuffer(file);
  }else{
    msg.style.color=C.dng;msg.textContent='โ ุตูุบุฉ ุบูุฑ ูุฏุนููุฉ โ ุงุณุชุฎุฏู .xlsx ุฃู .csv';
  }
};

function parseCSV(text){
  const lines=text.split('\n').map(l=>l.split(',').map(c=>c.trim().replace(/^"|"$/g,'')));
  processImportRows(lines);
}

function parseXLSX(buffer){
  // Simple XLSX parser โ XLSX is ZIP containing XML
  try{
    const zip=new Uint8Array(buffer);
    // Find shared strings and sheet1 XML inside the ZIP
    const files=unzipSimple(zip);
    const sharedStrings=parseSharedStrings(files['xl/sharedStrings.xml']||'');
    const sheetXml=files['xl/worksheets/sheet1.xml']||'';
    const rows=parseSheetXml(sheetXml,sharedStrings);
    processImportRows(rows);
  }catch(err){
    const msg=$('impMsg');msg.style.display='block';
    msg.style.color=C.dng;msg.textContent='โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: '+err.message+' โ ุฌุฑุจ ุญูุธู ูู CSV';
  }
}

// Minimal ZIP parser for XLSX
function unzipSimple(data){
  const files={};const view=new DataView(data.buffer);
  let pos=0;
  while(pos<data.length-4){
    if(view.getUint32(pos,true)!==0x04034b50)break;
    const nameLen=view.getUint16(pos+26,true);
    const extraLen=view.getUint16(pos+28,true);
    const compMethod=view.getUint16(pos+8,true);
    const compSize=view.getUint32(pos+18,true);
    const uncompSize=view.getUint32(pos+22,true);
    const name=new TextDecoder().decode(data.slice(pos+30,pos+30+nameLen));
    const dataStart=pos+30+nameLen+extraLen;
    const rawData=data.slice(dataStart,dataStart+compSize);
    
    if(compMethod===0){
      files[name]=new TextDecoder().decode(rawData);
    }else if(compMethod===8){
      try{
        const decompressed=new Uint8Array(uncompSize);
        const ds=new DecompressionStream('deflate-raw');
        const writer=ds.writable.getWriter();
        const reader=ds.readable.getReader();
        let result='';
        const chunks=[];
        // Use sync approach with blob
        const blob=new Blob([rawData]);
        const stream=blob.stream().pipeThrough(new DecompressionStream('deflate-raw'));
        // Store for async processing
        files['_pending_'+name]={stream,rawData,compMethod};
      }catch(e){}
    }
    pos=dataStart+compSize;
  }
  return files;
}

function parseSharedStrings(xml){
  if(!xml)return[];
  const strings=[];
  const regex=/<t[^>]*>([^<]*)<\/t>/g;
  let m;while((m=regex.exec(xml))!==null)strings.push(m[1]);
  return strings;
}

function parseSheetXml(xml,shared){
  if(!xml)return[];
  const rows=[];
  const rowRegex=/<row[^>]*>(.*?)<\/row>/gs;
  let rm;
  while((rm=rowRegex.exec(xml))!==null){
    const cells=[];
    const cellRegex=/<c\s+r="([A-Z]+)\d+"[^>]*(?:t="([^"]*)")?[^>]*>(?:<v>([^<]*)<\/v>)?/g;
    let cm;
    while((cm=cellRegex.exec(rm[1]))!==null){
      const col=cm[1];const type=cm[2];const val=cm[3]||'';
      const colIdx=col.split('').reduce((a,c)=>a*26+(c.charCodeAt(0)-64),0)-1;
      while(cells.length<=colIdx)cells.push('');
      cells[colIdx]=type==='s'?shared[parseInt(val)]||'':val;
    }
    rows.push(cells);
  }
  return rows;
}

function processImportRows(rows){
  const msg=$('impMsg');msg.style.display='block';
  
  // Find header row (skip instruction rows)
  let headerIdx=-1;
  const hdrKeys=['ุงููุนุฑูู','uid','ุงูุฅูููู','ุงูุจุฑูุฏ','email'];
  for(let i=0;i<Math.min(rows.length,5);i++){
    if(rows[i].some(c=>hdrKeys.some(k=>c&&c.toString().includes(k)))){headerIdx=i;break;}
  }
  if(headerIdx===-1){msg.style.color=C.dng;msg.textContent='โ ูุง ูููุช ุตู ุงูุนูุงููู โ ุชุฃูุฏ ุงูููู ูุญุชูู ุฃุนูุฏุฉ: ุงูุงุณูุ ุงููุนุฑููุ ุงูุฅูููู';return;}
  
  const headers=rows[headerIdx].map(h=>(h||'').toString().trim().toLowerCase());
  
  // Map columns
  const colMap={};
  const mappings=[
    {key:'nameAr',match:['ุงูุงุณู ุจุงูุนุฑุจู','ุงูุงุณู','name_ar']},
    {key:'nameEn',match:['ุงูุงุณู ุจุงูุฅูุฌููุฒู','ุงูุงุณู ุจุงูุงูุฌููุฒู','english','name_en']},
    {key:'uid',match:['ุงููุนุฑูู','ุงููุนุฑู','uid']},
    {key:'email',match:['ุงูุจุฑูุฏ','ุงูุฅูููู','ุงูุงูููู','email']},
    {key:'phone',match:['ุงูุฌูุงู','ุงููุงุชู','phone','ุฌูุงู']},
    {key:'age',match:['ุงูุนูุฑ','age']},
    {key:'gender',match:['ุงูุฌูุณ','gender']},
    {key:'country',match:['ุงูุจูุฏ','country','ุงูุฌูุณูุฉ']},
    {key:'dept',match:['ุงููุณู','dept','department']},
    {key:'role',match:['ุงูุฏูุฑ','role']},
    {key:'sup',match:['ุงููุดุฑู','supervisor','sup']},
  ];
  
  mappings.forEach(m=>{
    const idx=headers.findIndex(h=>m.match.some(k=>h.includes(k)));
    if(idx>=0)colMap[m.key]=idx;
  });
  
  // Validate required columns
  const required=['nameAr','uid','email','dept','role'];
  const missing=required.filter(k=>colMap[k]===undefined);
  if(missing.length){
    msg.style.color=C.dng;msg.textContent=`โ ุฃุนูุฏุฉ ูุงูุตุฉ: ${missing.join(', ')} โ ุชุฃูุฏ ูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ`;return;
  }
  
  // Parse data rows
  const dataRows=rows.slice(headerIdx+1).filter(r=>r.length>1&&r[colMap.uid]&&r[colMap.email]);
  // Skip guide/example row
  const empData=dataRows.filter(r=>{
    const uid=(r[colMap.uid]||'').toString().trim();
    return uid&&!uid.includes('ูุซู')&&!uid.includes('ุญุฑูู')&&uid.length>0;
  }).map(r=>{
    const get=(k)=>(r[colMap[k]]||'').toString().trim();
    return{
      nameAr:get('nameAr'),
      nameEn:get('nameEn'),
      uid:get('uid').toLowerCase(),
      email:get('email').toLowerCase(),
      phone:get('phone'),
      age:get('age'),
      gender:get('gender'),
      country:get('country'),
      dept:get('dept'),
      role:get('role'),
      sup:get('sup'),
    };
  });
  
  if(empData.length===0){msg.style.color=C.dng;msg.textContent='โ ูุง ูููุช ุจูุงูุงุช ููุธููู โ ุชุฃูุฏ ุงูููู ูู ูุงุถู';return;}
  
  S_importData=empData;
  
  // Show preview
  msg.style.color=C.ac;msg.textContent=`โ ุชู ูุฑุงุกุฉ ${empData.length} ููุธู โ ุฑุงุฌุน ุงูุจูุงูุงุช ุซู ุงุถุบุท ุชุฃููุฏ`;
  $('impConfirm').style.display='block';
  
  let prevRows=empData.map((e,i)=>`<tr>${[i+1,e.nameAr,e.nameEn||'โ',e.uid,e.email,e.dept,e.role,e.gender||'โ',e.country||'โ'].map(v=>`<td style="padding:6px 8px;font-size:11px;background:rgba(255,255,255,0.015);border-bottom:1px solid ${C.gb}">${v}</td>`).join('')}</tr>`).join('');
  
  $('impPreview').style.display='block';
  $('impPreview').innerHTML=`<div style="font-size:13px;color:${C.ac};font-weight:600;margin-bottom:8px">๐ ูุนุงููุฉ (${empData.length} ููุธู):</div>
    <div style="overflow-x:auto;max-height:300px;overflow-y:auto"><table style="width:100%;border-collapse:collapse"><thead><tr>${['#','ุงูุงุณู','English','uid','ุงูุฅูููู','ุงููุณู','ุงูุฏูุฑ','ุงูุฌูุณ','ุงูุจูุฏ'].map(h=>`<th style="text-align:right;padding:6px 8px;font-size:10px;color:${C.dim};border-bottom:1px solid ${C.gb}">${h}</th>`).join('')}</tr></thead><tbody>${prevRows}</tbody></table></div>`;
}

window.confirmImport=async function(){
  if(!S_importData||!S_importData.length)return;
  const msg=$('impMsg');msg.style.display='block';
  
  const emps=getEmpList();
  let added=0,updated=0,skipped=0;
  
  S_importData.forEach(e=>{
    const existing=emps.findIndex(x=>x.email===e.email||x.uid===e.uid);
    
    if(existing>=0){
      // Update existing employee with new data
      const emp=emps[existing];
      if(e.nameAr)emp.name=e.nameAr;
      if(e.nameEn)emp.nameEn=e.nameEn;
      if(e.phone)emp.phone=e.phone;
      if(e.age)emp.age=e.age;
      if(e.gender)emp.gender=e.gender;
      if(e.country)emp.country=e.country;
      if(e.dept)emp.dept=e.dept;
      if(e.role)emp.role=e.role;
      if(e.sup)emp.sup=e.sup;
      updated++;
    }else{
      // Add new employee
      emps.push({
        name:e.nameAr,nameEn:e.nameEn,uid:e.uid,email:e.email,
        phone:e.phone,age:e.age,gender:e.gender,country:e.country,
        dept:e.dept,role:e.role,sup:e.sup
      });
      // Create user data with default password
      const ud=loadU(e.email);
      ud.pass='1234';
      saveU(ud);
      added++;
    }
  });
  
  await setEmps(emps);
  
  msg.style.color=C.ac;
  msg.innerHTML=`โ ุชู ุงูุงุณุชูุฑุงุฏ!<br>โ ุฌุฏุฏ: <b>${added}</b> | ๐ ูุญุฏูุซูู: <b>${updated}</b>${skipped?` | โญ๏ธ ุชุฎุทู: <b>${skipped}</b>`:''}`;
  $('impConfirm').style.display='none';
  S_importData=null;
  
  setTimeout(()=>rAdmin(),2000);
};

// ============ START ============
(async function(){
  // Show loading
  R().innerHTML='<div style="display:flex;min-height:100vh;align-items:center;justify-content:center"><div style="text-align:center"><div style="font-size:40px;margin-bottom:12px">๐ง</div><div style="font-family:Readex Pro;font-size:18px;font-weight:700;margin-bottom:8px">ููุตุฉ ุงูุชุฏุฑูุจ ุงูุฐููู</div><div style="color:#6B7A90;font-size:13px">ุฌุงุฑู ุงูุชุญููู...</div></div></div>';
  // Load employee list from Firebase
  try{await getEmpsAsync();}catch(e){console.warn('Init emps:',e);}
  showLogin();
})();
</script>
</body>
</html>
